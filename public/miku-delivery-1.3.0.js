var mikuDelivery=function(A){"use strict";var Co=Object.defineProperty,xo=Object.defineProperties;var Eo=Object.getOwnPropertyDescriptors;var qe=Object.getOwnPropertySymbols;var Vn=Object.prototype.hasOwnProperty,Gn=Object.prototype.propertyIsEnumerable;var It=(A,I,P)=>I in A?Co(A,I,{enumerable:!0,configurable:!0,writable:!0,value:P}):A[I]=P,x=(A,I)=>{for(var P in I||(I={}))Vn.call(I,P)&&It(A,P,I[P]);if(qe)for(var P of qe(I))Gn.call(I,P)&&It(A,P,I[P]);return A},W=(A,I)=>xo(A,Eo(I));var Ot=(A,I)=>{var P={};for(var $ in A)Vn.call(A,$)&&I.indexOf($)<0&&(P[$]=A[$]);if(A!=null&&qe)for(var $ of qe(A))I.indexOf($)<0&&Gn.call(A,$)&&(P[$]=A[$]);return P};var R=(A,I,P)=>(It(A,typeof I!="symbol"?I+"":I,P),P);var v=(A,I,P)=>new Promise(($,le)=>{var We=J=>{try{me(P.next(J))}catch(ge){le(ge)}},Fe=J=>{try{me(P.throw(J))}catch(ge){le(ge)}},me=J=>J.done?$(J.value):Promise.resolve(J.value).then(We,Fe);me((P=P.apply(A,I)).next())});function I(r){const e=[],t=r.length;for(let n=0;n<t;n++){let s=r.charCodeAt(n);if(s>=55296&&s<=56319&&t>n+1){const o=r.charCodeAt(n+1);o>=56320&&o<=57343&&(s=(s-55296)*1024+o-56320+65536,n+=1)}if(s<128){e.push(s);continue}if(s<2048){e.push(s>>6|192),e.push(s&63|128);continue}if(s<55296||s>=57344&&s<65536){e.push(s>>12|224),e.push(s>>6&63|128),e.push(s&63|128);continue}if(s>=65536&&s<=1114111){e.push(s>>18|240),e.push(s>>12&63|128),e.push(s>>6&63|128),e.push(s&63|128);continue}e.push(239,191,189)}return new Uint8Array(e).buffer}function P(r){return r^=r>>>16,r=Math.imul(r,2246822507),r^=r>>>13,r=Math.imul(r,3266489909),r^=r>>>16,r>>>0}const $=new Uint32Array([3432918353,461845907]);function le(r,e){return r<<e|r>>>32-e}function We(r,e){const t=r.byteLength/4|0,n=new Uint32Array(r,0,t);for(let s=0;s<t;s++)n[s]=Math.imul(n[s],$[0]),n[s]=le(n[s],15),n[s]=Math.imul(n[s],$[1]),e[0]=e[0]^n[s],e[0]=le(e[0],13),e[0]=Math.imul(e[0],5)+3864292196}function Fe(r,e){const t=r.byteLength/4|0,n=r.byteLength%4;let s=0;const o=new Uint8Array(r,t*4,n);switch(n){case 3:s=s^o[2]<<16;case 2:s=s^o[1]<<8;case 1:s=s^o[0]<<0,s=Math.imul(s,$[0]),s=le(s,15),s=Math.imul(s,$[1]),e[0]=e[0]^s}}function me(r,e){e[0]=e[0]^r.byteLength,e[0]=P(e[0])}function J(r,e){if(e=e?e|0:0,typeof r=="string"&&(r=I(r)),!(r instanceof ArrayBuffer))throw new TypeError("Expected key to be ArrayBuffer or string");const t=new Uint32Array([e]);return We(r,t),Fe(r,t),me(r,t),t.buffer}class ge{constructor(e=Qn){R(this,"circle",new Map);R(this,"members",new Set);R(this,"membersReplicas",new Map);R(this,"sortedHashes",[]);this.hasher=e}updateSortedHashes(){this.sortedHashes=[...this.circle.keys()].sort((e,t)=>e-t)}_add({key:e,replicas:t}){for(let n=0;n<t;n++){const s=this.hasher(Nt(e,n));this.circle.set(s,e)}this.members.add(e),this.membersReplicas.set(e,t)}_remove({key:e,replicas:t}){for(let n=0;n<t;n++){const s=this.hasher(Nt(e,n));this.circle.delete(s)}this.members.delete(e),this.membersReplicas.delete(e)}search(e){const t=this.sortedHashes.findIndex(n=>n>e);return t<0?0:t}get(e){if(this.members.size===0)return null;const t=this.hasher(e),n=this.search(t),s=this.sortedHashes[n];return this.circle.get(s)}getN(e,t,n){const s=n?n.size:this.members.size;if(s===0||t===0)return[];t>s&&(t=s);const o=this.hasher(e),i=this.search(o),a=[];for(let u=i;;u++){u>=this.sortedHashes.length&&(u=0);const c=this.sortedHashes[u],h=this.circle.get(c);if(!a.includes(h)&&(!n||n.has(h))&&(a.push(h),a.length>=t))return a}}add(e,t){return this.members.has(e)?!1:(this._add({key:e,replicas:t}),this.updateSortedHashes(),!0)}remove(e){if(!this.members.has(e))return!1;const t=this.membersReplicas.get(e);return this._remove({key:e,replicas:t}),this.updateSortedHashes(),!0}set(e){this.circle.clear(),this.members.clear(),this.membersReplicas.clear(),e.forEach(t=>{this._add(t)}),this.updateSortedHashes()}}function Nt(r,e){return e+r}const Qn=Xn;function Xn(r){const e=J(r);return new Uint32Array(e)[0]}class V{constructor(e){R(this,"value");this.value=e!=null?x({},e.value):{}}set(e,t){this.value[e]=t}get(e){return this.value[e]}}let zt=!1;function X(r){return(...e)=>{zt&&console.debug(`[${r}] [${(Date.now()/1e3).toFixed(3)}]`,...e)}}function je(){zt=!0}function te(r){return(...e)=>{console.warn(`[${r}] [${(Date.now()/1e3).toFixed(3)}]`,...e)}}const Ke="https://api.qiniudns.com/v1/resolve",Yn="https://api.qiniudns.com",Ve="https://pili-zeus.qiniuapi.com/v1/scheduling";function Zn(r){r[0]==="?"&&(r=r.slice(1));const e={};return r.split("&").forEach(t=>{const[n,s]=t.split("=");e[decodeURIComponent(n)]=s==null?null:decodeURIComponent(s)}),e}function Ge(r){return Object.keys(r).map(e=>[e,r[e]]).filter(([e,t])=>t!==void 0).map(([e,t])=>t===null?encodeURIComponent(e):[e,t].map(encodeURIComponent).join("=")).join("&")}function Ut(r,e){const t=new URLSearchParams(e).toString(),n=r.includes("?")?"&":"?";return r+n+t}function Te(){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",e=r.length;let t="";for(let n=0;n<20;n++)t+=r[Math.floor(Math.random()*e)];return t}function Jn(r,e){const t={};return Object.keys(r).forEach(n=>{t[n]=e(r[n])}),t}function er(){const r={resolve:void 0,reject:void 0,promise:void 0,status:"pending",value:null};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r.promise.then(e=>{r.value=e,r.status="resolved"},()=>{r.status="rejected"}),r}function tr(r){return new Promise(e=>setTimeout(e,r))}class Ht extends Error{constructor(){super(...arguments);R(this,"name","TimeoutError")}}function Ae(r,e){return new Promise((t,n)=>{setTimeout(()=>n(new Ht(e+" timeout")),r)})}function nr(r,e){e.aborted?r.abort(e.reason):e.addEventListener("abort",()=>{r.abort(e.reason)})}const Qe={image:[/\.(jpe?g|png|gif|webp|svg|bmp|ico|tiff|avif|svga)$/],media:[/\.(3gp|aac|flac|mpe?g|mp3|mp4|m4a|m4v|m4p|oga|ogg|ogv|wav|webm|mov)$/],live:[/\.(flv|m3u8|ts|m4s)$/],other:[]};function $t(r,e,t=["image","media","other"]){r.search="",r.hash="";const n=r.toString();return t.some(s=>{var o;return((o=e[s])!=null?o:[]).some(i=>i.test(n))})}function De(r){const e=new URL(r);return e.search="",e.hash="",e.toString()}function ne(r){return r instanceof Error?{err_msg:r.name,err_desc:r.message}:{err_msg:"Unknown",err_desc:r+""}}function O(r,e){return r==null||r===-1||e==null||e===-1?-1:(r-e)/1e3}function rr(r,e=80){const[t,n]=r.split(":"),s=n?parseInt(n,10):e;return[t,s]}function qt(r){const e=r.split("/"),t=e[e.length-1],n=t.lastIndexOf(".");return n>=0?t.slice(n+1):""}function sr(r,e){return new URL(r,e).toString()}function ke(r){const[e]=r.split("?");return e.endsWith(".m3u8")}function Wt(r){const[e]=r.split("?");return e.endsWith(".flv")}var ee=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function or(r){var e=r.default;if(typeof e=="function"){var t=function(){return e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var s=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:function(){return r[n]}})}),t}var Ft={exports:{}};function ir(r){throw new Error('Could not dynamically require "'+r+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Xe={exports:{}};const ar=or(Object.freeze(Object.defineProperty({__proto__:null,default:{}},Symbol.toStringTag,{value:"Module"})));var jt;function Le(){return jt||(jt=1,function(r,e){(function(t,n){r.exports=n()})(ee,function(){var t=t||function(n,s){var o;if(typeof window!="undefined"&&window.crypto&&(o=window.crypto),typeof self!="undefined"&&self.crypto&&(o=self.crypto),typeof globalThis!="undefined"&&globalThis.crypto&&(o=globalThis.crypto),!o&&typeof window!="undefined"&&window.msCrypto&&(o=window.msCrypto),!o&&typeof ee!="undefined"&&ee.crypto&&(o=ee.crypto),!o&&typeof ir=="function")try{o=ar}catch(g){}var i=function(){if(o){if(typeof o.getRandomValues=="function")try{return o.getRandomValues(new Uint32Array(1))[0]}catch(g){}if(typeof o.randomBytes=="function")try{return o.randomBytes(4).readInt32LE()}catch(g){}}throw new Error("Native crypto module could not be used to get secure random number.")},a=Object.create||function(){function g(){}return function(b){var y;return g.prototype=b,y=new g,g.prototype=null,y}}(),u={},c=u.lib={},h=c.Base=function(){return{extend:function(g){var b=a(this);return g&&b.mixIn(g),(!b.hasOwnProperty("init")||this.init===b.init)&&(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var g=this.extend();return g.init.apply(g,arguments),g},init:function(){},mixIn:function(g){for(var b in g)g.hasOwnProperty(b)&&(this[b]=g[b]);g.hasOwnProperty("toString")&&(this.toString=g.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),p=c.WordArray=h.extend({init:function(g,b){g=this.words=g||[],b!=s?this.sigBytes=b:this.sigBytes=g.length*4},toString:function(g){return(g||f).stringify(this)},concat:function(g){var b=this.words,y=g.words,S=this.sigBytes,D=g.sigBytes;if(this.clamp(),S%4)for(var B=0;B<D;B++){var Y=y[B>>>2]>>>24-B%4*8&255;b[S+B>>>2]|=Y<<24-(S+B)%4*8}else for(var H=0;H<D;H+=4)b[S+H>>>2]=y[H>>>2];return this.sigBytes+=D,this},clamp:function(){var g=this.words,b=this.sigBytes;g[b>>>2]&=4294967295<<32-b%4*8,g.length=n.ceil(b/4)},clone:function(){var g=h.clone.call(this);return g.words=this.words.slice(0),g},random:function(g){for(var b=[],y=0;y<g;y+=4)b.push(i());return new p.init(b,g)}}),l=u.enc={},f=l.Hex={stringify:function(g){for(var b=g.words,y=g.sigBytes,S=[],D=0;D<y;D++){var B=b[D>>>2]>>>24-D%4*8&255;S.push((B>>>4).toString(16)),S.push((B&15).toString(16))}return S.join("")},parse:function(g){for(var b=g.length,y=[],S=0;S<b;S+=2)y[S>>>3]|=parseInt(g.substr(S,2),16)<<24-S%8*4;return new p.init(y,b/2)}},d=l.Latin1={stringify:function(g){for(var b=g.words,y=g.sigBytes,S=[],D=0;D<y;D++){var B=b[D>>>2]>>>24-D%4*8&255;S.push(String.fromCharCode(B))}return S.join("")},parse:function(g){for(var b=g.length,y=[],S=0;S<b;S++)y[S>>>2]|=(g.charCodeAt(S)&255)<<24-S%4*8;return new p.init(y,b)}},w=l.Utf8={stringify:function(g){try{return decodeURIComponent(escape(d.stringify(g)))}catch(b){throw new Error("Malformed UTF-8 data")}},parse:function(g){return d.parse(unescape(encodeURIComponent(g)))}},m=c.BufferedBlockAlgorithm=h.extend({reset:function(){this._data=new p.init,this._nDataBytes=0},_append:function(g){typeof g=="string"&&(g=w.parse(g)),this._data.concat(g),this._nDataBytes+=g.sigBytes},_process:function(g){var b,y=this._data,S=y.words,D=y.sigBytes,B=this.blockSize,Y=B*4,H=D/Y;g?H=n.ceil(H):H=n.max((H|0)-this._minBufferSize,0);var K=H*B,G=n.min(K*4,D);if(K){for(var z=0;z<K;z+=B)this._doProcessBlock(S,z);b=S.splice(0,K),y.sigBytes-=G}return new p.init(b,G)},clone:function(){var g=h.clone.call(this);return g._data=this._data.clone(),g},_minBufferSize:0});c.Hasher=m.extend({cfg:h.extend(),init:function(g){this.cfg=this.cfg.extend(g),this.reset()},reset:function(){m.reset.call(this),this._doReset()},update:function(g){return this._append(g),this._process(),this},finalize:function(g){g&&this._append(g);var b=this._doFinalize();return b},blockSize:16,_createHelper:function(g){return function(b,y){return new g.init(y).finalize(b)}},_createHmacHelper:function(g){return function(b,y){return new C.HMAC.init(g,y).finalize(b)}}});var C=u.algo={};return u}(Math);return t})}(Xe)),Xe.exports}var Ye={exports:{}},Kt;function lr(){return Kt||(Kt=1,function(r,e){(function(t,n){r.exports=n(Le())})(ee,function(t){return function(){var n=t,s=n.lib,o=s.WordArray,i=s.Hasher,a=n.algo,u=[],c=a.SHA1=i.extend({_doReset:function(){this._hash=new o.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(h,p){for(var l=this._hash.words,f=l[0],d=l[1],w=l[2],m=l[3],C=l[4],g=0;g<80;g++){if(g<16)u[g]=h[p+g]|0;else{var b=u[g-3]^u[g-8]^u[g-14]^u[g-16];u[g]=b<<1|b>>>31}var y=(f<<5|f>>>27)+C+u[g];g<20?y+=(d&w|~d&m)+1518500249:g<40?y+=(d^w^m)+1859775393:g<60?y+=(d&w|d&m|w&m)-1894007588:y+=(d^w^m)-899497514,C=m,m=w,w=d<<30|d>>>2,d=f,f=y}l[0]=l[0]+f|0,l[1]=l[1]+d|0,l[2]=l[2]+w|0,l[3]=l[3]+m|0,l[4]=l[4]+C|0},_doFinalize:function(){var h=this._data,p=h.words,l=this._nDataBytes*8,f=h.sigBytes*8;return p[f>>>5]|=128<<24-f%32,p[(f+64>>>9<<4)+14]=Math.floor(l/4294967296),p[(f+64>>>9<<4)+15]=l,h.sigBytes=p.length*4,this._process(),this._hash},clone:function(){var h=i.clone.call(this);return h._hash=this._hash.clone(),h}});n.SHA1=i._createHelper(c),n.HmacSHA1=i._createHmacHelper(c)}(),t.SHA1})}(Ye)),Ye.exports}var Ze={exports:{}},Vt;function cr(){return Vt||(Vt=1,function(r,e){(function(t,n){r.exports=n(Le())})(ee,function(t){(function(){var n=t,s=n.lib,o=s.Base,i=n.enc,a=i.Utf8,u=n.algo;u.HMAC=o.extend({init:function(c,h){c=this._hasher=new c.init,typeof h=="string"&&(h=a.parse(h));var p=c.blockSize,l=p*4;h.sigBytes>l&&(h=c.finalize(h)),h.clamp();for(var f=this._oKey=h.clone(),d=this._iKey=h.clone(),w=f.words,m=d.words,C=0;C<p;C++)w[C]^=1549556828,m[C]^=909522486;f.sigBytes=d.sigBytes=l,this.reset()},reset:function(){var c=this._hasher;c.reset(),c.update(this._iKey)},update:function(c){return this._hasher.update(c),this},finalize:function(c){var h=this._hasher,p=h.finalize(c);h.reset();var l=h.finalize(this._oKey.clone().concat(p));return l}})})()})}(Ze)),Ze.exports}(function(r,e){(function(t,n,s){r.exports=n(Le(),lr(),cr())})(ee,function(t){return t.HmacSHA1})})(Ft);const ur=Ft.exports;var Gt={exports:{}};(function(r,e){(function(t,n){r.exports=n(Le())})(ee,function(t){return function(){var n=t,s=n.lib,o=s.WordArray,i=n.enc;i.Base64={stringify:function(u){var c=u.words,h=u.sigBytes,p=this._map;u.clamp();for(var l=[],f=0;f<h;f+=3)for(var d=c[f>>>2]>>>24-f%4*8&255,w=c[f+1>>>2]>>>24-(f+1)%4*8&255,m=c[f+2>>>2]>>>24-(f+2)%4*8&255,C=d<<16|w<<8|m,g=0;g<4&&f+g*.75<h;g++)l.push(p.charAt(C>>>6*(3-g)&63));var b=p.charAt(64);if(b)for(;l.length%4;)l.push(b);return l.join("")},parse:function(u){var c=u.length,h=this._map,p=this._reverseMap;if(!p){p=this._reverseMap=[];for(var l=0;l<h.length;l++)p[h.charCodeAt(l)]=l}var f=h.charAt(64);if(f){var d=u.indexOf(f);d!==-1&&(c=d)}return a(u,c,p)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="};function a(u,c,h){for(var p=[],l=0,f=0;f<c;f++)if(f%4){var d=h[u.charCodeAt(f-1)]<<f%4*2,w=h[u.charCodeAt(f)]>>>6-f%4*2,m=d|w;p[l>>>2]|=m<<24-l%4*8,l++}return o.create(p,l)}}(),t.enc.Base64})})(Gt);const hr=Gt.exports;function dr(r){let e=r.query?`${r.path}?${r.query}
`:`${r.path}
`;return r.body&&(e+=r.body),e}function Je(r){let e;try{e=new URL(r.path).pathname}catch(a){e=r.path}let t=dr(W(x({},r),{path:e}));const o=ur(t,r.appSalt).toString(hr).replace(/\+/g,"-").replace(/\//g,"_");let i=`QApp ${r.appID}:${o}`;return i=i.replace(/\//g,"_"),i=i.replace(/\+/g,"-"),i}class fr{constructor(e){this.logger=e}log(e){return this.logger.log("DnsResolveLog",e)}}function wr(r){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",t=e.length;let n="";for(let s=0;s<r;s++)n+=e[Math.floor(Math.random()*t)];return n}const pr=new URL(Ke).hostname,mr=te("dns/httpdns");function gr(r,e,t,n){return v(this,null,function*(){var p,l;const s=new fr(n),o=Ge({name:e,type:"A",rid:wr(10)}),i=`${Ke}?${o}`,a=Je(W(x({},t),{path:Ke,query:o}));let u,c=null,h=null;try{if(c=yield fetch(i,{headers:{Authorization:a}}),!c.ok){const d=yield yr(c);if(d==null)throw new Error(`Resolve failed, unexpected HTTP status: ${c.status}`);if(d.code==="NotSupportedArea")return{reason:"NotSupportedArea",ttl:300};throw new Error(`Resolve failed, code: ${d.code}, error: ${d.error}`)}return h=yield c.json()}catch(f){throw u=f}finally{const d=performance.getEntriesByName(i,"resource").pop();if(d==null)mr("Corresponding performance entry not found for",i);else{const w=h==null?ne(u):{err_msg:"",err_desc:""};s.log(W(x({r_id:(p=c==null?void 0:c.headers.get("x-reqid"))!=null?p:"",ip:"",domain:pr,status_code:(l=c==null?void 0:c.status)!=null?l:-1},w),{t_conn:(d.requestStart-d.connectStart)/1e3,t_total:(d.responseEnd-d.fetchStart)/1e3,type:1}))}}})}function et(r){return r.groups!=null}function vr(r,e){return r.find(t=>new RegExp(t.pattern).test(e))}function br(r){return Math.random()<r.servicerate}function yr(r){return v(this,null,function*(){try{const e=yield r.json();if(e&&typeof e.code=="string"&&typeof e.error=="string")return e}catch(e){}return null})}function Qt(r){return v(this,null,function*(){yield Promise.all(r.map(e=>indexedDB.deleteDatabase(e)))})}class Xt{constructor(e,t){R(this,"db");this.dbName=e,this.storeConfigs=t}getDB(){return v(this,null,function*(){return this.db!=null?this.db:(this.db=yield new Promise(e=>{const t=indexedDB.open(this.dbName);t.addEventListener("upgradeneeded",()=>{for(const n of this.storeConfigs){const s=t.result.createObjectStore(n.name);for(const o of n.indexes)s.createIndex(o.name,o.keyPath)}}),e(Me(t))}),this.db)})}get(e,t){return v(this,null,function*(){const s=(yield this.getDB()).transaction(e,"readonly").objectStore(e).get(t);return Me(s)})}getAll(e){return v(this,null,function*(){const n=(yield this.getDB()).transaction(e,"readonly").objectStore(e).getAll();return Me(n)})}count(e){return v(this,null,function*(){const n=(yield this.getDB()).transaction(e,"readonly").objectStore(e).count();return Me(n)})}set(e,t,n){return v(this,null,function*(){const o=(yield this.getDB()).transaction(e,"readwrite");return o.objectStore(e).put(n,t),tt(o)})}remove(e,t){return v(this,null,function*(){const s=(yield this.getDB()).transaction(e,"readwrite");return s.objectStore(e).delete(t),tt(s)})}clear(){return v(this,null,function*(){const e=yield this.getDB();yield Promise.all(this.storeConfigs.map(({name:t})=>{const n=e.transaction(t,"readwrite");return n.objectStore(t).clear(),tt(n)}))})}walkBy(e,t,n){return v(this,null,function*(){const o=(yield this.getDB()).transaction(e,"readonly").objectStore(e).index(t).openCursor(void 0,"next");return new Promise((i,a)=>{o.addEventListener("error",()=>a(new ve(o.error))),o.addEventListener("success",()=>{const u=o.result;if(u==null){i();return}n(u.value,u.primaryKey),u.continue()})})})}dispose(){var e;(e=this.db)==null||e.close()}}class ve extends Error{constructor(t){super(t+"");R(this,"name","IndexedDBError");this.cause=t}}function Me(r){return new Promise((e,t)=>{r.addEventListener("success",()=>e(r.result)),r.addEventListener("error",()=>t(new ve(r.error)))})}function tt(r){return new Promise((e,t)=>{r.addEventListener("complete",()=>e()),r.addEventListener("error",()=>t(new ve(r.error))),r.addEventListener("abort",()=>t(new ve(r.error)))})}class Rr{constructor(){R(this,"map",new Map)}on(e,t){var o;const s=[...(o=this.map.get(e))!=null?o:[],t];return this.map.set(e,s),()=>this.off(e,t)}once(e,t){const n=this.on(e,s=>{n(),t(s)});return n}off(e,t){var o;const s=((o=this.map.get(e))!=null?o:[]).filter(i=>i!==t);this.map.set(e,s)}emit(...e){var o;const[t,n]=e;((o=this.map.get(t))!=null?o:[]).forEach(i=>{i(n)})}dispose(){this.map.clear()}}function ce(r){const e=r.get("Content-Length");return e?parseInt(e,10):null}function nt(r){const e=r.get("Content-Range");return e==null?null:Sr(e)}function Sr(r){const e=r.trim().toLowerCase(),[t,n]=e.split(/\s+/);if(t!=="bytes")throw new Error(`Unit must be bytes: ${r}`);const[s,o]=n.split("/"),i=o==="*"?null:st(o),[a,u]=(s.includes("-")?s.split("-"):[null,null]).map(c=>st(c));return{totalSize:i,start:a,end:u}}function rt(r){const e=r.start!=null&&r.end!=null?`${r.start}-${r.end}`:"*",t=r.totalSize==null?"*":r.totalSize+"";return`bytes ${e}/${t}`}function st(r){return r?Number(r):null}function ot(r){const e=r.get("Range");return e==null?null:Zt(e)}function Yt(r){return r.start===0&&r.end==null}function Zt(r){const e=r.trim().toLowerCase();if(!e.startsWith("bytes="))throw new Error(`Unit must be bytes: ${r}`);if(e.includes(","))throw new Error(`Multiple range: ${r}`);const[,t,n]=/(\d*)-(\d*)/.exec(e)||[];if(!t&&!n)throw new Error(`Invalid range values: ${r}`);if(!t)throw new Error("Suffix range not supported");const[s,o]=[t,n].map(i=>st(i));return{start:s,end:o}}function be(r){var e,t;return`bytes=${(e=r.start)!=null?e:0}-${(t=r.end)!=null?t:""}`}const Cr=/[^\u0000-\u00ff]/;function Jt(r){return Cr.test(r)?"REPLACED_BY_Miku_Delivery_SEE_utils_http_encodeHeaderValue":r}function xr(r){if(r instanceof Headers){const e={};r.forEach((t,n)=>{e[n]=Jt(t)}),r=e}if(Array.isArray(r)){const e={};r.forEach(([t,n])=>{e[n]=Jt(t)}),r=e}return new Headers(r)}function it(r){var t;const e=nt(r);return e!=null?(t=e.totalSize)!=null?t:null:ce(r)}const en=X("utils/stream"),tn=te("utils/stream");function Er(r){return v(this,null,function*(){const e=r.getReader();let t=new Uint8Array;for(;;){const{done:s,value:o}=yield e.read();if(s)break;t=new Uint8Array([...t,...o])}return new TextDecoder().decode(t)})}function at(r,e){var a;const t=r.getReader(),n=(a=e[0])!=null?a:0,s=e[1];let o=0;return new ReadableStream({pull:u=>v(this,null,function*(){let c,h;for(;;){const d=yield t.read();if(d.done){u.close();return}if(c=d.value,h=o+c.byteLength,h>n)break;o=h}let p=c;const l=n>o?n-o:0,f=s!=null&&s<h?s-o:void 0;(l!==0||f!==void 0)&&(p=c.slice(l,f)),u.enqueue(p),s!=null&&h>=s&&(t.cancel("Cancelled by slice for target range met"),u.close()),o=h}),cancel:u=>t.cancel(u)})}function _r(r){let e=0;const t=new TransformStream({transform:(s,o)=>{e+=s.byteLength,o.enqueue(s)}}),n=r.pipeTo(t.writable).then(()=>({size:e,success:!0}),s=>({size:e,success:!1,error:s}));return[t.readable,n]}class nn extends Error{constructor(){super(...arguments);R(this,"name","SaveSlicedPieceError")}}function Tr(r,e,t,n){return v(this,null,function*(){const s=[];let o=e,i=[],a=0;function u(){return v(this,null,function*(){const c=o+a;en(`saveSlicedPiece [${o}, ${c}]`);try{yield n(new Blob(i),o,c)}catch(h){throw tn(`saveSlicedPiece [${o}, ${c}] failed`,h),new nn(`saveSlicedPiece [${o}, ${c}] failed`)}s.push([o,c]),en(`saveSlicedPiece [${o}, ${c}] finish`,s),o=c})}try{const c=r.getReader();for(;;){const{value:h,done:p}=yield c.read();if(p)break;i.push(h),a+=h.byteLength,a>=t&&(yield u(),i=[],a=0)}a>0&&(yield u())}catch(c){if(!(c instanceof nn)&&(tn("exception occurred while reading stream and save by pieces",c),a>0))try{yield u()}catch(h){}}return s})}function Ar(r){let e,t=!1;const n=new ReadableStream({start:a=>{e=a},cancel:()=>{t=!0}}),s=r.getReader();let o=!1;return{main:new ReadableStream({pull:a=>v(this,null,function*(){try{const{value:u,done:c}=yield s.read();if(o)return;if(c){a.close(),t||e.close();return}a.enqueue(u),t||e.enqueue(u)}catch(u){a.error(u),t||e.error(u)}}),cancel:a=>v(this,null,function*(){o=!0,yield s.cancel(a),e.error(a)})}),minor:n}}var lt={exports:{}};(function(r,e){(function(t,n){var s="1.0.2",o="",i="?",a="function",u="undefined",c="object",h="string",p="major",l="model",f="name",d="type",w="vendor",m="version",C="architecture",g="console",b="mobile",y="tablet",S="smarttv",D="wearable",B="embedded",Y=255,H="Amazon",K="Apple",G="ASUS",z="BlackBerry",q="Browser",F="Chrome",ae="Edge",j="Firefox",U="Google",zn="Huawei",At="LG",Dt="Microsoft",Un="Motorola",ze="Opera",kt="Samsung",Lt="Sony",Hn="Xiaomi",Mt="Zebra",$n="Facebook",yo=function(E,k){var _={};for(var N in E)k[N]&&k[N].length%2===0?_[N]=k[N].concat(E[N]):_[N]=E[N];return _},Ue=function(E){for(var k={},_=0;_<E.length;_++)k[E[_].toUpperCase()]=E[_];return k},qn=function(E,k){return typeof E===h?xe(k).indexOf(xe(E))!==-1:!1},xe=function(E){return E.toLowerCase()},Ro=function(E){return typeof E===h?E.replace(/[^\d\.]/g,o).split(".")[0]:n},Pt=function(E,k){if(typeof E===h)return E=E.replace(/^\s\s*/,o).replace(/\s\s*$/,o),typeof k===u?E:E.substring(0,Y)},Ee=function(E,k){for(var _=0,N,T,$e,M,_e,Z;_<k.length&&!_e;){var jn=k[_],Kn=k[_+1];for(N=T=0;N<jn.length&&!_e;)if(_e=jn[N++].exec(E),_e)for($e=0;$e<Kn.length;$e++)Z=_e[++T],M=Kn[$e],typeof M===c&&M.length>0?M.length===2?typeof M[1]==a?this[M[0]]=M[1].call(this,Z):this[M[0]]=M[1]:M.length===3?typeof M[1]===a&&!(M[1].exec&&M[1].test)?this[M[0]]=Z?M[1].call(this,Z,M[2]):n:this[M[0]]=Z?Z.replace(M[1],M[2]):n:M.length===4&&(this[M[0]]=Z?M[3].call(this,Z.replace(M[1],M[2])):n):this[M]=Z||n;_+=2}},Bt=function(E,k){for(var _ in k)if(typeof k[_]===c&&k[_].length>0){for(var N=0;N<k[_].length;N++)if(qn(k[_][N],E))return _===i?n:_}else if(qn(k[_],E))return _===i?n:_;return E},So={"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"},Wn={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Fn={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[m,[f,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[m,[f,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[f,m],[/opios[\/ ]+([\w\.]+)/i],[m,[f,ze+" Mini"]],[/\bopr\/([\w\.]+)/i],[m,[f,ze]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale|qqbrowserlite|qq)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[f,m],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[m,[f,"UC"+q]],[/\bqbcore\/([\w\.]+)/i],[m,[f,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[m,[f,"WeChat"]],[/konqueror\/([\w\.]+)/i],[m,[f,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[m,[f,"IE"]],[/yabrowser\/([\w\.]+)/i],[m,[f,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[f,/(.+)/,"$1 Secure "+q],m],[/\bfocus\/([\w\.]+)/i],[m,[f,j+" Focus"]],[/\bopt\/([\w\.]+)/i],[m,[f,ze+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[m,[f,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[m,[f,"Dolphin"]],[/coast\/([\w\.]+)/i],[m,[f,ze+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[m,[f,"MIUI "+q]],[/fxios\/([-\w\.]+)/i],[m,[f,j]],[/\bqihu|(qi?ho?o?|360)browser/i],[[f,"360 "+q]],[/(oculus|samsung|sailfish)browser\/([\w\.]+)/i],[[f,/(.+)/,"$1 "+q],m],[/(comodo_dragon)\/([\w\.]+)/i],[[f,/_/g," "],m],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[f,m],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i],[f],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[f,$n],m],[/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[f,m],[/\bgsa\/([\w\.]+) .*safari\//i],[m,[f,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[m,[f,F+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[f,F+" WebView"],m],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[m,[f,"Android "+q]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[f,m],[/version\/([\w\.]+) .*mobile\/\w+ (safari)/i],[m,[f,"Mobile Safari"]],[/version\/([\w\.]+) .*(mobile ?safari|safari)/i],[m,f],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[f,[m,Bt,So]],[/(webkit|khtml)\/([\w\.]+)/i],[f,m],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[f,"Netscape"],m],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[m,[f,j+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[f,m]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[C,"amd64"]],[/(ia32(?=;))/i],[[C,xe]],[/((?:i[346]|x)86)[;\)]/i],[[C,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[C,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[C,"armhf"]],[/windows (ce|mobile); ppc;/i],[[C,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[C,/ower/,o,xe]],[/(sun4\w)[;\)]/i],[[C,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[C,xe]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[pt]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[l,[w,kt],[d,y]],[/\b((?:s[cgp]h|gt|sm)-\w+|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[l,[w,kt],[d,b]],[/\((ip(?:hone|od)[\w ]*);/i],[l,[w,K],[d,b]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[l,[w,K],[d,y]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[l,[w,zn],[d,y]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}-[atu]?[ln][01259x][012359][an]?)\b(?!.+d\/s)/i],[l,[w,zn],[d,b]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[l,/_/g," "],[w,Hn],[d,b]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[l,/_/g," "],[w,Hn],[d,y]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[l,[w,"OPPO"],[d,b]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[l,[w,"Vivo"],[d,b]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[l,[w,"Realme"],[d,b]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[l,[w,Un],[d,b]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[l,[w,Un],[d,y]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[l,[w,At],[d,y]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[l,[w,At],[d,b]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[l,[w,"Lenovo"],[d,y]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[l,/_/g," "],[w,"Nokia"],[d,b]],[/(pixel c)\b/i],[l,[w,U],[d,y]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[l,[w,U],[d,b]],[/droid.+ ([c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[l,[w,Lt],[d,b]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[l,"Xperia Tablet"],[w,Lt],[d,y]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[l,[w,"OnePlus"],[d,b]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[l,[w,H],[d,y]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[l,/(.+)/g,"Fire Phone $1"],[w,H],[d,b]],[/(playbook);[-\w\),; ]+(rim)/i],[l,w,[d,y]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[l,[w,z],[d,b]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[l,[w,G],[d,y]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[l,[w,G],[d,b]],[/(nexus 9)/i],[l,[w,"HTC"],[d,y]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic|sony)[-_ ]?([-\w]*)/i],[w,[l,/_/g," "],[d,b]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[l,[w,"Acer"],[d,y]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[l,[w,"Meizu"],[d,b]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[l,[w,"Sharp"],[d,b]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[w,l,[d,b]],[/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[w,l,[d,y]],[/(surface duo)/i],[l,[w,Dt],[d,y]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[l,[w,"Fairphone"],[d,b]],[/(u304aa)/i],[l,[w,"AT&T"],[d,b]],[/\bsie-(\w*)/i],[l,[w,"Siemens"],[d,b]],[/\b(rct\w+) b/i],[l,[w,"RCA"],[d,y]],[/\b(venue[\d ]{2,7}) b/i],[l,[w,"Dell"],[d,y]],[/\b(q(?:mv|ta)\w+) b/i],[l,[w,"Verizon"],[d,y]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[l,[w,"Barnes & Noble"],[d,y]],[/\b(tm\d{3}\w+) b/i],[l,[w,"NuVision"],[d,y]],[/\b(k88) b/i],[l,[w,"ZTE"],[d,y]],[/\b(nx\d{3}j) b/i],[l,[w,"ZTE"],[d,b]],[/\b(gen\d{3}) b.+49h/i],[l,[w,"Swiss"],[d,b]],[/\b(zur\d{3}) b/i],[l,[w,"Swiss"],[d,y]],[/\b((zeki)?tb.*\b) b/i],[l,[w,"Zeki"],[d,y]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[w,"Dragon Touch"],l,[d,y]],[/\b(ns-?\w{0,9}) b/i],[l,[w,"Insignia"],[d,y]],[/\b((nxa|next)-?\w{0,9}) b/i],[l,[w,"NextBook"],[d,y]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[w,"Voice"],l,[d,b]],[/\b(lvtel\-)?(v1[12]) b/i],[[w,"LvTel"],l,[d,b]],[/\b(ph-1) /i],[l,[w,"Essential"],[d,b]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[l,[w,"Envizen"],[d,y]],[/\b(trio[-\w\. ]+) b/i],[l,[w,"MachSpeed"],[d,y]],[/\btu_(1491) b/i],[l,[w,"Rotor"],[d,y]],[/(shield[\w ]+) b/i],[l,[w,"Nvidia"],[d,y]],[/(sprint) (\w+)/i],[w,l,[d,b]],[/(kin\.[onetw]{3})/i],[[l,/\./g," "],[w,Dt],[d,b]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[l,[w,Mt],[d,y]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[l,[w,Mt],[d,b]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[w,l,[d,g]],[/droid.+; (shield) bui/i],[l,[w,"Nvidia"],[d,g]],[/(playstation [345portablevi]+)/i],[l,[w,Lt],[d,g]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[l,[w,Dt],[d,g]],[/smart-tv.+(samsung)/i],[w,[d,S]],[/hbbtv.+maple;(\d+)/i],[[l,/^/,"SmartTV"],[w,kt],[d,S]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[w,At],[d,S]],[/(apple) ?tv/i],[w,[l,K+" TV"],[d,S]],[/crkey/i],[[l,F+"cast"],[w,U],[d,S]],[/droid.+aft(\w)( bui|\))/i],[l,[w,H],[d,S]],[/\(dtv[\);].+(aquos)/i],[l,[w,"Sharp"],[d,S]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w ]*; *(\w[^;]*);([^;]*)/i],[[w,Pt],[l,Pt],[d,S]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[d,S]],[/((pebble))app/i],[w,l,[d,D]],[/droid.+; (glass) \d/i],[l,[w,U],[d,D]],[/droid.+; (wt63?0{2,3})\)/i],[l,[w,Mt],[d,D]],[/(quest( 2)?)/i],[l,[w,$n],[d,D]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[w,[d,B]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[l,[d,b]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[l,[d,y]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[d,y]],[/(phone|mobile(?:[;\/]| safari)|pda(?=.+windows ce))/i],[[d,b]],[/(android[-\w\. ]{0,9});.+buil/i],[l,[w,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[m,[f,ae+"HTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[m,[f,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[f,m],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[m,f]],os:[[/microsoft (windows) (vista|xp)/i],[f,m],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[f,[m,Bt,Wn]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[f,"Windows"],[m,Bt,Wn]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[m,/_/g,"."],[f,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[f,"Mac OS"],[m,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86)/i],[m,f],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[f,m],[/\(bb(10);/i],[m,[f,z]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[m,[f,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[m,[f,j+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[m,[f,"webOS"]],[/crkey\/([\d\.]+)/i],[m,[f,F+"cast"]],[/(cros) [\w]+ ([\w\.]+\w)/i],[[f,"Chromium OS"],m],[/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[f,m],[/(sunos) ?([\w\.\d]*)/i],[[f,"Solaris"],m],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[f,m]]},Q=function(E,k){if(typeof E===c&&(k=E,E=n),!(this instanceof Q))return new Q(E,k).getResult();var _=E||(typeof t!==u&&t.navigator&&t.navigator.userAgent?t.navigator.userAgent:o),N=k?yo(Fn,k):Fn;return this.getBrowser=function(){var T={};return T[f]=n,T[m]=n,Ee.call(T,_,N.browser),T.major=Ro(T.version),T},this.getCPU=function(){var T={};return T[C]=n,Ee.call(T,_,N.cpu),T},this.getDevice=function(){var T={};return T[w]=n,T[l]=n,T[d]=n,Ee.call(T,_,N.device),T},this.getEngine=function(){var T={};return T[f]=n,T[m]=n,Ee.call(T,_,N.engine),T},this.getOS=function(){var T={};return T[f]=n,T[m]=n,Ee.call(T,_,N.os),T},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return _},this.setUA=function(T){return _=typeof T===h&&T.length>Y?Pt(T,Y):T,this},this.setUA(_),this};Q.VERSION=s,Q.BROWSER=Ue([f,m,p]),Q.CPU=Ue([C]),Q.DEVICE=Ue([l,w,d,g,b,S,y,D,B]),Q.ENGINE=Q.OS=Ue([f,m]),r.exports&&(e=r.exports=Q),e.UAParser=Q;var pe=typeof t!==u&&(t.jQuery||t.Zepto);if(pe&&!pe.ua){var He=new Q;pe.ua=He.getResult(),pe.ua.get=function(){return He.getUA()},pe.ua.set=function(E){He.setUA(E);var k=He.getResult();for(var _ in k)pe.ua[_]=k[_]}}})(typeof window=="object"?window:ee)})(lt,lt.exports);const rn=lt.exports,ct=rn(navigator.userAgent);function Dr(){return ct.device.type==="mobile"||ct.device.type==="tablet"}let ye;function ut(){if(ye!=null)return ye;try{new Response(new ReadableStream),ye=!0}catch(r){ye=!1}return ye}function ht(){return!(typeof TransformStream=="undefined"||!ut())}function kr(){return ct.browser.name==="Safari"?1073741824:null}class ue{constructor(e,{method:t,headers:n,signal:s,body:o}){R(this,"url");R(this,"method");R(this,"headers");R(this,"body");R(this,"signal");this.url=e,this.method=t!=null?t:"GET",this.headers=new Headers(n),this.body=o!=null?o:null,this.signal=s!=null?s:new AbortController().signal}}class re{constructor(e,{status:t,statusText:n,headers:s,underlayer:o}){R(this,"status");R(this,"statusText");R(this,"headers");R(this,"body");R(this,"bodyReadResult");R(this,"underlayer");if(this.status=t!=null?t:200,this.statusText=n!=null?n:"",this.headers=xr(s),this.underlayer=o,e==null||!ht())this.body=e,this.bodyReadResult=Promise.resolve({success:!0,size:0});else{const[i,a]=_r(e);this.body=i,this.bodyReadResult=a}}}function Pe(r){const{status:e,statusText:t,headers:n,body:s}=r;return new re(s,{status:e,statusText:t,headers:n,underlayer:r})}class dt extends Error{constructor(t){super(`Unexpected HTTP status: ${t.status} ${t.statusText}`);R(this,"name","UnexpectedHttpStatusError");this.response=t}}const Lr=new Rr;let sn;typeof self!="undefined"&&(sn=self,sn.addEventListener("message",r=>Lr.emit("message",r)));class Mr extends Error{constructor(){super(...arguments);R(this,"name","WindowClientError")}}class Pr extends Error{constructor(){super(...arguments);R(this,"name","UnexpectedDataChannelCloseError")}}class Br extends Error{constructor(){super(...arguments);R(this,"name","UnexpectedDataChannel1stMessageError")}}function ft(r,e=()=>1){if(r.length===0)return null;const t=r.map(e),n=t.reduce((o,i)=>o+i,0);let s=Math.random()*n;for(let o=0;o<t.length;o++){const i=t[o];if(s<i)return r[o];s-=i}return r[0]}function se(r){return r&&r.name==="AbortError"}const Ir=new Pr().name,Or=new Br().name;function Be(r){return!(r&&[Ir,Or].includes(r.name)||se(r)||r instanceof Mr)}class wt extends Error{constructor(t){super(t+"");R(this,"name","ResolveError");this.cause=t}}class on extends Error{constructor(){super(...arguments);R(this,"name","NoAvailableNodeError")}}class pt extends Error{constructor(t){super(t+"");R(this,"name","DoWithNodeError");this.cause=t}}class oe extends Error{constructor(){super(...arguments);R(this,"name","LocalDNSError")}}function Nr(r,e,t){const n=t||new URL(r).hostname;let s,o;r=r.replace(/^\w+:\/\//,"").split("#")[0];const i=r.indexOf("?");i>=0?(o=r.slice(i+1),r=r.slice(0,i)):o="";const a=r.indexOf("/");s=a>=0?r.slice(a):"",s=zr(e.rewrites,s),o=qr(e.queryString,o);let u=n+s;return o!==""&&(u=u+"?"+o),u}function zr(r,e){for(const t of r){const n=Ur(t,e);if(n!=null){e=$r(t,n);break}}return e}function Ur(r,e){return new RegExp(r.pattern).exec(e)}const Hr=/\${(\d+)}/g;function $r(r,e){return r.repl.replace(Hr,(t,n)=>{var o;const s=parseInt(n,10);return s>=e.length?t:(o=e[s])!=null?o:""})}function qr({type:r,values:e},t){if(r==="none")return"";if(r==="all")return t;const n=Zn(t),s=e!=null?e:[],o={};return Object.keys(n).forEach(i=>{r==="include"&&!s.includes(i)||r==="exclude"&&s.includes(i)||(o[i]=n[i])}),Ge(o)}function an(r,e){const t=new Map;return function(...s){const o=e(...s),i=t.get(o);if(i!=null)return i;const a=r(...s);return t.set(o,a),a.finally(()=>{t.delete(o)}),a}}const he=X("dns"),ie=te("dns"),Wr="miku-delivery/dns/cdn/v1",Fr=[];function jr(){return Qt(Fr)}const mt="result",Kr={name:mt,indexes:[{name:"domain",keyPath:"domain"}]};class ln{constructor(e,t,n=gr,s,o=2e3,i=5e3){R(this,"fingerprints",new Map);R(this,"disabledElts",new Map);R(this,"storage",new Xt(Wr,[Kr]));R(this,"getResolveResultFromStorage",an(e=>this.storage.get(mt,e),e=>e));R(this,"refreshResolveResultInStorage",an((e,t)=>v(this,null,function*(){const n=yield this.dnsResolver(e,t,this.app,this.logger),s=Date.now()+n.ttl*1e3,o=W(x({},n),{domain:t,expireAt:s});return this.saveResolveResultToStorage(t,o),o}),(e,t)=>t));this.logger=e,this.app=t,this.dnsResolver=n,this.cacheKeyFn=s,this.resolveTimeout=o,this.initialDisableDuration=i}getFingerprint(e){const t=this.fingerprints.get(e);if(t==null)throw new Error(`No fingerprint for ${e}`);return t}isEltDisabled(e){const t=this.disabledElts.get(e);return t==null?!1:t.after>Date.now()}setEltDisabled(e){const t=this.disabledElts.get(e),n=t==null?this.initialDisableDuration:t.duration,s=Date.now()+n;this.disabledElts.set(e,{duration:n*2,after:s})}removeEltDisabled(e){this.disabledElts.has(e)&&this.disabledElts.delete(e)}getCacheKey(e,t){return v(this,null,function*(){if(this.cacheKeyFn!=null)return this.cacheKeyFn(e);const n=yield this.resolveDomain(new V,t);return et(n)?Nr(e,n.cacheKey,n.bucket):e})}getMediaOptimization(e){return v(this,null,function*(){const t=yield this.resolveDomain(new V,e);return et(t)?t.mediaOptimization:null})}saveResolveResultToStorage(e,t){return v(this,null,function*(){return this.storage.set(mt,e,t)})}resolveDomain(e,t){return v(this,null,function*(){const n=Date.now(),s=(()=>v(this,null,function*(){const o=yield this.getResolveResultFromStorage(t);return o==null?this.refreshResolveResultInStorage(e,t):(Qr(o)&&(he("result from storage cache expired",t),this.refreshResolveResultInStorage(e,t)),e.set("dnsResolveFromCache",!0),o)}))().then(o=>(e.set("dnsResolveTotalTime",O(Date.now(),n)),o));return Promise.race([s,Ae(this.resolveTimeout,"Resolve domain")]).catch(o=>{throw ie("DNS resolve failed:",o),new wt(o)})})}resolve(e,t){return v(this,null,function*(){let n=null;return yield this.do(e,t,1,s=>{n=s}),n})}do(e,t,n,s){return v(this,null,function*(){let o;he("Resolve for",t);const i=new URL(t).hostname,[a,u]=yield Promise.all([this.getCacheKey(t,i),this.resolveDomain(e,i)]);if(!et(u))throw new oe(`Non-ECDN resolve result: ${i}`);const{groups:c,rules:h}=u;if(c.length===0)throw ie(`ECDN resolve result error: No available group for ${i}`),new on(`No available group for ${i}`);he("Resolved for",t);const p=vr(h,a);if(p==null)throw ie("ECDN resolve result error: No matched rule found"),new oe("No matched rule found");if(!br(p))throw new oe("Do not serve with given rule");let l=p.groups.map(({groupidx:f,weight:d,splitn:w})=>{const m=c[f];if(m==null)throw ie(`ECDN resolve result error: Unexpected groupidx ${f}`),new Error(`Unexpected groupidx: ${f}`);return{group:m,weight:d,splitn:w}});for(let f=0;f<n;f++){const d=ft(l,w=>w.weight);if(d==null)break;try{he("doWithGroup",f,a),yield this.doWithGroup(e,d.group,a,d.splitn,s);return}catch(w){if(ie("doWithGroup (weight:",d.weight,") failed:",w,a),o=w,se(w))break;Be(w)&&(l=l.filter(m=>m!==d))}}throw o=se(o)?o:new pt(o),o})}doWithGroup(e,t,n,s,o){return v(this,null,function*(){const i=t.elts.filter(l=>!this.isEltDisabled(l.id));if(i.length===0)throw new Error("No available elt");const a=Vr(t),u=new Set(i.map(l=>l.id)),c=s===1?2:s;let h=a.getN(n,c,u).map(l=>i.find(f=>f.id===l)),p;for(let l=0;l<2;l++){const f=ft(h.slice(0,s),d=>d.replicas);if(f==null)break;try{he("doWithElt",f.id,n),e.set("downloadEltID",f.id),yield Gr(f,n,o),this.removeEltDisabled(f.id);return}catch(d){if(ie("doWithElt",f.id,"failed:",d,n),p=d,se(d))break;Be(d)&&(h=h.filter(w=>w!==f),this.setEltDisabled(f.id))}}throw p})}}const cn=new Map;function Vr({elts:r}){const e=r.map(({id:s,replicas:o})=>`${s}:${o}`).join(","),t=cn.get(e);if(t!=null)return t;const n=new ge;return n.set(r.map(s=>({key:s.id,replicas:s.replicas}))),cn.set(e,n),n}function Gr(r,e,t){return v(this,null,function*(){let n=r.addrs;if(n.length===0)throw new Error("Empty addr list");let s;for(let o=0;o<2;o++){const i=ft(n);if(i==null)break;try{he("do job with",i,e),yield t(i);return}catch(a){if(ie("do job with",i,"failed:",a,e),s=a,se(a))break;Be(a)&&(n=n.filter(u=>u!==i))}}throw s})}function Qr(r){return r.expireAt<Date.now()}class Xr{constructor(){R(this,"front",null);R(this,"back",null)}insertElementBefore(e,t){const n=t.prev;n!=null?(n.next=e,e.prev=n):this.front=e,t.prev=e,e.next=t}insertElementAfter(e,t){const n=t.next;n!=null?(n.prev=e,e.next=n):this.back=e,t.next=e,e.prev=t}pushElementFront(e){const t=this.front;t!=null?(t.prev=e,e.next=t):this.back=e,this.front=e}pushElementBack(e){const t=this.back;t!=null?(t.next=e,e.prev=t):this.front=e,this.back=e}moveBefore(e,t){e!==t&&(this.remove(e),this.insertElementBefore(e,t))}moveAfter(e,t){e!==t&&(this.remove(e),this.insertElementAfter(e,t))}moveToFront(e){this.remove(e),this.pushElementFront(e)}moveToBack(e){this.remove(e),this.pushElementBack(e)}insertBefore(e,t){const n={value:e,prev:null,next:null};return this.insertElementBefore(n,t),n}insertAfter(e,t){const n={value:e,prev:null,next:null};return this.insertElementAfter(n,t),n}pushFront(e){const t={value:e,prev:null,next:null};return this.pushElementFront(t),t}pushBack(e){const t={value:e,prev:null,next:null};return this.pushElementBack(t),t}remove(e){const t=e.prev,n=e.next;return t!=null?(t.next=n,e.prev=null):this.front=n,n!=null?(n.prev=t,e.next=null):this.back=t,e.value}walk(e){let t=this.front;for(;t!=null;){if(e(t.value,t)===!1)return;t=t.next}}reverseWalk(e){let t=this.back;for(;t!=null;){if(e(t.value,t)===!1)return;t=t.prev}}}const Ie=X("dc/cr"),Yr=te("dc/cr"),Zr={reservedQuota:5*1024*1024};class Jr{constructor(e,t=Zr){R(this,"inited");R(this,"itemElementMap",new Map);R(this,"itemList",new Xr);this.dc=e,this.config=t,this.inited=this.resume()}resume(){return v(this,null,function*(){const e=[];yield this.dc.walkItems((t,n)=>{const s={key:n,usedTime:t.usedTime,size:gt(t)},o=this.itemList.pushBack(s);this.itemElementMap.set(n,o),e.push(...ls(t,n))});try{const t=yield this.dc.getBrowserCacheKeys();for(let n of t)e.includes(n)||(Ie("clear inaccessible cache:",n),yield this.dc.browserCacheDelete(n))}catch(t){Yr("failed to clear inaccessible caches:",t)}})}addItem(e,t){const n={key:e,usedTime:t.usedTime,size:gt(t)};let s=null;return this.itemList.reverseWalk((o,i)=>{if(o.usedTime<=t.usedTime)return s=this.itemList.insertAfter(n,i),!1}),s==null&&(s=this.itemList.pushFront(n)),this.itemElementMap.set(e,s),s}removeItem(e){const t=this.itemElementMap.get(e);t!=null&&(this.itemElementMap.delete(e),this.itemList.remove(t))}onItemSet(e,t){return v(this,null,function*(){yield this.inited;let n=this.itemElementMap.get(e);if(n==null){this.addItem(e,t);return}n.value.size=gt(t),t.usedTime!==n.value.usedTime&&(n.value.usedTime=t.usedTime,this.itemList.moveToBack(n))})}getTotalSize(){let e=0;return this.itemList.walk(({size:t})=>{e+=t}),e}getLeftSpace(){return v(this,null,function*(){if(typeof navigator.storage.estimate=="undefined"){const n=kr();if(n==null)return null;const s=1.1*this.getTotalSize();return n-s}const{quota:e,usage:t}=yield navigator.storage.estimate();return e!=null&&t!=null?e-t:null})}freeUpSpace(e){return v(this,null,function*(){yield this.inited;let t=0;const n=[];this.itemList.walk(({key:s,size:o})=>{if(o!==0&&(n.push(s),t+=o,t>=e))return!1}),Ie("to free up space, remove",n),yield Promise.all(n.map(s=>v(this,null,function*(){yield this.dc.removeItemWithContent(s),this.removeItem(s)})))})}beforeContentSet(e,t,n){return v(this,null,function*(){if(n==null)return;yield this.inited;const s=yield this.getLeftSpace(),o=this.config.reservedQuota;if(s!=null&&s-o<n){const i=n-s+o;Ie("freeUpSpace for",e,t,i),yield this.freeUpSpace(i)}})}onQuotaExceeded(e,t,n){return v(this,null,function*(){Ie("quota exceeded",e,t,n);const s=this.config.reservedQuota;yield this.freeUpSpace(n?n+s:s)})}}function es([r,e],t){return e=e!=null?e:t,e!=null?e-r:0}function gt(r){return r.pieces.reduce((e,t)=>{var n,s;return e+es(t,(s=(n=r.meta)==null?void 0:n.fsize)!=null?s:null)},0)}const ts=X("dc"),ns="miku-delivery/dc/v1",un=["miku/dc","miku/dc/v2","miku/dc/v3"];function rs(){return Promise.all([ss(un),Qt(un)])}function ss(r){return v(this,null,function*(){const t=(yield caches.keys()).filter(n=>r.includes(n));yield Promise.all(t.map(n=>caches.delete(n)))})}const Re="item",hn="usedTimeIndex",os={name:Re,indexes:[{name:hn,keyPath:"usedTime"}]},is=32*1024*1024;class as{constructor(e={},t=ns){R(this,"db");R(this,"cr");R(this,"browserCache",null);R(this,"browserCachePromise",null);this.config=e,this.ns=t,this.db=new Xt(this.ns,[os]),this.cr=new Jr(this)}openBrowserCache(){return v(this,null,function*(){return this.browserCachePromise!=null?this.browserCachePromise:(this.browserCachePromise=caches.open(this.ns).catch(e=>{throw new de(e)}),this.browserCachePromise.then(e=>{this.browserCache=e}),this.browserCachePromise)})}getItem(e){return v(this,null,function*(){return this.db.get(Re,e)})}setItem(e,t){return v(this,null,function*(){ts("setItem",e,t),yield this.db.set(Re,e,t),yield this.cr.onItemSet(e,t)})}walkItems(e){return v(this,null,function*(){return this.db.walkBy(Re,hn,e)})}removeItemWithContent(e){return v(this,null,function*(){const t=yield this.getItem(e);t!=null&&(yield Promise.all(t.pieces.map(n=>this.removeContent(e,n))),yield this.db.remove(Re,e))})}browserCacheMatch(e){return v(this,null,function*(){let t=this.browserCache;return t==null&&(t=yield this.openBrowserCache()),t.match(e).catch(n=>{throw new de(n)})})}browserCachePut(e,t){return v(this,null,function*(){let n=this.browserCache;n==null&&(n=yield this.openBrowserCache()),yield n.put(e,t).catch(s=>{throw new de(s)})})}browserCacheDelete(e){return v(this,null,function*(){let t=this.browserCache;t==null&&(t=yield this.openBrowserCache()),yield t.delete(e).catch(n=>{throw new de(n)})})}getBrowserCacheKeys(){return v(this,null,function*(){let e=this.browserCache;return e==null&&(e=yield this.openBrowserCache()),yield e.keys().then(t=>t.map(n=>n.url))})}getContent(e,t){return v(this,null,function*(){const n=yield this.browserCacheMatch(Oe(e,t));if(n!=null){if(n.body==null)throw new Error("Body expected for cached response");return Pe(n)}})}setContent(e,t,n,s){return v(this,null,function*(){if(!ut())yield this.cacheResponse(e,t,n.underlayer),yield s(t);else{const{headers:o,body:i}=n,a=it(o);yield Tr(i,t[0],is,(u,c,h)=>v(this,null,function*(){o.set("Content-Range",rt({start:c,end:h-1,totalSize:a})),o.set("Content-Length",h-c+"");const p=new Response(u,{status:200,statusText:"OK",headers:o});yield this.cacheResponse(e,[c,h],p),yield s([c,h])}))}})}cacheResponse(e,t,n){return v(this,null,function*(){const s=Oe(e,t),o=ce(n.headers);yield this.cr.beforeContentSet(e,t,o);try{yield this.browserCachePut(s,n)}catch(i){throw i instanceof de&&i.cause instanceof Error&&i.cause.name==="QuotaExceededError"&&this.cr.onQuotaExceeded(e,t,o),i}})}removeContent(e,t){return v(this,null,function*(){const n=Oe(e,t);return this.browserCacheDelete(n)})}dispose(){this.db.dispose()}}function Oe(r,e){var t;return/^https?:\/\//.test(r)||(r="https://miku-cache.com/"+r),`${r}_with_range_${e[0]}_${(t=e[1])!=null?t:""}`}function ls(r,e){return r.pieces.map(t=>Oe(e,t))}class de extends Error{constructor(t){super(t+"");R(this,"name","BrowserCacheError");this.cause=t}}class cs{constructor(e){this.logger=e}log(e){return this.logger.log("DoLog",e)}}const vt="1.3.0",us=3,dn=X("http");class fn{constructor(e,t,n,s=0){R(this,"doLogger");this.client=t,this.resolver=n,this.clientResponseTimeout=s,this.doLogger=new cs(e)}doWithResolved(e,t,n){return v(this,null,function*(){dn("fetch",t.url,"with resolved",n);const s=new AbortController;nr(s,t.signal);const o=new ue(t.url,W(x({},t),{signal:s.signal}));o.headers.set("X-Miku-Agent",`miku-delivery-web/v${vt}`);let i=this.client.fetch(e,o,n);this.clientResponseTimeout>0&&(i=Promise.race([i,Ae(this.clientResponseTimeout,"HTTPClient get response")]),i.catch(u=>{u instanceof Ht&&s.abort(u)}));const a=yield i;if(dn("fetch",t.url,"succeeded with status",a.status),a.status===429||a.status>=500)throw new dt(a);return a})}originalDo(e,t){return v(this,null,function*(){if(t.signal.aborted)throw t.signal.reason;let n=-1,s;if(yield this.resolver.do(e,t.url,us,o=>v(this,null,function*(){const i=new V(e);n++,i.set("downloadRetryCount",n),s=yield this.doWithResolved(i,t,o)})),s==null)throw new Error(`Http do failed: resolver do finished with no finalResp, url: ${t.url}`);return s})}do(e,t){return v(this,null,function*(){const n=Date.now(),s=Te();e.set("doID",s);let o,i=null;try{return o=yield this.originalDo(e,t),o}catch(a){throw i=a,a}finally{const{onDoError:a,onDoResponsed:u}=this.getDoLog(e,s,n);o==null?a(i):u(o.status)}})}getDoLog(e,t,n){const s=a=>{var u;return this.doLogger.log(x({lookup_type:!0,t_lookup:(u=e.get("dnsResolveFromCache")===!0?0:e.get("dnsResolveTotalTime"))!=null?u:-1,t_total:-1,ts_st:n,err_desc:"",err_msg:"",status_code:-1,task_id:e.get("taskID"),id:t},a))};return{onDoError:a=>{const u=Date.now();s(x({t_total:O(u,n)},ne(a)))},onDoResponsed:a=>{const u=Date.now();s({t_total:O(u,n),status_code:a})}}}}class hs{constructor(e){this.logger=e}log(e){return this.logger.log("TaskLog",e)}}class wn{constructor(e,t,n,s){R(this,"id",Te());R(this,"priority",0);R(this,"signal");R(this,"started",!1);R(this,"taskLogger");this.url=e,this.range=t,this.startByClient=s,this.taskLogger=new hs(n)}setPriority(e){this.priority=e}start(e){return v(this,null,function*(){if(this.started)throw new Error("Task already started");if(this.started=!0,this.signal=e,e&&e.aborted)throw e.reason;const t=Date.now(),n=new V;n.set("taskID",this.id),n.set("taskDomain",new URL(this.url).hostname);let s,o=null;try{return s=yield this.startByClient(n,this),s}catch(i){throw o=i,i}finally{const{logOnError:i,logOnTransferred:a}=this.log(n,t);s==null?i(o):s.underlayer.bodyReadResult.then(u=>{u.success?a():i(u.error)})}})}log(e,t){const n=e.get("taskCacheMatchAt"),s=e.get("task1stHttpDoAt"),o=e.get("taskResultStreamAt"),i=Date.now(),a=h=>{var p,l,f,d,w;return this.taskLogger.log(x({type:(p=e.get("taskType"))!=null?p:1,id:this.id,url:this.url,err_msg:"",err_desc:"",range_st:(f=(l=this.range)==null?void 0:l.start)!=null?f:-1,range_end:(w=(d=this.range)==null?void 0:d.end)!=null?w:-1,ts_st:t,t_cc_match:O(n,t),t_http_do:O(s,n),t_res_stream:O(o,n),t_res:O(i,o),t_trans:-1,t_total:-1},h))};return{logOnError:h=>{const p=Date.now();a(x({t_total:O(p,t)},ne(h)))},logOnTransferred:()=>{const h=Date.now();a({t_trans:O(h,i),t_total:O(h,t)})}}}}class pn{constructor(e,t,n,s,o){this.stream=e,this.size=t,this.fileSize=n,this.contentType=s,this.underlayer=o}blob(){return v(this,null,function*(){const e=this.stream.getReader(),t=[];for(;;){const{done:n,value:s}=yield e.read();if(n)break;const o=s;t.push(o)}return new Blob(t)})}}function bt(r,e,t){return r!=null&&t!=null&&t>=r&&(t=null),(e==null||e<0)&&(e=0),[e,t]}function mn(r,e){var s;const t=((s=e[0])!=null?s:0)===0,n=e[1]==null||r!=null&&e[1]===r;return t&&n}function ds(r,e){var s,o;const t=(s=e[0])!=null?s:0,n=(o=e[1])!=null?o:r;return n==null?null:n-t}function fs(r,e,t){var u,c;if(e===0)return[];const n=(h,p)=>vn(h,p,e!=null?e:Number.POSITIVE_INFINITY),s=(u=r==null?void 0:r[0])!=null?u:0,o=(c=r==null?void 0:r[1])!=null?c:e,i=[];let a=s;for(const h of t){if(a==null||e!=null&&h[1]!=null&&h[1]>e)break;if(!(h[1]!=null&&a>=h[1])){if(o==null||o>h[0]){h[0]>a&&i.push({cached:!1,range:bt(e,a,h[0])});const p=n(h[0],a)?h[0]:a,l=n(h[1],o)?o:h[1];n(l,p)&&(i.push({cached:!0,range:bt(e,p,l)}),a=l);continue}break}}return n(o,a)&&i.push({cached:!1,range:bt(e,a,o)}),i}function ws(r,e){var s;const t=(s=e[0])!=null?s:0,n=e[1];for(const o of r){if(o[1]!=null&&o[1]<=t)continue;if(o[0]>t)break;const i=t-o[0],a=ms(n!=null?n:o[1],o[0]);return{piece:o,start:i,end:a}}throw new Error("Piece not found")}function ps(r,e){for(let s of r){if(s[0]===e[0]&&s[1]===e[1])return{toSave:r,toRemove:[]};if(gn(s,e))return{toSave:r,toRemove:[e]}}const t=[],n=[];for(let s of r)gn(e,s)?n.push(s):t.push(s);return{toSave:[...t,e].sort((s,o)=>s[0]-o[0]),toRemove:n}}function gn(r,e){return r[0]<=e[0]&&!vn(e[1],r[1],Number.POSITIVE_INFINITY)}function vn(r,e,t){const n=r!=null?r:t,s=e!=null?e:t;return n>s}function ms(r,e){return r==null||e==null?null:r-e}function bn(r){const e={},t=r.split(",").map(n=>{let[s,o]=n.split("=").map(i=>i.trim());return[s.toLowerCase(),o]});for(const[n,s]of t)if(n==="max-age"){if(s!=null){const o=parseInt(s,10);Number.isNaN(o)||(e["max-age"]=o)}}else(n==="no-cache"||n==="no-store")&&(e[n]=!0);return e}function Ne(r){return Math.floor(r/1e3)}function yn(r,e){const t=r.get("Date");if(t==null)return e;const n=Date.parse(t);return Number.isNaN(n)?e:n}function gs(r,e,t){if(r!=null)return r;const n=e.get("Expires");if(n!=null){let s=Date.parse(n);Number.isNaN(s)&&(s=0);const o=yn(e,t);return Ne(s-o)}return 3600}function vs(r){const e=r.get("Age");if(e==null)return 0;const t=parseInt(e,10);return Number.isNaN(t)?0:t}function bs(r,e,t,n){const s=vs(r),o=yn(r,t),i=Math.max(0,Ne(t-o)),a=Ne(t-e),u=s+a,c=Math.max(i,u),h=Ne(n-t);return c+h}function ys(r,e,t,n,s){var u;const o=(u=r==null?void 0:r["max-age"])!=null?u:null,i=gs(o,e,n),a=bs(e,t,n,s);return i>a}function Rs(r,e,t,n){const s=r.get("Cache-Control"),o=s!=null?bn(s):null;return(o==null?void 0:o["no-cache"])===!0?!0:!ys(o,r,e,t,n)}function Ss(r){const e=r.get("Cache-Control"),t=e!=null?bn(e):null;return!(t!=null&&t["no-store"]===!0)}function Cs(r){const e=r.get("ETag");return e==null?null:e.startsWith("W/")?e.slice(2):e}function xs(r,e){const t=new Headers(r),n=Cs(e);n!=null&&t.set("If-None-Match",n);const s=e.get("Last-Modified");return s!=null&&t.set("If-Modified-Since",s),t}function Es(r,e){return!(r.get("Last-Modified")===e.get("Last-Modified")&&r.get("ETag")===e.get("ETag"))}function _s(r,e){const t=new Headers(r);return e.forEach((n,s)=>{s=s.toLowerCase(),!(s==="content-length"||s==="content-encoding"||s==="content-range")&&t.set(s,n)}),t}const Ts={threshold:0,contentRangeExposed:!0},L=X("ftask"),Se=te("ftask");class As{constructor(e,t,n,s,o,i,a){R(this,"id",Te());R(this,"inited");R(this,"meta",null);R(this,"cachePieces",[]);R(this,"usedTime",0);R(this,"isMedia");this.cache=e,this.nativeHttpClient=t,this.http=n,this.key=s,this.url=o,this.patterns=i,this.getMediaOptimization=a,this.inited=this.resume();const u=De(o);this.isMedia=i.media.some(c=>c.test(u))}fileSize(){var e,t;return(t=(e=this.meta)==null?void 0:e.fsize)!=null?t:null}cacheValidationRequired(){if(this.meta==null)return!1;const{requestTime:e,responseTime:t,headers:n}=this.meta;return e==null||t==null||n==null?!1:Rs(n,e,t,Date.now())}isRangeStartFirstRequested(e){var n;const t=(n=e[0])!=null?n:0;return!this.cachePieces.some(s=>{var o;return s[0]<=t&&t<=((o=s[1])!=null?o:Number.POSITIVE_INFINITY)})}startTask(e,t){return v(this,null,function*(){L("startTask",t.url,t.id,t.range);let n;const s=t.range!=null?[t.range.start,t.range.end]:[0,null];yield this.inited,this.usedTime=Date.now(),this.save().catch(a=>Se("save failed when startTask:",a)),ht()?n=yield this.readRangeWithStream(e,t,s):(L("supportStreamOperation: false",t.url,t.id),n=yield this.readRangeWithoutStream(e,t,s));const o=this.meta;if(o==null)throw new Error("Missing meta in fileTask");L("startTask resolved",t.url,t.id);const i=ds(o.fsize,s);return new pn(n.body,i,o.fsize,o.headers.get("Content-Type"),n)})}readRangeWithoutStream(e,t,n){return v(this,null,function*(){var a,u;let s;const o=[(a=n[0])!=null?a:0,n[1]],i=(u=yield this.cache.getContent(this.key,o))!=null?u:null;if(e.set("taskCacheMatchAt",Date.now()),i!=null&&!this.cacheValidationRequired())L("use cache",t.url,t.id),s=i;else if(L("doRequestAndSaveCache",t.url,t.id,i!=null),s=yield this.doRequestAndSaveCache(e,t,n,i!=null,!1),s.status===304){if(i==null)throw new Error("Unexpected 304 with no cached response");s=i}return e.set("taskResultStreamAt",Date.now()),s})}readRangeWithStream(e,t,n){return v(this,null,function*(){const s=this.cacheValidationRequired();L("cacheValidationRequired",s);const o=fs(n,this.fileSize(),this.cachePieces);if(L("applyRange",n,this.fileSize(),this.cachePieces,o),s){const u=o.some(p=>p.cached),c=this.isMedia?yield this.getMediaOptimization():!1,h=yield this.doRequestAndSaveCache(e,t,n,u,c);if(h.status===200||h.status===206)return h}e.set("taskCacheMatchAt",Date.now());const i=new TransformStream(void 0),a=yield new Promise((u,c)=>v(this,null,function*(){try{for(let h=0;h<o.length;h++){const p=h===0,{cached:l,range:f}=o[h];let d=null;if(l&&(d=yield this.readPieceFromLocal(e,t,f)),d==null){const m=this.isMedia&&p&&this.isRangeStartFirstRequested(f)?yield this.getMediaOptimization():!1;d=yield this.readPieceFromRemote(e,t,f,m)}p&&u(d);const w=h===o.length-1;yield d.body.pipeTo(i.writable,{preventClose:!w})}}catch(h){h!=null&&L("readRange stream error for",this.url,h),i.writable.abort(h),c(h)}}));return e.set("taskResultStreamAt",Date.now()),new re(i.readable,a)})}readPieceFromLocal(e,t,n){return v(this,null,function*(){L("readPieceFromLocal",t.url,n);const{piece:s,start:o,end:i}=ws(this.cachePieces,n),a=yield this.cache.getContent(this.key,s);return a==null?(Se(`Missing cache item: ${this.key} [${s})`),null):new re(at(a.body,[o,i]),a)})}readPieceFromRemote(e,t,n,s){return v(this,null,function*(){L("readPieceFromRemote",t.url,n);const o=yield this.doRequestAndSaveCache(e,t,n,!1,s);return!mn(this.fileSize(),n)&&o.status===200?(Se("Range request not supported for",this.url),new re(at(o.body,n),o)):o})}doRequest(e,t,n,s,o){return v(this,null,function*(){var d;e.get("task1stHttpDoAt")==null&&e.set("task1stHttpDoAt",Date.now());const i=new V(e);i.set("downloadFileTaskID",this.id);let a=new Headers({"Accept-Encoding":"identity;q=1, *;q=0"});n!=null&&(t.range==null&&mn(this.fileSize(),n)||a.set("Range",be({start:n[0],end:n[1]==null?null:n[1]-1})));const u=(d=this.meta)==null?void 0:d.headers;s&&u!=null&&(a=xs(a,u));const c=new ue(t.url,{method:"GET",headers:a,signal:t.signal}),h=Date.now();let p;o===!1||o.threshold<=0?p=yield this.http.do(i,c):p=yield Ds((...w)=>this.http.do(...w),(...w)=>this.nativeHttpClient.fetch(...w),o)(i,c);const l=Date.now();let f=p.headers;if(s&&u!=null&&p.status===304)L(`updateStoredHeaders for ${this.url}`),f=_s(u,p.headers);else{if(p.status!==200&&p.status!==206)throw new dt(p);if(p.body==null)throw new Error("Body expected")}return yield this.onResponse(f,h,l),p.bodyReadResult.then(w=>{L(`bodyReadResult for ${this.url}:`,w)}),p})}doRequestAndSaveCache(e,t,n,s,o){return v(this,null,function*(){const i=yield this.doRequest(e,t,n,s,o);return(i.status===200||i.status===206)&&Ss(i.headers)?this.saveCachePiece(t,n,i):i})}saveCachePiece(e,t,n){return v(this,null,function*(){var i,a;let s=n,o;if(ht()){const{main:u,minor:c}=Ar(n.body);s=new re(u,n),o=new re(c,n)}else if(!e.range){const u=n.underlayer.clone();o=Pe(u)}if(o!=null){const u=[(i=t==null?void 0:t[0])!=null?i:0,(a=t==null?void 0:t[1])!=null?a:null];L("saveCachePiece",this.url,u),this.cache.setContent(this.key,u,o,c=>v(this,null,function*(){const{toSave:h,toRemove:p}=ps(this.cachePieces,c);if(this.cachePieces=h,p.length>0){L("remove duplicated cache pieces",p);try{yield Promise.all(p.map(l=>this.cache.removeContent(this.key,l)))}catch(l){L("exception occurred while removing duplicated cache pieces",l)}}return this.save()})).then(()=>L("saveCachePiece finish",this.url,u,this.cachePieces),c=>Se("saveCachePiece failed",this.url,u,c))}return s})}onResponse(e,t,n){return v(this,null,function*(){const s=this.meta;this.meta={fsize:it(e),requestTime:t,responseTime:n,headers:e},(s==null?void 0:s.headers)!=null&&Es(s.headers,e)&&(L(`${this.url} modified, clear local cache`),yield Promise.all(this.cachePieces.map(o=>this.cache.removeContent(this.key,o))),this.cachePieces=[]),this.save().catch(o=>Se("save failed when onResponse:",o))})}resume(){return v(this,null,function*(){const e=yield this.cache.getItem(this.key);e==null||e.meta==null||(this.meta=W(x({},e.meta),{headers:e.meta.headers!=null?new Headers(e.meta.headers):null}),this.cachePieces=e.pieces)})}save(){return v(this,null,function*(){var s,o;const e=((s=this.meta)==null?void 0:s.headers)!=null?[...((o=this.meta)==null?void 0:o.headers).entries()]:null,n={meta:this.meta!=null?W(x({},this.meta),{headers:e}):null,pieces:this.cachePieces,usedTime:this.usedTime};yield this.cache.setItem(this.key,n)})}}function Ds(r,e,{threshold:t,contentRangeExposed:n}){return function(o,i){return v(this,null,function*(){var Y,H;const B=i,{url:a}=B,u=Ot(B,["url"]),c=ot(i.headers);L("doWithInitialOptimization",a);const h=new V(o),p=new Headers(u.headers),l=x({start:null,end:null},c);l.start=(Y=l.start)!=null?Y:0;const f=l.start+t-1;(l.end==null||l.end>f)&&(l.end=f),p.set("Range",be(l));const d=new ue(a,W(x({},u),{headers:p})),m=yield((K,G)=>v(this,null,function*(){var ae;let z=null;const q=ot(G.headers);q!=null&&!Yt(q)&&!n&&(z=ks(a,u.headers,e));const F=yield e(K,G);if(q!=null&&F.status===206&&!F.headers.get("Content-Range")){const j=Yt(q)?ce(F.headers):yield z;if(j!=null){const U=rt({start:q.start,end:(ae=q.end)!=null?ae:j-1,totalSize:j});F.headers.set("Content-Range",U)}}return F}))(h,d);if(m.body==null)throw new Error("Body expected for initial response");if(m.status!==206)return m;const C=nt(m.headers);if(C==null)throw new Error("Header Content-Range expected for 206 response");const g=(()=>{var ae;const K=ce(m.headers);if(K!=null&&K<t)return m.body;const G=new Headers(u.headers),z=x({start:null,end:null},c);if(z.start=((ae=z.start)!=null?ae:0)+t,z.end!=null&&z.end<z.start)return m.body;L("doWithInitialOptimization followingRange",z),G.set("Range",be(z));const q=new ue(a,W(x({},u),{headers:G})),F=new TransformStream;return m.body.pipeTo(F.writable,{preventClose:!0}).then(()=>v(this,null,function*(){L("doWithInitialOptimization initialBody transfered");let j;try{const U=yield r(o,q);if(U.body==null)throw new Error(`Body expected for following response of ${a}`);if(U.status===200)j=at(U.body,[z.start,z.end==null?null:z.end+1]);else if(U.status===206)j=U.body;else throw new dt(U)}catch(U){if(Ls(U))L("use fallback fetch for doWithInitialOptimization followingBody",U),j=(yield e(o,q)).body;else{L("doWithInitialOptimization get followingBody failed",U),F.writable.abort(U);return}}j.pipeTo(F.writable).then(()=>L("doWithInitialOptimization followingBody transfered"),U=>L("doWithInitialOptimization followingBody transfer failed",U))}),j=>v(this,null,function*(){L("doWithInitialOptimization initialBody transfer failed",j)})),F.readable})(),b=C.totalSize,y=new Headers(m.headers);if(y.delete("Content-Range"),y.delete("Content-Length"),c==null)return b!=null&&y.set("Content-Length",b+""),new re(g,{status:200,statusText:"OK",headers:y,underlayer:m.underlayer});const S=(H=c.start)!=null?H:0,D=c.end!=null?c.end:b!=null?b-1:null;return D!=null&&y.set("Content-Length",D-S+1+""),y.set("Content-Range",rt({start:S,end:D,totalSize:b})),new re(g,{status:206,statusText:"Partial Content",headers:y,underlayer:m.underlayer})})}}function ks(r,e,t){return v(this,null,function*(){const n=new Headers(e);n.delete("Range");const s=yield t(new V,new ue(r,{method:"HEAD",headers:n}));return ce(s.headers)})}function Ls(r){return[wt,oe,on,pt,ve,de].some(e=>r instanceof e)}class Ms{constructor(){R(this,"locked",!1);R(this,"waitings",[]);this.unlock=this.unlock.bind(this)}lock(){return v(this,null,function*(){return this.locked?(yield new Promise(e=>{this.waitings.push(e)}),this.unlock):(this.locked=!0,this.unlock)})}unlock(){if(this.waitings.length===0){this.locked=!1;return}this.waitings.shift()()}runExclusive(e){return v(this,null,function*(){const t=yield this.lock();try{return yield e()}catch(n){throw n}finally{t()}})}}function Ps(){var s,o;const{os:r,device:e,browser:t}=rn(navigator.userAgent);let n;return typeof window!="undefined"?n=window.location:typeof self!==void 0&&(n=self.location),{os:`${r.name}_${r.version}`,browser:`${t.name}_${t.version}`,app:(s=n==null?void 0:n.host)!=null?s:"",sdk:`Web SDK v${vt}`,dev_model:(o=e.model)!=null?o:"",dev_id:""}}const yt=200,Rt=X("log"),Bs=te("log");class Rn{constructor(e,t=self.fetch,n=100,s=3){R(this,"env",Ge(Ps()));R(this,"flushMutex",new Ms);R(this,"buffer",[]);this.appInfo=e,this.fetch=t,this.flushNum=n,this.flushWait=s}callApiLog(e,t=3,n=2e3){return v(this,null,function*(){const s=Is(e),o=s.map(h=>h.schema).join(","),i=`${Yn}/v1/log/${o}`,a=Je({appID:this.appInfo.appID,appSalt:this.appInfo.appSalt,path:i}),u={method:"POST",headers:{Authorization:a,"Content-Type":"text/csv","X-Env":this.env},body:Os(s)},c=this.fetch;for(let h=1;h<=t;h++)try{const p=yield c(new Request(i,u));if(p.ok)return;throw new Error(`Unexpected response status: ${p.status} ${p.statusText}`)}catch(p){const l=h<t;Bs("Call log API failed:",p,l?`Retry after ${n}ms`:""),l&&(yield tr(n))}})}flush(){return this.flushMutex.runExclusive(()=>{const e=this.buffer.splice(0);if(e.length===0)return;const t=Math.ceil(e.length/yt);return Promise.all(Array.from({length:t}).map((n,s)=>this.callApiLog(e.slice(s*yt,(s+1)*yt))))})}tryFlush(){return v(this,null,function*(){const e=yield this.flushMutex.runExclusive(()=>{const t=this.buffer;if(t.length===0)return!1;if(t.length>=this.flushNum)return Rt("buffer.length >= this.flushNum"),!0;const n=Date.now()-t[0].log.ts;return n>=this.flushWait*1e3?(Rt("waited >= this.flushWait"),!0):this.flushWait*1e3-n});if(e===!0)return this.flush();typeof e=="number"&&setTimeout(()=>this.tryFlush(),e)})}log(e,t){Rt("log",e,t),this.buffer.push({schema:e,log:x({ts:Date.now()},t)}),this.tryFlush()}}function Is(r){const e=[];return r.forEach(({schema:t,log:n})=>{let s=e.find(o=>o.schema===t);s==null&&(s={schema:t,logs:[]},e.push(s)),s.logs.push(n)}),e}function Os(r){return r.map(e=>e.logs).map(Ns).join(`

`)}function Ns(r){const e=Object.keys(r[0]),t=["ts",...e.filter(o=>o!=="ts")],n=t.map(Sn).join(","),s=r.map(o=>t.map(i=>o[i]).map(i=>i!=null?i+"":"").map(Sn).join(","));return[n,...s].join(`
`)}function Sn(r){let e=r.replace(/"/g,'""');return/("|,|\n)/.test(e)&&(e='"'+e+'"'),e}class zs{constructor(e){this.logger=e}log(e){return this.logger.log("LiveScheduleLog",e)}}const Us=new URL(Ve).hostname;function Hs(r,e,t,n){return v(this,null,function*(){var l,f;const s=new zs(n),o={url:e,cip:""},i=Je(W(x({},t),{path:Ve})),a=Date.now();let u,c=null,h=null,p=null;try{if(c=yield fetch(Ve,{method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json",Authorization:i}}),h=Date.now(),!c.ok)throw new Error(`Call Schedule API failed, status: ${c.status} ${c.statusText}`);return p=yield c.json()}catch(d){throw u=d}finally{const d=O(Date.now(),a),w=p==null?ne(u):{err_msg:"",err_desc:""};s.log(W(x({r_id:(l=c==null?void 0:c.headers.get("x-reqid"))!=null?l:"",ip:"",domain:Us,status_code:(f=c==null?void 0:c.status)!=null?f:-1},w),{t_conn:O(h,a),t_total:d,type:1}))}})}const Ce=X("dns"),St=te("dns"),$s=60,qs=60*1e3;class Ws{constructor(e,t,n=Hs,s=De){R(this,"scheduling",new Map);R(this,"cache",new Map);R(this,"m3u8SegmentCache",new Map);this.logger=e,this.app=t,this.scheduler=n,this.cacheUrl=s}getScheduleResult(e,t){return v(this,null,function*(){var i;const n=Date.now();let s;try{s=yield this.scheduler(e,t,this.app,this.logger)}catch(a){throw St("Live schedule failed:",a),new wt(a)}finally{e.set("dnsResolveTotalTime",O(Date.now(),n))}if(s.code===1)throw new oe(`Local DNS for ${t}`);if(s.code!==0)throw new Error(`Unexpected schedule code: ${s.code}`);const o=(i=s.ttl)!=null?i:$s;return{nodes:s.hosts.map(a=>{const[u,c]=rr(a,0),[h,p]=["",0];return{addr:{ip:h,host:u,http:c+80,https:c+443,how:p},after:0}}),expireAt:Date.now()+o*1e3,ttl:o}})}saveM3u8SegmentResult(e,t){return v(this,null,function*(){const n=this.cacheUrl(e),s=this.cache.get(n);if(s==null){St("No schedule result for m3u8:",e);return}const o=t.map(this.cacheUrl);o.forEach(i=>{this.m3u8SegmentCache.set(i,s)}),setTimeout(()=>{o.forEach(i=>{this.m3u8SegmentCache.delete(i)})},6e4)})}schedule(e,t){return v(this,null,function*(){const n=this.cacheUrl(t);if(!ke(t)&&!Wt(t)){const a=this.m3u8SegmentCache.get(n);if(a==null)throw new oe("Neither m3u8 / flv URL, or m3u8 segment URL");return a}const s=this.cache.get(n);if(s!=null&&Ct(s))return e.set("dnsResolveFromCache",!0),s;const o=this.scheduling.get(n);if(o!=null){let a;try{a=yield o}catch(u){if(u instanceof oe)throw u}if(a!=null&&Ct(a))return e.set("dnsResolveFromCache",!0),a;this.scheduling.delete(n)}const i=this.getScheduleResult(e,t);return Ce("save scheduling for",t),this.scheduling.set(n,i),i.then(a=>{Ce("save cache for",t),this.cache.set(n,a)},()=>{}),i})}hasResult(e){const t=this.cacheUrl(e),n=ke(e)||Wt(e)?this.cache.get(t):this.m3u8SegmentCache.get(t);return n!=null&&Ct(n)}do(e,t,n,s){return v(this,null,function*(){let o;Ce("schedule for",t);const i=yield this.schedule(e,t);Ce("scheduled for",t);for(let a=0;a<n;a++){const u=Fs(i.nodes);if(u==null)break;try{Ce("do job with",u,t),yield s(u.addr),i.expireAt=Date.now()+i.ttl*1e3;return}catch(c){if(St("do job with",u.addr,"failed:",c,t),o=c,se(c))break;Be(c)&&(u.after=Date.now()+qs)}}throw o=se(o)?o:new pt(o),o})}}function Cn(r,e=Date.now()){return r.after<e}function Fs(r){for(const e of r)if(Cn(e))return e;return null}function Ct(r){const e=Date.now();return r.expireAt<=e?!1:r.nodes.some(t=>Cn(t,e))}const fe=X("utils/fetch");function xn(r){return v(this,null,function*(){var f,d;const e=yield fetch(r),t=ot(r.headers);if(t==null||e.status!==206||e.body==null)return e;const{body:n,status:s,statusText:o,headers:i}=e,a=(f=nt(i))==null?void 0:f.end,u=100;let c=(d=t.start)!=null?d:0,h=n.getReader(),p=null;const l=new ReadableStream({pull:w=>v(this,null,function*(){p!=null&&(clearTimeout(p),p=null),h==null&&(fe("resume on pull"),r.headers.set("range",be(W(x({},t),{start:c}))),h=(yield fetch(r)).body.getReader());const{value:m,done:C}=yield h.read();if(C){fe("read done"),w.close();return}try{w.enqueue(m)}catch(g){fe("enqueue failed:",g),h==null||h.cancel("target stream enqueue failed");return}if(c+=m.byteLength,a!=null&&c>a){fe("all enqueued"),h.cancel("all enqueued"),w.close();return}p=setTimeout(()=>v(this,null,function*(){p=null,h!=null&&(fe("cancel after long time no pull"),h.cancel("long time no read"),h=null)}),u)}),cancel:w=>{fe("cancel",w),h==null||h.cancel(w)}});return new Response(l,{status:s,statusText:o,headers:i})})}class En{constructor(e){this.logger=e}start(e,t){let n;const s=Date.now(),o=u=>{var f,d,w,m,C,g,b,y,S,D,B;const c=t.headers.get("Range"),h=c==null?null:Zt(c),p=n==null?void 0:n.headers.get("X-M-Reqid"),l=p?p.split(", ").pop():"";this.log(x({ip:(f=e.get("downloadReqIP"))!=null?f:"",domain:(d=e.get("taskDomain"))!=null?d:"",range_st:(w=h==null?void 0:h.start)!=null?w:-1,range_end:(m=h==null?void 0:h.end)!=null?m:-1,retry:(C=e.get("downloadRetryCount"))!=null?C:0,ftask_id:(g=e.get("downloadFileTaskID"))!=null?g:"",task_id:(b=e.get("taskID"))!=null?b:"",d_id:(y=e.get("doID"))!=null?y:"",ts_st:s,r_id:l,elt_id:(S=e.get("downloadEltID"))!=null?S:"",status_code:(D=n==null?void 0:n.status)!=null?D:-1,t_req_msg:O(e.get("downloadReqMessageAt"),s),t_conn:O(e.get("downloadConnectionAt"),(B=e.get("downloadReqMessageAt"))!=null?B:s),t_tls:-1,t_st_trans:O(e.get("downloadStartTransferAt"),e.get("downloadConnectionAt")),t_resp_msg:O(e.get("downloadRespMessageAt"),e.get("downloadStartTransferAt")),err_msg:"",err_desc:"",t_content_trans:-1,t_total:-1,resp_size:-1},u))};return{onError:u=>{const c=Date.now();o(x({t_total:O(c,s)},ne(u)))},onResponse:u=>{n=u,n.bodyReadResult.then(c=>{var l;const h=Date.now(),p=c.success?null:ne(c.error);o(x({t_content_trans:O(h,(l=e.get("downloadRespMessageAt"))!=null?l:e.get("downloadStartTransferAt")),t_total:O(h,s),resp_size:c.size},p))})}}}wrap(e,t,n){return v(this,null,function*(){const s=this.start(e,t);try{const o=yield n();return s.onResponse(o),o}catch(o){throw s.onError(o),o}})}log(e){return this.logger.log("DownloadLog",e)}}class js{constructor(e){R(this,"downloadLogger");this.downloadLogger=new En(e)}fetch(e,t,n=!0,s=!0){return v(this,null,function*(){return this.downloadLogger.wrap(e,t,()=>v(this,null,function*(){const h=t,{url:o}=h,i=Ot(h,["url"]),a=new Request(o,x(x(x({},n?_n:null),s?{cache:"no-store"}:null),i)),u=yield xn(a),c=Date.now();return e.set("downloadConnectionAt",c),e.set("downloadStartTransferAt",c),Pe(u)}))})}}const _n={mode:"cors",credentials:"omit"};class Tn{constructor(e,t=!0,n=xn){R(this,"downloadLogger");this.https=t,this.nativeFetch=n,this.downloadLogger=new En(e)}fetch(e,t,n){return v(this,null,function*(){return this.downloadLogger.wrap(e,t,()=>v(this,null,function*(){e.set("downloadReqIP",n.host);const s=this.nativeFetch,o=Ks(t,n,this.https),i=yield s(o),a=Date.now();return e.set("downloadConnectionAt",a),e.set("downloadStartTransferAt",a),Pe(i)}))})}dispose(){}}function Ks(r,e,t=!0){const{url:n,headers:s,method:o,signal:i}=r,a=new URL(n),u=a.host,c=new Headers(s);a.protocol=t?"https:":"http:",a.host=`${e.host}:${t?e.https:e.http}`,a.pathname=`/${u}${a.pathname}`;let h=a.toString();const p="no-store";if(c.has("X-Miku-Agent")){const l=c.get("X-Miku-Agent");c.delete("X-Miku-Agent");const f=h.includes("?")?"&":"?",d=["X-Miku-Agent",l].map(encodeURIComponent).join("=");h=h+f+d}return new Request(h,W(x({},_n),{cache:p,headers:c,method:o,signal:i}))}function Vs(r){const e=[],t=r.split(`
`).map(s=>s.trim()).filter(s=>s.length>0);if(t[0]!=="#EXTM3U")throw new Error("Invalid Extended M3U Playlist");let n=null;for(const s of t){if(s.startsWith("#")){s.startsWith("#EXTINF:")&&(n=s);continue}n!=null&&(e.push({uri:s}),n=null)}return e}const An=X("client"),xt=te("client");class Gs{constructor(e,t){R(this,"fileTasks",new Map);R(this,"cache");R(this,"cdnResolver");R(this,"liveResolver");R(this,"nativeHttpClient");R(this,"http");R(this,"liveHttp");R(this,"patterns");R(this,"logger");var i,a,u,c,h;this.config=t,t!=null&&t.debug&&je(),this.cache=new as(t==null?void 0:t.cache),this.logger=(i=t==null?void 0:t.logger)!=null?i:new Rn(e),this.cdnResolver=(a=t==null?void 0:t.resolver)!=null?a:new ln(this.logger,e,t==null?void 0:t.dnsResolver,t==null?void 0:t.cacheUrl),this.liveResolver=(u=t==null?void 0:t.liveResolver)!=null?u:new Ws(this.logger,e,t==null?void 0:t.scheduler),this.nativeHttpClient=new js(this.logger);const n=(c=t==null?void 0:t.httpClient)!=null?c:new Tn(this.logger),s=(h=t==null?void 0:t.liveHttpClient)!=null?h:new Tn(this.logger);this.patterns=x(x({},Qe),t==null?void 0:t.patterns),this.http=new fn(this.logger,n,this.cdnResolver,6e3);const o=2e3;this.liveHttp=new fn(this.logger,s,this.liveResolver,o)}prepare(e){return v(this,null,function*(){return Promise.all(e.map(t=>this.cdnResolver.resolveDomain(new V,t))).catch(t=>{xt("prepare failed:",t)})})}createTask(e,t){const n=e.indexOf("#");return n>=0&&(e=e.slice(0,n)),new wn(e,t!=null?t:null,this.logger,(s,o)=>(s.set("taskType",1),this.startTask(s,o)))}createLiveTask(e,t){const n=e.indexOf("#");return n>=0&&(e=e.slice(0,n)),new wn(e,t!=null?t:null,this.logger,(s,o)=>(s.set("taskType",2),this.startLiveTask(s,o)))}startTask(e,t){return v(this,null,function*(){const n=new URL(t.url).hostname,s=yield this.cdnResolver.getCacheKey(t.url,n);let o=this.fileTasks.get(s);if(o==null){const i=()=>v(this,null,function*(){var u;const a=yield this.cdnResolver.getMediaOptimization(n);return x(x(x({},Ts),a),(u=this.config)==null?void 0:u.mediaOptimization)});o=new As(this.cache,this.nativeHttpClient,this.http,s,t.url,this.patterns,i),this.fileTasks.set(s,o)}return o.startTask(e,t)})}saveM3u8SegmentResult(e,t){return v(this,null,function*(){const n=yield Er(t),o=Vs(n).map(i=>sr(i.uri,e));An("saveM3u8SegmentResult",De(e),o.map(De)),yield this.liveResolver.saveM3u8SegmentResult(e,o)})}startLiveTask(e,t){return v(this,null,function*(){var c,h;const n={};t.range!=null&&(n.Range=be({start:t.range.start,end:t.range.end==null?null:t.range.end-1}));const s=new ue(t.url,{method:"GET",headers:n,signal:t.signal});let o,a=((h=(c=this.config)==null?void 0:c.liveOptimization)!=null?h:!0)&&ke(t.url)&&!this.liveResolver.hasResult(t.url);if(a){An("use nativeClient for",t.url);const p=this.nativeHttpClient.fetch(e,s);this.liveHttp.do(new V(e),s).catch(l=>{xt("do failed when prefetch for liveOptimization:",l)}),o=yield p}else o=yield this.liveHttp.do(e,s);if(o.body==null)throw new Error("Body expected");if(o.status!==200&&o.status!==206)throw new Error(`Invalid response, status: ${o.status}`);let u=o.body;if(!a&&ut()&&ke(t.url)){const[p,l]=o.body.tee();this.saveM3u8SegmentResult(t.url,l).catch(f=>{xt("Save M3u8 segment cache failed:",t.url,f)}),u=p}return new pn(u,ce(o.headers),it(o.headers),o.headers.get("Content-Type"),o)})}dispose(){this.cache.dispose()}}function Qs(r){return r&&r.mikuDeliveryProxy===!0}const Xs="md_download_url",Ys="md_download_filename";function Zs(r,e,t){return Ut(r,{[Xs]:e,[Ys]:t})}const Js="MIKU_DELIVERY_PROXY_CONFIG";function eo(r,e){const t=s=>s==null?void 0:s.map(o=>({source:o.source,flags:o.flags})),n=W(x({},e),{patterns:e.patterns==null?void 0:Jn(e.patterns,s=>t(s))});return Ut(r,{[Js]:JSON.stringify(n)})}function Dn(r){return Array.isArray(r)?{cdn:r,live:[]}:x({cdn:[],live:[]},r)}function to(r,e){const t=r.hostname;return e.includes("*")||e.includes(t)}function no(r){const e={},t=[];for(const{url:n,ecdn:s,fallback:o}of r){const i=new URL(n),a=i.hostname,u=qt(i.pathname);if(a!=="localhost"&&a.indexOf(".")<0||/\.qnqcdn\.net$/.test(a))continue;let c=e[a];c==null&&(e[a]=c={exts:[],total:0,ecdn:0,fallback:0}),c.exts.includes(u)||c.exts.push(u),c.total++,s&&c.ecdn++,o&&c.fallback++,$t(i,Qe)&&!t.includes(a)&&t.push(a)}return e}function ro(r,e){const t={};for(const{url:n,ecdn:s,size:o}of e){const i=new URL(n),a=i.hostname,u=qt(i.pathname);if(!(!r.includes(a)&&!r.includes("*")))for(const c of[`${a}/*`,`${a}/*.${u||"<none>"}`]){let h=t[c];h==null&&(t[c]=h={total:0,totalSize:0,ecdn:0,ecdnSize:0}),h.total++,h.totalSize+=o!=null?o:0,s&&(h.ecdn++,h.ecdnSize+=o!=null?o:0)}}return t}function so(r,e,t){return v(this,null,function*(){return r=eo(r,e),yield navigator.serviceWorker.register(r,t)})}function oo(){return v(this,null,function*(){io()})}function io(){function r(e){var n;const t={mikuDeliveryProxy:!0,type:`window-${e}`};(n=navigator.serviceWorker.controller)==null||n.postMessage(t)}r("available"),window.addEventListener("pageshow",()=>r("available")),window.addEventListener("pagehide",()=>r("unavailable")),window.addEventListener("beforeunload",()=>r("unavailable"))}function ao(r,e){navigator.serviceWorker.addEventListener("message",({data:t})=>{if(!Qs(t)||t.type!=="window-fetch-items")return;const n=no(t.items),s=Dn(r.domains),o=ro([...s.cdn,...s.live],t.items);e(n,o)}),window.addEventListener("load",()=>{setTimeout(()=>{var n;const t={mikuDeliveryProxy:!0,type:"get-window-fetch-items"};(n=navigator.serviceWorker.controller)==null||n.postMessage(t)},1e3)})}function lo(r,e,t){return v(this,null,function*(){const n=co();if(n!=null){console.warn("Ability not OK for Miku Delivery Proxy API:",n);return}e.debug&&je(),e.anchorDownload&&Dr()&&(console.warn("AnchorDownload Proxy is not supported in Mobile Browsers for compatibility reasons."),e=W(x({},e),{anchorDownload:!1}));function s(i){const a=[];if(e.anchorDownload){const{cdn:u}=Dn(e.domains),c=x(x({},Qe),e.patterns);a.push(uo(i.scope,u,c))}return a}const o=so(r,e,t).then(i=>{var c,h;const a=(h=(c=i.installing)!=null?c:i.waiting)!=null?h:i.active;if(a==null)throw new Error("Service Worker not found");let u=[];a.state==="activated"&&(u=s(i)),a.onstatechange=()=>{a.state==="activated"&&(u=s(i)),a.state==="redundant"&&u.forEach(p=>p())}});yield Promise.all([oo(),o,rs(),jr()])})}function co(){return"serviceWorker"in navigator?null:"navigator.serviceWorker not available"}function uo(r,e,t){const n=s=>{if(s.target==null||s.defaultPrevented)return;const o=ho(s.target);if(o==null||!o.hasAttribute("download"))return;const{href:i,download:a}=o,u=new URL(i);if(to(u,e)&&$t(u,t)){s.preventDefault();const c=document.createElement("iframe");c.src=Zs(r,i,a),c.style.display="none",document.body.append(c),setTimeout(()=>{document.body.removeChild(c)},1e4)}};return document.body.addEventListener("click",n),()=>{document.body.removeEventListener("click",n)}}function ho(r){for(;r!=null&&r.tagName!=="BODY";){if(r.tagName==="A")return r;r=r.parentElement}return null}class kn extends Error{constructor(){super(...arguments);R(this,"name","MediaError")}}function we(r,e,t,n){return r.addEventListener(e,t,n),()=>r.removeEventListener(e,t)}function Et(r){return r.dataset.mikuId!=null?r.dataset.mikuId:r.dataset.mikuId=fo()}function fo(r=16){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",t=e.length;let n="";for(let s=0;s<r;s++)n+=e[Math.floor(Math.random()*t)];return n}const Ln="miku_load_media";function Mn(r,e){r.addEventListener(Ln,e,{once:!0})}function Pn(r){r.dispatchEvent(new Event(Ln))}function _t(r){if(r.error==null)return"";const{code:e,message:t}=r.error;return t?`Error ${e}; details: ${t}`:`Error ${e}`}class wo{constructor(e){this.logger=e}log(e){return this.logger.log("ResolveSrcLog",e)}}class po{constructor(e){this.logger=e}log(e){return this.logger.log("ApplyResolvedLog",e)}}function Bn(r,e){const t=new URL(r),n=t.host;t.protocol="https:",t.host=`${e.host}:${e.https}`,t.pathname=`/${n}${t.pathname}`;let s=t.toString();const o=s.includes("?")?"&":"?",i=["X-Miku-Agent",`miku-delivery-web/v${vt}`].map(encodeURIComponent).join("=");return s=s+o+i,s}function In(r,e,t,n,s){return v(this,null,function*(){var l;const o=Te(),i=new V,a=new wo(e),u=new po(e),c=Date.now();let h=null,p=-1;try{yield t.do(i,n,2,f=>v(this,null,function*(){p++;const d=Date.now(),w=i.get("downloadEltID");let m=null;try{yield s(f)}catch(C){throw m=C,C}finally{const C=Date.now();u.log(x({m_id:r,r_id:o,retry:p,elt_id:w!=null?w:"",t_total:O(C,d),err_msg:"",err_desc:""},m!=null&&ne(m)))}}))}catch(f){throw h=f,f}finally{const f=Date.now();a.log(x({id:o,m_id:r,ts_st:c,t_lookup:(l=i.get("dnsResolveTotalTime"))!=null?l:-1,t_total:O(f,c),err_msg:"",err_desc:""},h!=null&&ne(h)))}})}class On{constructor(e){this.logger=e}log(e,t,n="",s=""){const o={m_id:Et(e),m_type:e.tagName.toLowerCase(),m_url:e.src,type:t,err_msg:n,err_desc:s};this.logger.log("MediaEventLog",o)}}const Tt=er();function mo(r){return v(this,null,function*(){r.debug&&je();const{app:e,domains:t}=r,n=new Rn(e),s=new ln(n,e);Tt.resolve({domains:t,logger:n,resolver:s}),yield Promise.all(t.map(o=>s.resolveDomain(new V,o))).catch(o=>{console.warn("resolve domains failed:",o)})})}function Nn(r,e){if(!r||!/^https?:\/\//.test(r))return!1;const n=new URL(r).hostname;return e.includes(n)}function go(r,e){if(r instanceof HTMLMediaElement)return vo(r,e);if(r instanceof HTMLImageElement)return bo(r,e);throw new Error("mikuDelivery.loadMedia() only works for video/audio/image elements")}function vo(r,e){return v(this,null,function*(){r.dataset.src=e,Pn(r);const{resolver:t,domains:n,logger:s}=yield Tt.promise;if(!Nn(e,n)){r.src!==e&&(r.src=e,r.load());return}r.hasChildNodes()&&r.childNodes.forEach(p=>{p.nodeName.toLowerCase()==="source"&&r.removeChild(p)});const o=new On(s),i=[];Mn(r,()=>{i.forEach(p=>p())});let a=null,u=null,c=null;i.push(we(r,"error",p=>{a==null||a(p)})),i.push(we(r,"loadedmetadata",p=>{u==null||u(p)})),i.push(we(r,"loadstart",p=>{c==null||c(p)}));function h(p=!1){const l=r.currentTime,f=r.paused;r.src=e,p&&(r.currentTime=l,f||i.push(we(r,"canplay",()=>{r.play()},{once:!0}))),c=null,u=()=>o.log(r,"loadedmetadata"),a=()=>o.log(r,"error","MediaError",_t(r)),r.load()}try{yield In(Et(r),s,t,e,p=>v(this,null,function*(){const l=Bn(e,p);r.src=l;const f=new Promise((w,m)=>{u=()=>{o.log(r,"loadedmetadata"),w()},a=()=>{const C=_t(r)||"Load media metadata failed";o.log(r,"error","MediaError",C),m(new kn(C))}}),d=new Promise(w=>{c=()=>w()}).then(()=>Ae(8e3,"Load media metadata"));return r.load(),Promise.race([f,d]).then(()=>{c=null,u=null,a=()=>{const w=_t(r)||"Media error after metadata loaded";console.warn(`Media error with src (${l}), fallback for:`,w),o.log(r,"error","MediaError",w),h(!0)}})}))}catch(p){console.warn("media fallback for:",p),h()}})}function bo(r,e){return v(this,null,function*(){r.dataset.src=e,Pn(r);const{resolver:t,domains:n,logger:s}=yield Tt.promise;if(!Nn(e,n)){r.src=e;return}const o=new On(s),i=[];Mn(r,()=>{i.forEach(c=>c())});let a=null,u=null;i.push(we(r,"error",c=>{a==null||a(c)})),i.push(we(r,"load",c=>{u==null||u(c)}));try{yield In(Et(r),s,t,e,c=>v(this,null,function*(){const h=Bn(e,c),p=new Promise((l,f)=>{r.src=h,u=()=>{o.log(r,"load"),l()},a=()=>{o.log(r,"error","MediaError",""),f(new kn)}});return Promise.race([p,Ae(8e3,"Load image")])}))}catch(c){console.warn("image fallback for:",c),r.src=e,u=()=>o.log(r,"load"),a=()=>o.log(r,"error","MediaError","")}})}return A.Client=Gs,A.initMediaLoader=mo,A.initProxy=lo,A.listenStatistics=ao,A.loadMedia=go,Object.defineProperties(A,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}}),A}({});
