var mikuDelivery=function(A){"use strict";var Co=Object.defineProperty,xo=Object.defineProperties;var Eo=Object.getOwnPropertyDescriptors;var qe=Object.getOwnPropertySymbols;var Gn=Object.prototype.hasOwnProperty,Qn=Object.prototype.propertyIsEnumerable;var It=(A,I,P)=>I in A?Co(A,I,{enumerable:!0,configurable:!0,writable:!0,value:P}):A[I]=P,C=(A,I)=>{for(var P in I||(I={}))Gn.call(I,P)&&It(A,P,I[P]);if(qe)for(var P of qe(I))Qn.call(I,P)&&It(A,P,I[P]);return A},W=(A,I)=>xo(A,Eo(I));var Ot=(A,I)=>{var P={};for(var $ in A)Gn.call(A,$)&&I.indexOf($)<0&&(P[$]=A[$]);if(A!=null&&qe)for(var $ of qe(A))I.indexOf($)<0&&Qn.call(A,$)&&(P[$]=A[$]);return P};var R=(A,I,P)=>(It(A,typeof I!="symbol"?I+"":I,P),P);var v=(A,I,P)=>new Promise(($,le)=>{var We=J=>{try{me(P.next(J))}catch(ge){le(ge)}},Fe=J=>{try{me(P.throw(J))}catch(ge){le(ge)}},me=J=>J.done?$(J.value):Promise.resolve(J.value).then(We,Fe);me((P=P.apply(A,I)).next())});function I(r){const e=[],t=r.length;for(let n=0;n<t;n++){let s=r.charCodeAt(n);if(s>=55296&&s<=56319&&t>n+1){const o=r.charCodeAt(n+1);o>=56320&&o<=57343&&(s=(s-55296)*1024+o-56320+65536,n+=1)}if(s<128){e.push(s);continue}if(s<2048){e.push(s>>6|192),e.push(s&63|128);continue}if(s<55296||s>=57344&&s<65536){e.push(s>>12|224),e.push(s>>6&63|128),e.push(s&63|128);continue}if(s>=65536&&s<=1114111){e.push(s>>18|240),e.push(s>>12&63|128),e.push(s>>6&63|128),e.push(s&63|128);continue}e.push(239,191,189)}return new Uint8Array(e).buffer}function P(r){return r^=r>>>16,r=Math.imul(r,2246822507),r^=r>>>13,r=Math.imul(r,3266489909),r^=r>>>16,r>>>0}const $=new Uint32Array([3432918353,461845907]);function le(r,e){return r<<e|r>>>32-e}function We(r,e){const t=r.byteLength/4|0,n=new Uint32Array(r,0,t);for(let s=0;s<t;s++)n[s]=Math.imul(n[s],$[0]),n[s]=le(n[s],15),n[s]=Math.imul(n[s],$[1]),e[0]=e[0]^n[s],e[0]=le(e[0],13),e[0]=Math.imul(e[0],5)+3864292196}function Fe(r,e){const t=r.byteLength/4|0,n=r.byteLength%4;let s=0;const o=new Uint8Array(r,t*4,n);switch(n){case 3:s=s^o[2]<<16;case 2:s=s^o[1]<<8;case 1:s=s^o[0]<<0,s=Math.imul(s,$[0]),s=le(s,15),s=Math.imul(s,$[1]),e[0]=e[0]^s}}function me(r,e){e[0]=e[0]^r.byteLength,e[0]=P(e[0])}function J(r,e){if(e=e?e|0:0,typeof r=="string"&&(r=I(r)),!(r instanceof ArrayBuffer))throw new TypeError("Expected key to be ArrayBuffer or string");const t=new Uint32Array([e]);return We(r,t),Fe(r,t),me(r,t),t.buffer}class ge{constructor(e=Xn){R(this,"circle",new Map);R(this,"members",new Set);R(this,"membersReplicas",new Map);R(this,"sortedHashes",[]);this.hasher=e}updateSortedHashes(){this.sortedHashes=[...this.circle.keys()].sort((e,t)=>e-t)}_add({key:e,replicas:t}){for(let n=0;n<t;n++){const s=this.hasher(Nt(e,n));this.circle.set(s,e)}this.members.add(e),this.membersReplicas.set(e,t)}_remove({key:e,replicas:t}){for(let n=0;n<t;n++){const s=this.hasher(Nt(e,n));this.circle.delete(s)}this.members.delete(e),this.membersReplicas.delete(e)}search(e){const t=this.sortedHashes.findIndex(n=>n>e);return t<0?0:t}get(e){if(this.members.size===0)return null;const t=this.hasher(e),n=this.search(t),s=this.sortedHashes[n];return this.circle.get(s)}getN(e,t,n){const s=n?n.size:this.members.size;if(s===0||t===0)return[];t>s&&(t=s);const o=this.hasher(e),i=this.search(o),a=[];for(let u=i;;u++){u>=this.sortedHashes.length&&(u=0);const l=this.sortedHashes[u],h=this.circle.get(l);if(!a.includes(h)&&(!n||n.has(h))&&(a.push(h),a.length>=t))return a}}add(e,t){return this.members.has(e)?!1:(this._add({key:e,replicas:t}),this.updateSortedHashes(),!0)}remove(e){if(!this.members.has(e))return!1;const t=this.membersReplicas.get(e);return this._remove({key:e,replicas:t}),this.updateSortedHashes(),!0}set(e){this.circle.clear(),this.members.clear(),this.membersReplicas.clear(),e.forEach(t=>{this._add(t)}),this.updateSortedHashes()}}function Nt(r,e){return e+r}const Xn=Yn;function Yn(r){const e=J(r);return new Uint32Array(e)[0]}class V{constructor(e){R(this,"value");this.value=e!=null?C({},e.value):{}}set(e,t){this.value[e]=t}get(e){return this.value[e]}}let zt=!1;function X(r){return(...e)=>{zt&&console.debug(`[${r}] [${(Date.now()/1e3).toFixed(3)}]`,...e)}}function je(){zt=!0}function te(r){return(...e)=>{console.warn(`[${r}] [${(Date.now()/1e3).toFixed(3)}]`,...e)}}const Ke="https://api.qiniudns.com/v1/resolve",Zn="https://api.qiniudns.com",Ve="https://pili-zeus.qiniuapi.com/v1/scheduling";function Jn(r){r[0]==="?"&&(r=r.slice(1));const e={};return r.split("&").forEach(t=>{const[n,s]=t.split("=");e[decodeURIComponent(n)]=s==null?null:decodeURIComponent(s)}),e}function Ge(r){return Object.keys(r).map(e=>[e,r[e]]).filter(([e,t])=>t!==void 0).map(([e,t])=>t===null?encodeURIComponent(e):[e,t].map(encodeURIComponent).join("=")).join("&")}function Ut(r,e){const t=new URLSearchParams(e).toString(),n=r.includes("?")?"&":"?";return r+n+t}function Te(){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",e=r.length;let t="";for(let n=0;n<20;n++)t+=r[Math.floor(Math.random()*e)];return t}function er(r,e){const t={};return Object.keys(r).forEach(n=>{t[n]=e(r[n])}),t}function tr(){const r={resolve:void 0,reject:void 0,promise:void 0,status:"pending",value:null};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r.promise.then(e=>{r.value=e,r.status="resolved"},()=>{r.status="rejected"}),r}function nr(r){return new Promise(e=>setTimeout(e,r))}class Ht extends Error{constructor(){super(...arguments);R(this,"name","TimeoutError")}}function Ae(r,e){return new Promise((t,n)=>{setTimeout(()=>n(new Ht(e+" timeout")),r)})}function rr(r,e){e.aborted?r.abort(e.reason):e.addEventListener("abort",()=>{r.abort(e.reason)})}const Qe={image:[/\.(jpe?g|png|gif|webp|svg|bmp|ico|tiff|avif|svga)$/],media:[/\.(3gp|aac|flac|mpe?g|mp3|mp4|m4a|m4v|m4p|oga|ogg|ogv|wav|webm|mov)$/],live:[/\.(flv|m3u8|ts|m4s)$/],other:[]};function $t(r,e,t=["image","media","other"]){r.search="",r.hash="";const n=r.toString();return t.some(s=>{var o;return((o=e[s])!=null?o:[]).some(i=>i.test(n))})}function De(r){const e=new URL(r);return e.search="",e.hash="",e.toString()}function ne(r){return r instanceof Error?{err_msg:r.name,err_desc:r.message}:{err_msg:"Unknown",err_desc:r+""}}function O(r,e){return r==null||r===-1||e==null||e===-1?-1:(r-e)/1e3}function sr(r,e=80){const[t,n]=r.split(":"),s=n?parseInt(n,10):e;return[t,s]}function qt(r){const e=r.split("/"),t=e[e.length-1],n=t.lastIndexOf(".");return n>=0?t.slice(n+1):""}function or(r,e){return new URL(r,e).toString()}function ke(r){const[e]=r.split("?");return e.endsWith(".m3u8")}function Wt(r){const[e]=r.split("?");return e.endsWith(".flv")}var ee=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function ir(r){var e=r.default;if(typeof e=="function"){var t=function(){return e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var s=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:function(){return r[n]}})}),t}var Ft={exports:{}};function ar(r){throw new Error('Could not dynamically require "'+r+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Xe={exports:{}};const lr=ir(Object.freeze(Object.defineProperty({__proto__:null,default:{}},Symbol.toStringTag,{value:"Module"})));var jt;function Le(){return jt||(jt=1,function(r,e){(function(t,n){r.exports=n()})(ee,function(){var t=t||function(n,s){var o;if(typeof window!="undefined"&&window.crypto&&(o=window.crypto),typeof self!="undefined"&&self.crypto&&(o=self.crypto),typeof globalThis!="undefined"&&globalThis.crypto&&(o=globalThis.crypto),!o&&typeof window!="undefined"&&window.msCrypto&&(o=window.msCrypto),!o&&typeof ee!="undefined"&&ee.crypto&&(o=ee.crypto),!o&&typeof ar=="function")try{o=lr}catch(m){}var i=function(){if(o){if(typeof o.getRandomValues=="function")try{return o.getRandomValues(new Uint32Array(1))[0]}catch(m){}if(typeof o.randomBytes=="function")try{return o.randomBytes(4).readInt32LE()}catch(m){}}throw new Error("Native crypto module could not be used to get secure random number.")},a=Object.create||function(){function m(){}return function(b){var y;return m.prototype=b,y=new m,m.prototype=null,y}}(),u={},l=u.lib={},h=l.Base=function(){return{extend:function(m){var b=a(this);return m&&b.mixIn(m),(!b.hasOwnProperty("init")||this.init===b.init)&&(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var m=this.extend();return m.init.apply(m,arguments),m},init:function(){},mixIn:function(m){for(var b in m)m.hasOwnProperty(b)&&(this[b]=m[b]);m.hasOwnProperty("toString")&&(this.toString=m.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),p=l.WordArray=h.extend({init:function(m,b){m=this.words=m||[],b!=s?this.sigBytes=b:this.sigBytes=m.length*4},toString:function(m){return(m||f).stringify(this)},concat:function(m){var b=this.words,y=m.words,S=this.sigBytes,D=m.sigBytes;if(this.clamp(),S%4)for(var B=0;B<D;B++){var Y=y[B>>>2]>>>24-B%4*8&255;b[S+B>>>2]|=Y<<24-(S+B)%4*8}else for(var H=0;H<D;H+=4)b[S+H>>>2]=y[H>>>2];return this.sigBytes+=D,this},clamp:function(){var m=this.words,b=this.sigBytes;m[b>>>2]&=4294967295<<32-b%4*8,m.length=n.ceil(b/4)},clone:function(){var m=h.clone.call(this);return m.words=this.words.slice(0),m},random:function(m){for(var b=[],y=0;y<m;y+=4)b.push(i());return new p.init(b,m)}}),c=u.enc={},f=c.Hex={stringify:function(m){for(var b=m.words,y=m.sigBytes,S=[],D=0;D<y;D++){var B=b[D>>>2]>>>24-D%4*8&255;S.push((B>>>4).toString(16)),S.push((B&15).toString(16))}return S.join("")},parse:function(m){for(var b=m.length,y=[],S=0;S<b;S+=2)y[S>>>3]|=parseInt(m.substr(S,2),16)<<24-S%8*4;return new p.init(y,b/2)}},d=c.Latin1={stringify:function(m){for(var b=m.words,y=m.sigBytes,S=[],D=0;D<y;D++){var B=b[D>>>2]>>>24-D%4*8&255;S.push(String.fromCharCode(B))}return S.join("")},parse:function(m){for(var b=m.length,y=[],S=0;S<b;S++)y[S>>>2]|=(m.charCodeAt(S)&255)<<24-S%4*8;return new p.init(y,b)}},w=c.Utf8={stringify:function(m){try{return decodeURIComponent(escape(d.stringify(m)))}catch(b){throw new Error("Malformed UTF-8 data")}},parse:function(m){return d.parse(unescape(encodeURIComponent(m)))}},g=l.BufferedBlockAlgorithm=h.extend({reset:function(){this._data=new p.init,this._nDataBytes=0},_append:function(m){typeof m=="string"&&(m=w.parse(m)),this._data.concat(m),this._nDataBytes+=m.sigBytes},_process:function(m){var b,y=this._data,S=y.words,D=y.sigBytes,B=this.blockSize,Y=B*4,H=D/Y;m?H=n.ceil(H):H=n.max((H|0)-this._minBufferSize,0);var K=H*B,G=n.min(K*4,D);if(K){for(var z=0;z<K;z+=B)this._doProcessBlock(S,z);b=S.splice(0,K),y.sigBytes-=G}return new p.init(b,G)},clone:function(){var m=h.clone.call(this);return m._data=this._data.clone(),m},_minBufferSize:0});l.Hasher=g.extend({cfg:h.extend(),init:function(m){this.cfg=this.cfg.extend(m),this.reset()},reset:function(){g.reset.call(this),this._doReset()},update:function(m){return this._append(m),this._process(),this},finalize:function(m){m&&this._append(m);var b=this._doFinalize();return b},blockSize:16,_createHelper:function(m){return function(b,y){return new m.init(y).finalize(b)}},_createHmacHelper:function(m){return function(b,y){return new x.HMAC.init(m,y).finalize(b)}}});var x=u.algo={};return u}(Math);return t})}(Xe)),Xe.exports}var Ye={exports:{}},Kt;function cr(){return Kt||(Kt=1,function(r,e){(function(t,n){r.exports=n(Le())})(ee,function(t){return function(){var n=t,s=n.lib,o=s.WordArray,i=s.Hasher,a=n.algo,u=[],l=a.SHA1=i.extend({_doReset:function(){this._hash=new o.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(h,p){for(var c=this._hash.words,f=c[0],d=c[1],w=c[2],g=c[3],x=c[4],m=0;m<80;m++){if(m<16)u[m]=h[p+m]|0;else{var b=u[m-3]^u[m-8]^u[m-14]^u[m-16];u[m]=b<<1|b>>>31}var y=(f<<5|f>>>27)+x+u[m];m<20?y+=(d&w|~d&g)+1518500249:m<40?y+=(d^w^g)+1859775393:m<60?y+=(d&w|d&g|w&g)-1894007588:y+=(d^w^g)-899497514,x=g,g=w,w=d<<30|d>>>2,d=f,f=y}c[0]=c[0]+f|0,c[1]=c[1]+d|0,c[2]=c[2]+w|0,c[3]=c[3]+g|0,c[4]=c[4]+x|0},_doFinalize:function(){var h=this._data,p=h.words,c=this._nDataBytes*8,f=h.sigBytes*8;return p[f>>>5]|=128<<24-f%32,p[(f+64>>>9<<4)+14]=Math.floor(c/4294967296),p[(f+64>>>9<<4)+15]=c,h.sigBytes=p.length*4,this._process(),this._hash},clone:function(){var h=i.clone.call(this);return h._hash=this._hash.clone(),h}});n.SHA1=i._createHelper(l),n.HmacSHA1=i._createHmacHelper(l)}(),t.SHA1})}(Ye)),Ye.exports}var Ze={exports:{}},Vt;function ur(){return Vt||(Vt=1,function(r,e){(function(t,n){r.exports=n(Le())})(ee,function(t){(function(){var n=t,s=n.lib,o=s.Base,i=n.enc,a=i.Utf8,u=n.algo;u.HMAC=o.extend({init:function(l,h){l=this._hasher=new l.init,typeof h=="string"&&(h=a.parse(h));var p=l.blockSize,c=p*4;h.sigBytes>c&&(h=l.finalize(h)),h.clamp();for(var f=this._oKey=h.clone(),d=this._iKey=h.clone(),w=f.words,g=d.words,x=0;x<p;x++)w[x]^=1549556828,g[x]^=909522486;f.sigBytes=d.sigBytes=c,this.reset()},reset:function(){var l=this._hasher;l.reset(),l.update(this._iKey)},update:function(l){return this._hasher.update(l),this},finalize:function(l){var h=this._hasher,p=h.finalize(l);h.reset();var c=h.finalize(this._oKey.clone().concat(p));return c}})})()})}(Ze)),Ze.exports}(function(r,e){(function(t,n,s){r.exports=n(Le(),cr(),ur())})(ee,function(t){return t.HmacSHA1})})(Ft);const hr=Ft.exports;var Gt={exports:{}};(function(r,e){(function(t,n){r.exports=n(Le())})(ee,function(t){return function(){var n=t,s=n.lib,o=s.WordArray,i=n.enc;i.Base64={stringify:function(u){var l=u.words,h=u.sigBytes,p=this._map;u.clamp();for(var c=[],f=0;f<h;f+=3)for(var d=l[f>>>2]>>>24-f%4*8&255,w=l[f+1>>>2]>>>24-(f+1)%4*8&255,g=l[f+2>>>2]>>>24-(f+2)%4*8&255,x=d<<16|w<<8|g,m=0;m<4&&f+m*.75<h;m++)c.push(p.charAt(x>>>6*(3-m)&63));var b=p.charAt(64);if(b)for(;c.length%4;)c.push(b);return c.join("")},parse:function(u){var l=u.length,h=this._map,p=this._reverseMap;if(!p){p=this._reverseMap=[];for(var c=0;c<h.length;c++)p[h.charCodeAt(c)]=c}var f=h.charAt(64);if(f){var d=u.indexOf(f);d!==-1&&(l=d)}return a(u,l,p)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="};function a(u,l,h){for(var p=[],c=0,f=0;f<l;f++)if(f%4){var d=h[u.charCodeAt(f-1)]<<f%4*2,w=h[u.charCodeAt(f)]>>>6-f%4*2,g=d|w;p[c>>>2]|=g<<24-c%4*8,c++}return o.create(p,c)}}(),t.enc.Base64})})(Gt);const dr=Gt.exports;function fr(r){let e=r.query?`${r.path}?${r.query}
`:`${r.path}
`;return r.body&&(e+=r.body),e}function Je(r){let e;try{e=new URL(r.path).pathname}catch(a){e=r.path}let t=fr(W(C({},r),{path:e}));const o=hr(t,r.appSalt).toString(dr).replace(/\+/g,"-").replace(/\//g,"_");let i=`QApp ${r.appID}:${o}`;return i=i.replace(/\//g,"_"),i=i.replace(/\+/g,"-"),i}class wr{constructor(e){this.logger=e}log(e){return this.logger.log("DnsResolveLog",e)}}function pr(r){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",t=e.length;let n="";for(let s=0;s<r;s++)n+=e[Math.floor(Math.random()*t)];return n}const mr=new URL(Ke).hostname,gr=te("dns/httpdns");function vr(r,e,t,n){return v(this,null,function*(){var p,c;const s=new wr(n),o=Ge({name:e,type:"A",rid:pr(10)}),i=`${Ke}?${o}`,a=Je(W(C({},t),{path:Ke,query:o}));let u,l=null,h=null;try{if(l=yield fetch(i,{headers:{Authorization:a}}),!l.ok){const d=yield Rr(l);if(d==null)throw new Error(`Resolve failed, unexpected HTTP status: ${l.status}`);if(d.code==="NotSupportedArea")return{reason:"NotSupportedArea",ttl:300};throw new Error(`Resolve failed, code: ${d.code}, error: ${d.error}`)}return h=yield l.json()}catch(f){throw u=f}finally{const d=performance.getEntriesByName(i,"resource").pop();if(d==null)gr("Corresponding performance entry not found for",i);else{const w=h==null?ne(u):{err_msg:"",err_desc:""};s.log(W(C({r_id:(p=l==null?void 0:l.headers.get("x-reqid"))!=null?p:"",ip:"",domain:mr,status_code:(c=l==null?void 0:l.status)!=null?c:-1},w),{t_conn:(d.requestStart-d.connectStart)/1e3,t_total:(d.responseEnd-d.fetchStart)/1e3,type:1}))}}})}function et(r){return r.groups!=null}function br(r,e){return r.find(t=>new RegExp(t.pattern).test(e))}function yr(r){return Math.random()<r.servicerate}function Rr(r){return v(this,null,function*(){try{const e=yield r.json();if(e&&typeof e.code=="string"&&typeof e.error=="string")return e}catch(e){}return null})}function Qt(r){return v(this,null,function*(){yield Promise.all(r.map(e=>indexedDB.deleteDatabase(e)))})}class Xt{constructor(e,t){R(this,"db");this.dbName=e,this.storeConfigs=t}getDB(){return v(this,null,function*(){return this.db!=null?this.db:(this.db=yield new Promise(e=>{const t=indexedDB.open(this.dbName);t.addEventListener("upgradeneeded",()=>{for(const n of this.storeConfigs){const s=t.result.createObjectStore(n.name);for(const o of n.indexes)s.createIndex(o.name,o.keyPath)}}),e(Me(t))}),this.db)})}get(e,t){return v(this,null,function*(){const s=(yield this.getDB()).transaction(e,"readonly").objectStore(e).get(t);return Me(s)})}getAll(e){return v(this,null,function*(){const n=(yield this.getDB()).transaction(e,"readonly").objectStore(e).getAll();return Me(n)})}count(e){return v(this,null,function*(){const n=(yield this.getDB()).transaction(e,"readonly").objectStore(e).count();return Me(n)})}set(e,t,n){return v(this,null,function*(){const o=(yield this.getDB()).transaction(e,"readwrite");return o.objectStore(e).put(n,t),tt(o)})}remove(e,t){return v(this,null,function*(){const s=(yield this.getDB()).transaction(e,"readwrite");return s.objectStore(e).delete(t),tt(s)})}clear(){return v(this,null,function*(){const e=yield this.getDB();yield Promise.all(this.storeConfigs.map(({name:t})=>{const n=e.transaction(t,"readwrite");return n.objectStore(t).clear(),tt(n)}))})}walkBy(e,t,n){return v(this,null,function*(){const o=(yield this.getDB()).transaction(e,"readonly").objectStore(e).index(t).openCursor(void 0,"next");return new Promise((i,a)=>{o.addEventListener("error",()=>a(new ve(o.error))),o.addEventListener("success",()=>{const u=o.result;if(u==null){i();return}n(u.value,u.primaryKey),u.continue()})})})}dispose(){var e;(e=this.db)==null||e.close()}}class ve extends Error{constructor(t){super(t+"");R(this,"name","IndexedDBError");this.cause=t}}function Me(r){return new Promise((e,t)=>{r.addEventListener("success",()=>e(r.result)),r.addEventListener("error",()=>t(new ve(r.error)))})}function tt(r){return new Promise((e,t)=>{r.addEventListener("complete",()=>e()),r.addEventListener("error",()=>t(new ve(r.error))),r.addEventListener("abort",()=>t(new ve(r.error)))})}class Sr{constructor(){R(this,"map",new Map)}on(e,t){var o;const s=[...(o=this.map.get(e))!=null?o:[],t];return this.map.set(e,s),()=>this.off(e,t)}once(e,t){const n=this.on(e,s=>{n(),t(s)});return n}off(e,t){var o;const s=((o=this.map.get(e))!=null?o:[]).filter(i=>i!==t);this.map.set(e,s)}emit(...e){var o;const[t,n]=e;((o=this.map.get(t))!=null?o:[]).forEach(i=>{i(n)})}dispose(){this.map.clear()}}function ce(r){const e=r.get("Content-Length");return e?parseInt(e,10):null}function nt(r){const e=r.get("Content-Range");return e==null?null:Cr(e)}function Cr(r){const e=r.trim().toLowerCase(),[t,n]=e.split(/\s+/);if(t!=="bytes")throw new Error(`Unit must be bytes: ${r}`);const[s,o]=n.split("/"),i=o==="*"?null:st(o),[a,u]=(s.includes("-")?s.split("-"):[null,null]).map(l=>st(l));return{totalSize:i,start:a,end:u}}function rt(r){const e=r.start!=null&&r.end!=null?`${r.start}-${r.end}`:"*",t=r.totalSize==null?"*":r.totalSize+"";return`bytes ${e}/${t}`}function st(r){return r?Number(r):null}function ot(r){const e=r.get("Range");return e==null?null:Zt(e)}function Yt(r){return r.start===0&&r.end==null}function Zt(r){const e=r.trim().toLowerCase();if(!e.startsWith("bytes="))throw new Error(`Unit must be bytes: ${r}`);if(e.includes(","))throw new Error(`Multiple range: ${r}`);const[,t,n]=/(\d*)-(\d*)/.exec(e)||[];if(!t&&!n)throw new Error(`Invalid range values: ${r}`);if(!t)throw new Error("Suffix range not supported");const[s,o]=[t,n].map(i=>st(i));return{start:s,end:o}}function be(r){var e,t;return`bytes=${(e=r.start)!=null?e:0}-${(t=r.end)!=null?t:""}`}const xr=/[^\u0000-\u00ff]/;function Jt(r){return xr.test(r)?"REPLACED_BY_Miku_Delivery_SEE_utils_http_encodeHeaderValue":r}function Er(r){if(r instanceof Headers){const e={};r.forEach((t,n)=>{e[n]=Jt(t)}),r=e}if(Array.isArray(r)){const e={};r.forEach(([t,n])=>{e[n]=Jt(t)}),r=e}return new Headers(r)}function it(r){var t;const e=nt(r);return e!=null?(t=e.totalSize)!=null?t:null:ce(r)}const en=X("utils/stream"),tn=te("utils/stream");function _r(r){return v(this,null,function*(){const e=r.getReader();let t=new Uint8Array;for(;;){const{done:s,value:o}=yield e.read();if(s)break;t=new Uint8Array([...t,...o])}return new TextDecoder().decode(t)})}function at(r,e){var a;const t=r.getReader(),n=(a=e[0])!=null?a:0,s=e[1];let o=0;return new ReadableStream({pull:u=>v(this,null,function*(){let l,h;for(;;){const d=yield t.read();if(d.done){u.close();return}if(l=d.value,h=o+l.byteLength,h>n)break;o=h}let p=l;const c=n>o?n-o:0,f=s!=null&&s<h?s-o:void 0;(c!==0||f!==void 0)&&(p=l.slice(c,f)),u.enqueue(p),s!=null&&h>=s&&(t.cancel("Cancelled by slice for target range met"),u.close()),o=h}),cancel:u=>t.cancel(u)})}function Tr(r){let e=0;const t=new TransformStream({transform:(s,o)=>{e+=s.byteLength,o.enqueue(s)}}),n=r.pipeTo(t.writable).then(()=>({size:e,success:!0}),s=>({size:e,success:!1,error:s}));return[t.readable,n]}class nn extends Error{constructor(){super(...arguments);R(this,"name","SaveSlicedPieceError")}}function Ar(r,e,t,n){return v(this,null,function*(){const s=[];let o=e,i=[],a=0;function u(){return v(this,null,function*(){const l=o+a;en(`saveSlicedPiece [${o}, ${l}]`);try{yield n(new Blob(i),o,l)}catch(h){throw tn(`saveSlicedPiece [${o}, ${l}] failed`,h),new nn(`saveSlicedPiece [${o}, ${l}] failed`)}s.push([o,l]),en(`saveSlicedPiece [${o}, ${l}] finish`,s),o=l})}try{const l=r.getReader();for(;;){const{value:h,done:p}=yield l.read();if(p)break;i.push(h),a+=h.byteLength,a>=t&&(yield u(),i=[],a=0)}a>0&&(yield u())}catch(l){if(!(l instanceof nn)&&(tn("exception occurred while reading stream and save by pieces",l),a>0))try{yield u()}catch(h){}}return s})}function Dr(r){let e,t=!1;const n=new ReadableStream({start:a=>{e=a},cancel:()=>{t=!0}}),s=r.getReader();let o=!1;return{main:new ReadableStream({pull:a=>v(this,null,function*(){try{const{value:u,done:l}=yield s.read();if(o)return;if(l){a.close(),t||e.close();return}a.enqueue(u),t||e.enqueue(u)}catch(u){a.error(u),t||e.error(u)}}),cancel:a=>v(this,null,function*(){o=!0,yield s.cancel(a),e.error(a)})}),minor:n}}var lt={exports:{}};(function(r,e){(function(t,n){var s="1.0.2",o="",i="?",a="function",u="undefined",l="object",h="string",p="major",c="model",f="name",d="type",w="vendor",g="version",x="architecture",m="console",b="mobile",y="tablet",S="smarttv",D="wearable",B="embedded",Y=255,H="Amazon",K="Apple",G="ASUS",z="BlackBerry",q="Browser",F="Chrome",ae="Edge",j="Firefox",U="Google",Un="Huawei",At="LG",Dt="Microsoft",Hn="Motorola",ze="Opera",kt="Samsung",Lt="Sony",$n="Xiaomi",Mt="Zebra",qn="Facebook",yo=function(E,k){var _={};for(var N in E)k[N]&&k[N].length%2===0?_[N]=k[N].concat(E[N]):_[N]=E[N];return _},Ue=function(E){for(var k={},_=0;_<E.length;_++)k[E[_].toUpperCase()]=E[_];return k},Wn=function(E,k){return typeof E===h?xe(k).indexOf(xe(E))!==-1:!1},xe=function(E){return E.toLowerCase()},Ro=function(E){return typeof E===h?E.replace(/[^\d\.]/g,o).split(".")[0]:n},Pt=function(E,k){if(typeof E===h)return E=E.replace(/^\s\s*/,o).replace(/\s\s*$/,o),typeof k===u?E:E.substring(0,Y)},Ee=function(E,k){for(var _=0,N,T,$e,M,_e,Z;_<k.length&&!_e;){var Kn=k[_],Vn=k[_+1];for(N=T=0;N<Kn.length&&!_e;)if(_e=Kn[N++].exec(E),_e)for($e=0;$e<Vn.length;$e++)Z=_e[++T],M=Vn[$e],typeof M===l&&M.length>0?M.length===2?typeof M[1]==a?this[M[0]]=M[1].call(this,Z):this[M[0]]=M[1]:M.length===3?typeof M[1]===a&&!(M[1].exec&&M[1].test)?this[M[0]]=Z?M[1].call(this,Z,M[2]):n:this[M[0]]=Z?Z.replace(M[1],M[2]):n:M.length===4&&(this[M[0]]=Z?M[3].call(this,Z.replace(M[1],M[2])):n):this[M]=Z||n;_+=2}},Bt=function(E,k){for(var _ in k)if(typeof k[_]===l&&k[_].length>0){for(var N=0;N<k[_].length;N++)if(Wn(k[_][N],E))return _===i?n:_}else if(Wn(k[_],E))return _===i?n:_;return E},So={"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"},Fn={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},jn={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[g,[f,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[g,[f,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[f,g],[/opios[\/ ]+([\w\.]+)/i],[g,[f,ze+" Mini"]],[/\bopr\/([\w\.]+)/i],[g,[f,ze]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale|qqbrowserlite|qq)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[f,g],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[g,[f,"UC"+q]],[/\bqbcore\/([\w\.]+)/i],[g,[f,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[g,[f,"WeChat"]],[/konqueror\/([\w\.]+)/i],[g,[f,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[g,[f,"IE"]],[/yabrowser\/([\w\.]+)/i],[g,[f,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[f,/(.+)/,"$1 Secure "+q],g],[/\bfocus\/([\w\.]+)/i],[g,[f,j+" Focus"]],[/\bopt\/([\w\.]+)/i],[g,[f,ze+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[g,[f,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[g,[f,"Dolphin"]],[/coast\/([\w\.]+)/i],[g,[f,ze+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[g,[f,"MIUI "+q]],[/fxios\/([-\w\.]+)/i],[g,[f,j]],[/\bqihu|(qi?ho?o?|360)browser/i],[[f,"360 "+q]],[/(oculus|samsung|sailfish)browser\/([\w\.]+)/i],[[f,/(.+)/,"$1 "+q],g],[/(comodo_dragon)\/([\w\.]+)/i],[[f,/_/g," "],g],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[f,g],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i],[f],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[f,qn],g],[/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[f,g],[/\bgsa\/([\w\.]+) .*safari\//i],[g,[f,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[g,[f,F+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[f,F+" WebView"],g],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[g,[f,"Android "+q]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[f,g],[/version\/([\w\.]+) .*mobile\/\w+ (safari)/i],[g,[f,"Mobile Safari"]],[/version\/([\w\.]+) .*(mobile ?safari|safari)/i],[g,f],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[f,[g,Bt,So]],[/(webkit|khtml)\/([\w\.]+)/i],[f,g],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[f,"Netscape"],g],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[g,[f,j+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[f,g]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[x,"amd64"]],[/(ia32(?=;))/i],[[x,xe]],[/((?:i[346]|x)86)[;\)]/i],[[x,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[x,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[x,"armhf"]],[/windows (ce|mobile); ppc;/i],[[x,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[x,/ower/,o,xe]],[/(sun4\w)[;\)]/i],[[x,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[x,xe]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[pt]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[c,[w,kt],[d,y]],[/\b((?:s[cgp]h|gt|sm)-\w+|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[c,[w,kt],[d,b]],[/\((ip(?:hone|od)[\w ]*);/i],[c,[w,K],[d,b]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[c,[w,K],[d,y]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[c,[w,Un],[d,y]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}-[atu]?[ln][01259x][012359][an]?)\b(?!.+d\/s)/i],[c,[w,Un],[d,b]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[c,/_/g," "],[w,$n],[d,b]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[c,/_/g," "],[w,$n],[d,y]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[c,[w,"OPPO"],[d,b]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[c,[w,"Vivo"],[d,b]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[c,[w,"Realme"],[d,b]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[c,[w,Hn],[d,b]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[c,[w,Hn],[d,y]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[c,[w,At],[d,y]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[c,[w,At],[d,b]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[c,[w,"Lenovo"],[d,y]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[c,/_/g," "],[w,"Nokia"],[d,b]],[/(pixel c)\b/i],[c,[w,U],[d,y]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[c,[w,U],[d,b]],[/droid.+ ([c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[c,[w,Lt],[d,b]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[c,"Xperia Tablet"],[w,Lt],[d,y]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[c,[w,"OnePlus"],[d,b]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[c,[w,H],[d,y]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[c,/(.+)/g,"Fire Phone $1"],[w,H],[d,b]],[/(playbook);[-\w\),; ]+(rim)/i],[c,w,[d,y]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[c,[w,z],[d,b]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[c,[w,G],[d,y]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[c,[w,G],[d,b]],[/(nexus 9)/i],[c,[w,"HTC"],[d,y]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic|sony)[-_ ]?([-\w]*)/i],[w,[c,/_/g," "],[d,b]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[c,[w,"Acer"],[d,y]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[c,[w,"Meizu"],[d,b]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[c,[w,"Sharp"],[d,b]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[w,c,[d,b]],[/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[w,c,[d,y]],[/(surface duo)/i],[c,[w,Dt],[d,y]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[c,[w,"Fairphone"],[d,b]],[/(u304aa)/i],[c,[w,"AT&T"],[d,b]],[/\bsie-(\w*)/i],[c,[w,"Siemens"],[d,b]],[/\b(rct\w+) b/i],[c,[w,"RCA"],[d,y]],[/\b(venue[\d ]{2,7}) b/i],[c,[w,"Dell"],[d,y]],[/\b(q(?:mv|ta)\w+) b/i],[c,[w,"Verizon"],[d,y]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[c,[w,"Barnes & Noble"],[d,y]],[/\b(tm\d{3}\w+) b/i],[c,[w,"NuVision"],[d,y]],[/\b(k88) b/i],[c,[w,"ZTE"],[d,y]],[/\b(nx\d{3}j) b/i],[c,[w,"ZTE"],[d,b]],[/\b(gen\d{3}) b.+49h/i],[c,[w,"Swiss"],[d,b]],[/\b(zur\d{3}) b/i],[c,[w,"Swiss"],[d,y]],[/\b((zeki)?tb.*\b) b/i],[c,[w,"Zeki"],[d,y]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[w,"Dragon Touch"],c,[d,y]],[/\b(ns-?\w{0,9}) b/i],[c,[w,"Insignia"],[d,y]],[/\b((nxa|next)-?\w{0,9}) b/i],[c,[w,"NextBook"],[d,y]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[w,"Voice"],c,[d,b]],[/\b(lvtel\-)?(v1[12]) b/i],[[w,"LvTel"],c,[d,b]],[/\b(ph-1) /i],[c,[w,"Essential"],[d,b]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[c,[w,"Envizen"],[d,y]],[/\b(trio[-\w\. ]+) b/i],[c,[w,"MachSpeed"],[d,y]],[/\btu_(1491) b/i],[c,[w,"Rotor"],[d,y]],[/(shield[\w ]+) b/i],[c,[w,"Nvidia"],[d,y]],[/(sprint) (\w+)/i],[w,c,[d,b]],[/(kin\.[onetw]{3})/i],[[c,/\./g," "],[w,Dt],[d,b]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[c,[w,Mt],[d,y]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[c,[w,Mt],[d,b]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[w,c,[d,m]],[/droid.+; (shield) bui/i],[c,[w,"Nvidia"],[d,m]],[/(playstation [345portablevi]+)/i],[c,[w,Lt],[d,m]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[c,[w,Dt],[d,m]],[/smart-tv.+(samsung)/i],[w,[d,S]],[/hbbtv.+maple;(\d+)/i],[[c,/^/,"SmartTV"],[w,kt],[d,S]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[w,At],[d,S]],[/(apple) ?tv/i],[w,[c,K+" TV"],[d,S]],[/crkey/i],[[c,F+"cast"],[w,U],[d,S]],[/droid.+aft(\w)( bui|\))/i],[c,[w,H],[d,S]],[/\(dtv[\);].+(aquos)/i],[c,[w,"Sharp"],[d,S]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w ]*; *(\w[^;]*);([^;]*)/i],[[w,Pt],[c,Pt],[d,S]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[d,S]],[/((pebble))app/i],[w,c,[d,D]],[/droid.+; (glass) \d/i],[c,[w,U],[d,D]],[/droid.+; (wt63?0{2,3})\)/i],[c,[w,Mt],[d,D]],[/(quest( 2)?)/i],[c,[w,qn],[d,D]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[w,[d,B]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[c,[d,b]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[c,[d,y]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[d,y]],[/(phone|mobile(?:[;\/]| safari)|pda(?=.+windows ce))/i],[[d,b]],[/(android[-\w\. ]{0,9});.+buil/i],[c,[w,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[g,[f,ae+"HTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[g,[f,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[f,g],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[g,f]],os:[[/microsoft (windows) (vista|xp)/i],[f,g],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[f,[g,Bt,Fn]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[f,"Windows"],[g,Bt,Fn]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[g,/_/g,"."],[f,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[f,"Mac OS"],[g,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86)/i],[g,f],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[f,g],[/\(bb(10);/i],[g,[f,z]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[g,[f,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[g,[f,j+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[g,[f,"webOS"]],[/crkey\/([\d\.]+)/i],[g,[f,F+"cast"]],[/(cros) [\w]+ ([\w\.]+\w)/i],[[f,"Chromium OS"],g],[/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[f,g],[/(sunos) ?([\w\.\d]*)/i],[[f,"Solaris"],g],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[f,g]]},Q=function(E,k){if(typeof E===l&&(k=E,E=n),!(this instanceof Q))return new Q(E,k).getResult();var _=E||(typeof t!==u&&t.navigator&&t.navigator.userAgent?t.navigator.userAgent:o),N=k?yo(jn,k):jn;return this.getBrowser=function(){var T={};return T[f]=n,T[g]=n,Ee.call(T,_,N.browser),T.major=Ro(T.version),T},this.getCPU=function(){var T={};return T[x]=n,Ee.call(T,_,N.cpu),T},this.getDevice=function(){var T={};return T[w]=n,T[c]=n,T[d]=n,Ee.call(T,_,N.device),T},this.getEngine=function(){var T={};return T[f]=n,T[g]=n,Ee.call(T,_,N.engine),T},this.getOS=function(){var T={};return T[f]=n,T[g]=n,Ee.call(T,_,N.os),T},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return _},this.setUA=function(T){return _=typeof T===h&&T.length>Y?Pt(T,Y):T,this},this.setUA(_),this};Q.VERSION=s,Q.BROWSER=Ue([f,g,p]),Q.CPU=Ue([x]),Q.DEVICE=Ue([c,w,d,m,b,S,y,D,B]),Q.ENGINE=Q.OS=Ue([f,g]),r.exports&&(e=r.exports=Q),e.UAParser=Q;var pe=typeof t!==u&&(t.jQuery||t.Zepto);if(pe&&!pe.ua){var He=new Q;pe.ua=He.getResult(),pe.ua.get=function(){return He.getUA()},pe.ua.set=function(E){He.setUA(E);var k=He.getResult();for(var _ in k)pe.ua[_]=k[_]}}})(typeof window=="object"?window:ee)})(lt,lt.exports);const rn=lt.exports,ct=rn(navigator.userAgent);function kr(){return ct.device.type==="mobile"||ct.device.type==="tablet"}let ye;function ut(){if(ye!=null)return ye;try{new Response(new ReadableStream),ye=!0}catch(r){ye=!1}return ye}function ht(){return!(typeof TransformStream=="undefined"||!ut())}function Lr(){return ct.browser.name==="Safari"?1073741824:null}class ue{constructor(e,{method:t,headers:n,signal:s,body:o}){R(this,"url");R(this,"method");R(this,"headers");R(this,"body");R(this,"signal");this.url=e,this.method=t!=null?t:"GET",this.headers=new Headers(n),this.body=o!=null?o:null,this.signal=s!=null?s:new AbortController().signal}}class re{constructor(e,{status:t,statusText:n,headers:s,underlayer:o}){R(this,"status");R(this,"statusText");R(this,"headers");R(this,"body");R(this,"bodyReadResult");R(this,"underlayer");if(this.status=t!=null?t:200,this.statusText=n!=null?n:"",this.headers=Er(s),this.underlayer=o,e==null||!ht())this.body=e,this.bodyReadResult=Promise.resolve({success:!0,size:0});else{const[i,a]=Tr(e);this.body=i,this.bodyReadResult=a}}}function Pe(r){const{status:e,statusText:t,headers:n,body:s}=r;return new re(s,{status:e,statusText:t,headers:n,underlayer:r})}class dt extends Error{constructor(t){super(`Unexpected HTTP status: ${t.status} ${t.statusText}`);R(this,"name","UnexpectedHttpStatusError");this.response=t}}const Mr=new Sr;let sn;typeof self!="undefined"&&(sn=self,sn.addEventListener("message",r=>Mr.emit("message",r)));class Pr extends Error{constructor(){super(...arguments);R(this,"name","WindowClientError")}}class Br extends Error{constructor(){super(...arguments);R(this,"name","UnexpectedDataChannelCloseError")}}class Ir extends Error{constructor(){super(...arguments);R(this,"name","UnexpectedDataChannel1stMessageError")}}function ft(r,e=()=>1){if(r.length===0)return null;const t=r.map(e),n=t.reduce((o,i)=>o+i,0);let s=Math.random()*n;for(let o=0;o<t.length;o++){const i=t[o];if(s<i)return r[o];s-=i}return r[0]}function se(r){return r&&r.name==="AbortError"}const Or=new Br().name,Nr=new Ir().name;function Be(r){return!(r&&[Or,Nr].includes(r.name)||se(r)||r instanceof Pr)}class wt extends Error{constructor(t){super(t+"");R(this,"name","ResolveError");this.cause=t}}class on extends Error{constructor(){super(...arguments);R(this,"name","NoAvailableNodeError")}}class pt extends Error{constructor(t){super(t+"");R(this,"name","DoWithNodeError");this.cause=t}}class oe extends Error{constructor(){super(...arguments);R(this,"name","LocalDNSError")}}function zr(r,e,t){const n=t||new URL(r).hostname;let s,o;r=r.replace(/^\w+:\/\//,"").split("#")[0];const i=r.indexOf("?");i>=0?(o=r.slice(i+1),r=r.slice(0,i)):o="";const a=r.indexOf("/");s=a>=0?r.slice(a):"",s=Ur(e.rewrites,s),o=Wr(e.queryString,o);let u=n+s;return o!==""&&(u=u+"?"+o),u}function Ur(r,e){for(const t of r){const n=Hr(t,e);if(n!=null){e=qr(t,n);break}}return e}function Hr(r,e){return new RegExp(r.pattern).exec(e)}const $r=/\${(\d+)}/g;function qr(r,e){return r.repl.replace($r,(t,n)=>{var o;const s=parseInt(n,10);return s>=e.length?t:(o=e[s])!=null?o:""})}function Wr({type:r,values:e},t){if(r==="none")return"";if(r==="all")return t;const n=Jn(t),s=e!=null?e:[],o={};return Object.keys(n).forEach(i=>{r==="include"&&!s.includes(i)||r==="exclude"&&s.includes(i)||(o[i]=n[i])}),Ge(o)}function an(r,e){const t=new Map;return function(...s){const o=e(...s),i=t.get(o);if(i!=null)return i;const a=r(...s);return t.set(o,a),a.finally(()=>{t.delete(o)}),a}}const he=X("dns"),ie=te("dns"),Fr="miku-delivery/dns/cdn/v1",jr=[];function Kr(){return Qt(jr)}const mt="result",Vr={name:mt,indexes:[{name:"domain",keyPath:"domain"}]};class ln{constructor(e,t,n=vr,s,o=2e3,i=5e3){R(this,"fingerprints",new Map);R(this,"disabledElts",new Map);R(this,"storage",new Xt(Fr,[Vr]));R(this,"getResolveResultFromStorage",an(e=>this.storage.get(mt,e),e=>e));R(this,"refreshResolveResultInStorage",an((e,t)=>v(this,null,function*(){const n=yield this.dnsResolver(e,t,this.app,this.logger),s=Date.now()+n.ttl*1e3,o=W(C({},n),{domain:t,expireAt:s});return this.saveResolveResultToStorage(t,o),o}),(e,t)=>t));this.logger=e,this.app=t,this.dnsResolver=n,this.cacheKeyFn=s,this.resolveTimeout=o,this.initialDisableDuration=i}getFingerprint(e){const t=this.fingerprints.get(e);if(t==null)throw new Error(`No fingerprint for ${e}`);return t}isEltDisabled(e){const t=this.disabledElts.get(e);return t==null?!1:t.after>Date.now()}setEltDisabled(e){const t=this.disabledElts.get(e),n=t==null?this.initialDisableDuration:t.duration,s=Date.now()+n;this.disabledElts.set(e,{duration:n*2,after:s})}removeEltDisabled(e){this.disabledElts.has(e)&&this.disabledElts.delete(e)}getCacheKey(e,t){return v(this,null,function*(){if(this.cacheKeyFn!=null)return this.cacheKeyFn(e);const n=yield this.resolveDomain(new V,t);return et(n)?zr(e,n.cacheKey,n.bucket):e})}getMediaOptimization(e){return v(this,null,function*(){const t=yield this.resolveDomain(new V,e);return et(t)?t.mediaOptimization:null})}saveResolveResultToStorage(e,t){return v(this,null,function*(){return this.storage.set(mt,e,t)})}resolveDomain(e,t){return v(this,null,function*(){const n=Date.now(),s=(()=>v(this,null,function*(){const o=yield this.getResolveResultFromStorage(t);return o==null?this.refreshResolveResultInStorage(e,t):(Xr(o)&&(he("result from storage cache expired",t),this.refreshResolveResultInStorage(e,t)),e.set("dnsResolveFromCache",!0),o)}))().then(o=>(e.set("dnsResolveTotalTime",O(Date.now(),n)),o));return Promise.race([s,Ae(this.resolveTimeout,"Resolve domain")]).catch(o=>{throw ie("DNS resolve failed:",o),new wt(o)})})}resolve(e,t){return v(this,null,function*(){let n=null;return yield this.do(e,t,1,s=>{n=s}),n})}do(e,t,n,s){return v(this,null,function*(){let o;he("Resolve for",t);const i=new URL(t).hostname,[a,u]=yield Promise.all([this.getCacheKey(t,i),this.resolveDomain(e,i)]);if(!et(u))throw new oe(`Non-ECDN resolve result: ${i}`);const{groups:l,rules:h}=u;if(l.length===0)throw ie(`ECDN resolve result error: No available group for ${i}`),new on(`No available group for ${i}`);he("Resolved for",t);const p=br(h,a);if(p==null)throw ie("ECDN resolve result error: No matched rule found"),new oe("No matched rule found");if(!yr(p))throw new oe("Do not serve with given rule");let c=p.groups.map(({groupidx:f,weight:d,splitn:w})=>{const g=l[f];if(g==null)throw ie(`ECDN resolve result error: Unexpected groupidx ${f}`),new Error(`Unexpected groupidx: ${f}`);return{group:g,weight:d,splitn:w}});for(let f=0;f<n;f++){const d=ft(c,w=>w.weight);if(d==null)break;try{he("doWithGroup",f,a),yield this.doWithGroup(e,d.group,a,d.splitn,s);return}catch(w){if(ie("doWithGroup (weight:",d.weight,") failed:",w,a),o=w,se(w))break;Be(w)&&(c=c.filter(g=>g!==d))}}throw o=se(o)?o:new pt(o),o})}doWithGroup(e,t,n,s,o){return v(this,null,function*(){const i=t.elts.filter(c=>!this.isEltDisabled(c.id));if(i.length===0)throw new Error("No available elt");const a=Gr(t),u=new Set(i.map(c=>c.id)),l=s===1?2:s;let h=a.getN(n,l,u).map(c=>i.find(f=>f.id===c)),p;for(let c=0;c<2;c++){const f=ft(h.slice(0,s),d=>d.replicas);if(f==null)break;try{he("doWithElt",f.id,n),e.set("downloadEltID",f.id),yield Qr(f,n,o),this.removeEltDisabled(f.id);return}catch(d){if(ie("doWithElt",f.id,"failed:",d,n),p=d,se(d))break;Be(d)&&(h=h.filter(w=>w!==f),this.setEltDisabled(f.id))}}throw p})}}const cn=new Map;function Gr({elts:r}){const e=r.map(({id:s,replicas:o})=>`${s}:${o}`).join(","),t=cn.get(e);if(t!=null)return t;const n=new ge;return n.set(r.map(s=>({key:s.id,replicas:s.replicas}))),cn.set(e,n),n}function Qr(r,e,t){return v(this,null,function*(){let n=r.addrs;if(n.length===0)throw new Error("Empty addr list");let s;for(let o=0;o<2;o++){const i=ft(n);if(i==null)break;try{he("do job with",i,e),yield t(i);return}catch(a){if(ie("do job with",i,"failed:",a,e),s=a,se(a))break;Be(a)&&(n=n.filter(u=>u!==i))}}throw s})}function Xr(r){return r.expireAt<Date.now()}class Yr{constructor(){R(this,"front",null);R(this,"back",null)}insertElementBefore(e,t){const n=t.prev;n!=null?(n.next=e,e.prev=n):this.front=e,t.prev=e,e.next=t}insertElementAfter(e,t){const n=t.next;n!=null?(n.prev=e,e.next=n):this.back=e,t.next=e,e.prev=t}pushElementFront(e){const t=this.front;t!=null?(t.prev=e,e.next=t):this.back=e,this.front=e}pushElementBack(e){const t=this.back;t!=null?(t.next=e,e.prev=t):this.front=e,this.back=e}moveBefore(e,t){e!==t&&(this.remove(e),this.insertElementBefore(e,t))}moveAfter(e,t){e!==t&&(this.remove(e),this.insertElementAfter(e,t))}moveToFront(e){this.remove(e),this.pushElementFront(e)}moveToBack(e){this.remove(e),this.pushElementBack(e)}insertBefore(e,t){const n={value:e,prev:null,next:null};return this.insertElementBefore(n,t),n}insertAfter(e,t){const n={value:e,prev:null,next:null};return this.insertElementAfter(n,t),n}pushFront(e){const t={value:e,prev:null,next:null};return this.pushElementFront(t),t}pushBack(e){const t={value:e,prev:null,next:null};return this.pushElementBack(t),t}remove(e){const t=e.prev,n=e.next;return t!=null?(t.next=n,e.prev=null):this.front=n,n!=null?(n.prev=t,e.next=null):this.back=t,e.value}walk(e){let t=this.front;for(;t!=null;){if(e(t.value,t)===!1)return;t=t.next}}reverseWalk(e){let t=this.back;for(;t!=null;){if(e(t.value,t)===!1)return;t=t.prev}}}const Ie=X("dc/cr"),Zr=te("dc/cr"),Jr={reservedQuota:5*1024*1024};class es{constructor(e,t=Jr){R(this,"inited");R(this,"itemElementMap",new Map);R(this,"itemList",new Yr);this.dc=e,this.config=t,this.inited=this.resume()}resume(){return v(this,null,function*(){const e=[];yield this.dc.walkItems((t,n)=>{const s={key:n,usedTime:t.usedTime,size:gt(t)},o=this.itemList.pushBack(s);this.itemElementMap.set(n,o),e.push(...cs(t,n))});try{const t=yield this.dc.getBrowserCacheKeys();for(let n of t)e.includes(n)||(Ie("clear inaccessible cache:",n),yield this.dc.browserCacheDelete(n))}catch(t){Zr("failed to clear inaccessible caches:",t)}})}addItem(e,t){const n={key:e,usedTime:t.usedTime,size:gt(t)};let s=null;return this.itemList.reverseWalk((o,i)=>{if(o.usedTime<=t.usedTime)return s=this.itemList.insertAfter(n,i),!1}),s==null&&(s=this.itemList.pushFront(n)),this.itemElementMap.set(e,s),s}removeItem(e){const t=this.itemElementMap.get(e);t!=null&&(this.itemElementMap.delete(e),this.itemList.remove(t))}onItemSet(e,t){return v(this,null,function*(){yield this.inited;let n=this.itemElementMap.get(e);if(n==null){this.addItem(e,t);return}n.value.size=gt(t),t.usedTime!==n.value.usedTime&&(n.value.usedTime=t.usedTime,this.itemList.moveToBack(n))})}getTotalSize(){let e=0;return this.itemList.walk(({size:t})=>{e+=t}),e}getLeftSpace(){return v(this,null,function*(){if(typeof navigator.storage.estimate=="undefined"){const n=Lr();if(n==null)return null;const s=1.1*this.getTotalSize();return n-s}const{quota:e,usage:t}=yield navigator.storage.estimate();return e!=null&&t!=null?e-t:null})}freeUpSpace(e){return v(this,null,function*(){yield this.inited;let t=0;const n=[];this.itemList.walk(({key:s,size:o})=>{if(o!==0&&(n.push(s),t+=o,t>=e))return!1}),Ie("to free up space, remove",n),yield Promise.all(n.map(s=>v(this,null,function*(){yield this.dc.removeItemWithContent(s),this.removeItem(s)})))})}beforeContentSet(e,t,n){return v(this,null,function*(){if(n==null)return;yield this.inited;const s=yield this.getLeftSpace(),o=this.config.reservedQuota;if(s!=null&&s-o<n){const i=n-s+o;Ie("freeUpSpace for",e,t,i),yield this.freeUpSpace(i)}})}onQuotaExceeded(e,t,n){return v(this,null,function*(){Ie("quota exceeded",e,t,n);const s=this.config.reservedQuota;yield this.freeUpSpace(n?n+s:s)})}}function ts([r,e],t){return e=e!=null?e:t,e!=null?e-r:0}function gt(r){return r.pieces.reduce((e,t)=>{var n,s;return e+ts(t,(s=(n=r.meta)==null?void 0:n.fsize)!=null?s:null)},0)}const ns=X("dc"),rs="miku-delivery/dc/v1",un=["miku/dc","miku/dc/v2","miku/dc/v3"];function ss(){return Promise.all([os(un),Qt(un)])}function os(r){return v(this,null,function*(){const t=(yield caches.keys()).filter(n=>r.includes(n));yield Promise.all(t.map(n=>caches.delete(n)))})}const Re="item",hn="usedTimeIndex",is={name:Re,indexes:[{name:hn,keyPath:"usedTime"}]},as=32*1024*1024;class ls{constructor(e={},t=rs){R(this,"db");R(this,"cr");R(this,"browserCache",null);R(this,"browserCachePromise",null);this.config=e,this.ns=t,this.db=new Xt(this.ns,[is]),this.cr=new es(this)}openBrowserCache(){return v(this,null,function*(){return this.browserCachePromise!=null?this.browserCachePromise:(this.browserCachePromise=caches.open(this.ns).catch(e=>{throw new de(e)}),this.browserCachePromise.then(e=>{this.browserCache=e}),this.browserCachePromise)})}getItem(e){return v(this,null,function*(){return this.db.get(Re,e)})}setItem(e,t){return v(this,null,function*(){ns("setItem",e,t),yield this.db.set(Re,e,t),yield this.cr.onItemSet(e,t)})}walkItems(e){return v(this,null,function*(){return this.db.walkBy(Re,hn,e)})}removeItemWithContent(e){return v(this,null,function*(){const t=yield this.getItem(e);t!=null&&(yield Promise.all(t.pieces.map(n=>this.removeContent(e,n))),yield this.db.remove(Re,e))})}browserCacheMatch(e){return v(this,null,function*(){let t=this.browserCache;return t==null&&(t=yield this.openBrowserCache()),t.match(e).catch(n=>{throw new de(n)})})}browserCachePut(e,t){return v(this,null,function*(){let n=this.browserCache;n==null&&(n=yield this.openBrowserCache()),yield n.put(e,t).catch(s=>{throw new de(s)})})}browserCacheDelete(e){return v(this,null,function*(){let t=this.browserCache;t==null&&(t=yield this.openBrowserCache()),yield t.delete(e).catch(n=>{throw new de(n)})})}getBrowserCacheKeys(){return v(this,null,function*(){let e=this.browserCache;return e==null&&(e=yield this.openBrowserCache()),yield e.keys().then(t=>t.map(n=>n.url))})}getContent(e,t){return v(this,null,function*(){const n=yield this.browserCacheMatch(Oe(e,t));if(n!=null){if(n.body==null)throw new Error("Body expected for cached response");return Pe(n)}})}setContent(e,t,n,s){return v(this,null,function*(){if(!ut())yield this.cacheResponse(e,t,n.underlayer),yield s(t);else{const{headers:o,body:i}=n,a=it(o);yield Ar(i,t[0],as,(u,l,h)=>v(this,null,function*(){o.set("Content-Range",rt({start:l,end:h-1,totalSize:a})),o.set("Content-Length",h-l+"");const p=new Response(u,{status:200,statusText:"OK",headers:o});yield this.cacheResponse(e,[l,h],p),yield s([l,h])}))}})}cacheResponse(e,t,n){return v(this,null,function*(){const s=Oe(e,t),o=ce(n.headers);yield this.cr.beforeContentSet(e,t,o);try{yield this.browserCachePut(s,n)}catch(i){throw i instanceof de&&i.cause instanceof Error&&i.cause.name==="QuotaExceededError"&&this.cr.onQuotaExceeded(e,t,o),i}})}removeContent(e,t){return v(this,null,function*(){const n=Oe(e,t);return this.browserCacheDelete(n)})}dispose(){this.db.dispose()}}function Oe(r,e){var t;return/^https?:\/\//.test(r)||(r="https://miku-cache.com/"+r),`${r}_with_range_${e[0]}_${(t=e[1])!=null?t:""}`}function cs(r,e){return r.pieces.map(t=>Oe(e,t))}class de extends Error{constructor(t){super(t+"");R(this,"name","BrowserCacheError");this.cause=t}}class us{constructor(e){this.logger=e}log(e){return this.logger.log("DoLog",e)}}const vt="1.3.0-beta.4",hs=3,dn=X("http");class fn{constructor(e,t,n,s=0){R(this,"doLogger");this.client=t,this.resolver=n,this.clientResponseTimeout=s,this.doLogger=new us(e)}doWithResolved(e,t,n){return v(this,null,function*(){dn("fetch",t.url,"with resolved",n);const s=new AbortController;rr(s,t.signal);const o=new ue(t.url,W(C({},t),{signal:s.signal}));o.headers.set("X-Miku-Agent",`miku-delivery-web/v${vt}`);let i=this.client.fetch(e,o,n);this.clientResponseTimeout>0&&(i=Promise.race([i,Ae(this.clientResponseTimeout,"HTTPClient get response")]),i.catch(u=>{u instanceof Ht&&s.abort(u)}));const a=yield i;if(dn("fetch",t.url,"succeeded with status",a.status),a.status===429||a.status>=500)throw new dt(a);return a})}originalDo(e,t){return v(this,null,function*(){if(t.signal.aborted)throw t.signal.reason;let n=-1,s;if(yield this.resolver.do(e,t.url,hs,o=>v(this,null,function*(){const i=new V(e);n++,i.set("downloadRetryCount",n),s=yield this.doWithResolved(i,t,o)})),s==null)throw new Error(`Http do failed: resolver do finished with no finalResp, url: ${t.url}`);return s})}do(e,t){return v(this,null,function*(){const n=Date.now(),s=Te();e.set("doID",s);let o,i=null;try{return o=yield this.originalDo(e,t),o}catch(a){throw i=a,a}finally{const{onDoError:a,onDoResponsed:u}=this.getDoLog(e,s,n);o==null?a(i):u(o.status)}})}getDoLog(e,t,n){const s=a=>{var u;return this.doLogger.log(C({lookup_type:!0,t_lookup:(u=e.get("dnsResolveFromCache")===!0?0:e.get("dnsResolveTotalTime"))!=null?u:-1,t_total:-1,ts_st:n,err_desc:"",err_msg:"",status_code:-1,task_id:e.get("taskID"),id:t},a))};return{onDoError:a=>{const u=Date.now();s(C({t_total:O(u,n)},ne(a)))},onDoResponsed:a=>{const u=Date.now();s({t_total:O(u,n),status_code:a})}}}}class ds{constructor(e){this.logger=e}log(e){return this.logger.log("TaskLog",e)}}class wn{constructor(e,t,n,s){R(this,"id",Te());R(this,"priority",0);R(this,"signal");R(this,"started",!1);R(this,"taskLogger");this.url=e,this.range=t,this.startByClient=s,this.taskLogger=new ds(n)}setPriority(e){this.priority=e}start(e){return v(this,null,function*(){if(this.started)throw new Error("Task already started");if(this.started=!0,this.signal=e,e&&e.aborted)throw e.reason;const t=Date.now(),n=new V;n.set("taskID",this.id),n.set("taskDomain",new URL(this.url).hostname);let s,o=null;try{return s=yield this.startByClient(n,this),s}catch(i){throw o=i,i}finally{const{logOnError:i,logOnTransferred:a}=this.log(n,t);s==null?i(o):s.underlayer.bodyReadResult.then(u=>{u.success?a():i(u.error)})}})}log(e,t){const n=e.get("taskCacheMatchAt"),s=e.get("task1stHttpDoAt"),o=e.get("taskResultStreamAt"),i=Date.now(),a=h=>{var p,c,f,d,w;return this.taskLogger.log(C({type:(p=e.get("taskType"))!=null?p:1,id:this.id,url:this.url,err_msg:"",err_desc:"",range_st:(f=(c=this.range)==null?void 0:c.start)!=null?f:-1,range_end:(w=(d=this.range)==null?void 0:d.end)!=null?w:-1,ts_st:t,t_cc_match:O(n,t),t_http_do:O(s,n),t_res_stream:O(o,n),t_res:O(i,o),t_trans:-1,t_total:-1},h))};return{logOnError:h=>{const p=Date.now();a(C({t_total:O(p,t)},ne(h)))},logOnTransferred:()=>{const h=Date.now();a({t_trans:O(h,i),t_total:O(h,t)})}}}}class pn{constructor(e,t,n,s,o){this.stream=e,this.size=t,this.fileSize=n,this.contentType=s,this.underlayer=o}blob(){return v(this,null,function*(){const e=this.stream.getReader(),t=[];for(;;){const{done:n,value:s}=yield e.read();if(n)break;const o=s;t.push(o)}return new Blob(t)})}}function bt(r,e,t){return r!=null&&t!=null&&t>=r&&(t=null),(e==null||e<0)&&(e=0),[e,t]}function mn(r,e){var s;const t=((s=e[0])!=null?s:0)===0,n=e[1]==null||r!=null&&e[1]===r;return t&&n}function fs(r,e){var s,o;const t=(s=e[0])!=null?s:0,n=(o=e[1])!=null?o:r;return n==null?null:n-t}function ws(r,e,t){var u,l;if(e===0)return[];const n=(h,p)=>vn(h,p,e!=null?e:Number.POSITIVE_INFINITY),s=(u=r==null?void 0:r[0])!=null?u:0,o=(l=r==null?void 0:r[1])!=null?l:e,i=[];let a=s;for(const h of t){if(a==null||e!=null&&h[1]!=null&&h[1]>e)break;if(!(h[1]!=null&&a>=h[1])){if(o==null||o>h[0]){h[0]>a&&i.push({cached:!1,range:bt(e,a,h[0])});const p=n(h[0],a)?h[0]:a,c=n(h[1],o)?o:h[1];n(c,p)&&(i.push({cached:!0,range:bt(e,p,c)}),a=c);continue}break}}return n(o,a)&&i.push({cached:!1,range:bt(e,a,o)}),i}function ps(r,e){var s;const t=(s=e[0])!=null?s:0,n=e[1];for(const o of r){if(o[1]!=null&&o[1]<=t)continue;if(o[0]>t)break;const i=t-o[0],a=gs(n!=null?n:o[1],o[0]);return{piece:o,start:i,end:a}}throw new Error("Piece not found")}function ms(r,e){for(let s of r){if(s[0]===e[0]&&s[1]===e[1])return{toSave:r,toRemove:[]};if(gn(s,e))return{toSave:r,toRemove:[e]}}const t=[],n=[];for(let s of r)gn(e,s)?n.push(s):t.push(s);return{toSave:[...t,e].sort((s,o)=>s[0]-o[0]),toRemove:n}}function gn(r,e){return r[0]<=e[0]&&!vn(e[1],r[1],Number.POSITIVE_INFINITY)}function vn(r,e,t){const n=r!=null?r:t,s=e!=null?e:t;return n>s}function gs(r,e){return r==null||e==null?null:r-e}function bn(r){const e={},t=r.split(",").map(n=>{let[s,o]=n.split("=").map(i=>i.trim());return[s.toLowerCase(),o]});for(const[n,s]of t)if(n==="max-age"){if(s!=null){const o=parseInt(s,10);Number.isNaN(o)||(e["max-age"]=o)}}else(n==="no-cache"||n==="no-store")&&(e[n]=!0);return e}function Ne(r){return Math.floor(r/1e3)}function yn(r,e){const t=r.get("Date");if(t==null)return e;const n=Date.parse(t);return Number.isNaN(n)?e:n}function vs(r,e,t){if(r!=null)return r;const n=e.get("Expires");if(n!=null){let s=Date.parse(n);Number.isNaN(s)&&(s=0);const o=yn(e,t);return Ne(s-o)}return 3600}function bs(r){const e=r.get("Age");if(e==null)return 0;const t=parseInt(e,10);return Number.isNaN(t)?0:t}function ys(r,e,t,n){const s=bs(r),o=yn(r,t),i=Math.max(0,Ne(t-o)),a=Ne(t-e),u=s+a,l=Math.max(i,u),h=Ne(n-t);return l+h}function Rs(r,e,t,n,s){var u;const o=(u=r==null?void 0:r["max-age"])!=null?u:null,i=vs(o,e,n),a=ys(e,t,n,s);return i>a}function Ss(r,e,t,n){const s=r.get("Cache-Control"),o=s!=null?bn(s):null;return(o==null?void 0:o["no-cache"])===!0?!0:!Rs(o,r,e,t,n)}function Cs(r){const e=r.get("Cache-Control"),t=e!=null?bn(e):null;return!(t!=null&&t["no-store"]===!0)}function xs(r){const e=r.get("ETag");return e==null?null:e.startsWith("W/")?e.slice(2):e}function Es(r,e){const t=new Headers(r),n=xs(e);n!=null&&t.set("If-None-Match",n);const s=e.get("Last-Modified");return s!=null&&t.set("If-Modified-Since",s),t}function _s(r,e){return!(r.get("Last-Modified")===e.get("Last-Modified")&&r.get("ETag")===e.get("ETag"))}function Ts(r,e){const t=new Headers(r);return e.forEach((n,s)=>{s=s.toLowerCase(),!(s==="content-length"||s==="content-encoding"||s==="content-range")&&t.set(s,n)}),t}const As={threshold:0,contentRangeExposed:!0},L=X("ftask"),Se=te("ftask");class Ds{constructor(e,t,n,s,o,i,a){R(this,"id",Te());R(this,"inited");R(this,"meta",null);R(this,"cachePieces",[]);R(this,"usedTime",0);R(this,"isMedia");this.cache=e,this.nativeHttpClient=t,this.http=n,this.key=s,this.url=o,this.patterns=i,this.getMediaOptimization=a,this.inited=this.resume();const u=De(o);this.isMedia=i.media.some(l=>l.test(u))}fileSize(){var e,t;return(t=(e=this.meta)==null?void 0:e.fsize)!=null?t:null}cacheValidationRequired(){if(this.meta==null)return!1;const{requestTime:e,responseTime:t,headers:n}=this.meta;return e==null||t==null||n==null?!1:Ss(n,e,t,Date.now())}isRangeStartFirstRequested(e){var n;const t=(n=e[0])!=null?n:0;return!this.cachePieces.some(s=>{var o;return s[0]<=t&&t<=((o=s[1])!=null?o:Number.POSITIVE_INFINITY)})}startTask(e,t){return v(this,null,function*(){L("startTask",t.url,t.id,t.range);let n;const s=t.range!=null?[t.range.start,t.range.end]:[0,null];yield this.inited,this.usedTime=Date.now(),this.save().catch(a=>Se("save failed when startTask:",a)),ht()?n=yield this.readRangeWithStream(e,t,s):(L("supportStreamOperation: false",t.url,t.id),n=yield this.readRangeWithoutStream(e,t,s));const o=this.meta;if(o==null)throw new Error("Missing meta in fileTask");L("startTask resolved",t.url,t.id);const i=fs(o.fsize,s);return new pn(n.body,i,o.fsize,o.headers.get("Content-Type"),n)})}readRangeWithoutStream(e,t,n){return v(this,null,function*(){var a,u;let s;const o=[(a=n[0])!=null?a:0,n[1]],i=(u=yield this.cache.getContent(this.key,o))!=null?u:null;if(e.set("taskCacheMatchAt",Date.now()),i!=null&&!this.cacheValidationRequired())L("use cache",t.url,t.id),s=i;else if(L("doRequestAndSaveCache",t.url,t.id,i!=null),s=yield this.doRequestAndSaveCache(e,t,n,i!=null,!1),s.status===304){if(i==null)throw new Error("Unexpected 304 with no cached response");s=i}return e.set("taskResultStreamAt",Date.now()),s})}readRangeWithStream(e,t,n){return v(this,null,function*(){const s=this.cacheValidationRequired();L("cacheValidationRequired",s);const o=ws(n,this.fileSize(),this.cachePieces);if(L("applyRange",n,this.fileSize(),this.cachePieces,o),s){const u=o.some(p=>p.cached),l=this.isMedia?yield this.getMediaOptimization():!1,h=yield this.doRequestAndSaveCache(e,t,n,u,l);if(h.status===200||h.status===206)return h}e.set("taskCacheMatchAt",Date.now());const i=new TransformStream(void 0),a=yield new Promise((u,l)=>v(this,null,function*(){try{for(let h=0;h<o.length;h++){const p=h===0,{cached:c,range:f}=o[h];let d=null;if(c&&(d=yield this.readPieceFromLocal(e,t,f)),d==null){const g=this.isMedia&&p&&this.isRangeStartFirstRequested(f)?yield this.getMediaOptimization():!1;d=yield this.readPieceFromRemote(e,t,f,g)}p&&u(d);const w=h===o.length-1;yield d.body.pipeTo(i.writable,{preventClose:!w})}}catch(h){h!=null&&L("readRange stream error for",this.url,h),i.writable.abort(h),l(h)}}));return e.set("taskResultStreamAt",Date.now()),new re(i.readable,a)})}readPieceFromLocal(e,t,n){return v(this,null,function*(){L("readPieceFromLocal",t.url,n);const{piece:s,start:o,end:i}=ps(this.cachePieces,n),a=yield this.cache.getContent(this.key,s);return a==null?(Se(`Missing cache item: ${this.key} [${s})`),null):new re(at(a.body,[o,i]),a)})}readPieceFromRemote(e,t,n,s){return v(this,null,function*(){L("readPieceFromRemote",t.url,n);const o=yield this.doRequestAndSaveCache(e,t,n,!1,s);return!mn(this.fileSize(),n)&&o.status===200?(Se("Range request not supported for",this.url),new re(at(o.body,n),o)):o})}doRequest(e,t,n,s,o){return v(this,null,function*(){var d;e.get("task1stHttpDoAt")==null&&e.set("task1stHttpDoAt",Date.now());const i=new V(e);i.set("downloadFileTaskID",this.id);let a=new Headers({"Accept-Encoding":"identity;q=1, *;q=0"});n!=null&&(t.range==null&&mn(this.fileSize(),n)||a.set("Range",be({start:n[0],end:n[1]==null?null:n[1]-1})));const u=(d=this.meta)==null?void 0:d.headers;s&&u!=null&&(a=Es(a,u));const l=new ue(t.url,{method:"GET",headers:a,signal:t.signal}),h=Date.now();let p;o===!1||o.threshold<=0?p=yield this.http.do(i,l):p=yield ks((...w)=>this.http.do(...w),(...w)=>this.nativeHttpClient.fetch(...w),o)(i,l);const c=Date.now();let f=p.headers;if(s&&u!=null&&p.status===304)L(`updateStoredHeaders for ${this.url}`),f=Ts(u,p.headers);else{if(p.status!==200&&p.status!==206)throw new dt(p);if(p.body==null)throw new Error("Body expected")}return yield this.onResponse(f,h,c),p.bodyReadResult.then(w=>{L(`bodyReadResult for ${this.url}:`,w)}),p})}doRequestAndSaveCache(e,t,n,s,o){return v(this,null,function*(){const i=yield this.doRequest(e,t,n,s,o);return(i.status===200||i.status===206)&&Cs(i.headers)?this.saveCachePiece(t,n,i):i})}saveCachePiece(e,t,n){return v(this,null,function*(){var i,a;let s=n,o;if(ht()){const{main:u,minor:l}=Dr(n.body);s=new re(u,n),o=new re(l,n)}else if(!e.range){const u=n.underlayer.clone();o=Pe(u)}if(o!=null){const u=[(i=t==null?void 0:t[0])!=null?i:0,(a=t==null?void 0:t[1])!=null?a:null];L("saveCachePiece",this.url,u),this.cache.setContent(this.key,u,o,l=>v(this,null,function*(){const{toSave:h,toRemove:p}=ms(this.cachePieces,l);if(this.cachePieces=h,p.length>0){L("remove duplicated cache pieces",p);try{yield Promise.all(p.map(c=>this.cache.removeContent(this.key,c)))}catch(c){L("exception occurred while removing duplicated cache pieces",c)}}return this.save()})).then(()=>L("saveCachePiece finish",this.url,u,this.cachePieces),l=>Se("saveCachePiece failed",this.url,u,l))}return s})}onResponse(e,t,n){return v(this,null,function*(){const s=this.meta;this.meta={fsize:it(e),requestTime:t,responseTime:n,headers:e},(s==null?void 0:s.headers)!=null&&_s(s.headers,e)&&(L(`${this.url} modified, clear local cache`),yield Promise.all(this.cachePieces.map(o=>this.cache.removeContent(this.key,o))),this.cachePieces=[]),this.save().catch(o=>Se("save failed when onResponse:",o))})}resume(){return v(this,null,function*(){const e=yield this.cache.getItem(this.key);e==null||e.meta==null||(this.meta=W(C({},e.meta),{headers:e.meta.headers!=null?new Headers(e.meta.headers):null}),this.cachePieces=e.pieces)})}save(){return v(this,null,function*(){var s,o;const e=((s=this.meta)==null?void 0:s.headers)!=null?[...((o=this.meta)==null?void 0:o.headers).entries()]:null,n={meta:this.meta!=null?W(C({},this.meta),{headers:e}):null,pieces:this.cachePieces,usedTime:this.usedTime};yield this.cache.setItem(this.key,n)})}}function ks(r,e,{threshold:t,contentRangeExposed:n}){return function(o,i){return v(this,null,function*(){var Y,H;const B=i,{url:a}=B,u=Ot(B,["url"]),l=ot(i.headers);L("doWithInitialOptimization",a);const h=new V(o),p=new Headers(u.headers),c=C({start:null,end:null},l);c.start=(Y=c.start)!=null?Y:0;const f=c.start+t-1;(c.end==null||c.end>f)&&(c.end=f),p.set("Range",be(c));const d=new ue(a,W(C({},u),{headers:p})),g=yield((K,G)=>v(this,null,function*(){var ae;let z=null;const q=ot(G.headers);q!=null&&!Yt(q)&&!n&&(z=Ls(a,u.headers,e));const F=yield e(K,G);if(q!=null&&F.status===206&&!F.headers.get("Content-Range")){const j=Yt(q)?ce(F.headers):yield z;if(j!=null){const U=rt({start:q.start,end:(ae=q.end)!=null?ae:j-1,totalSize:j});F.headers.set("Content-Range",U)}}return F}))(h,d);if(g.body==null)throw new Error("Body expected for initial response");if(g.status!==206)return g;const x=nt(g.headers);if(x==null)throw new Error("Header Content-Range expected for 206 response");const m=(()=>{var ae;const K=ce(g.headers);if(K!=null&&K<t)return g.body;const G=new Headers(u.headers),z=C({start:null,end:null},l);if(z.start=((ae=z.start)!=null?ae:0)+t,z.end!=null&&z.end<z.start)return g.body;L("doWithInitialOptimization followingRange",z),G.set("Range",be(z));const q=new ue(a,W(C({},u),{headers:G})),F=new TransformStream;return g.body.pipeTo(F.writable,{preventClose:!0}).then(()=>v(this,null,function*(){L("doWithInitialOptimization initialBody transfered");let j;try{const U=yield r(o,q);if(U.body==null)throw new Error(`Body expected for following response of ${a}`);if(U.status===200)j=at(U.body,[z.start,z.end==null?null:z.end+1]);else if(U.status===206)j=U.body;else throw new dt(U)}catch(U){if(Ms(U))L("use fallback fetch for doWithInitialOptimization followingBody",U),j=(yield e(o,q)).body;else{L("doWithInitialOptimization get followingBody failed",U),F.writable.abort(U);return}}j.pipeTo(F.writable).then(()=>L("doWithInitialOptimization followingBody transfered"),U=>L("doWithInitialOptimization followingBody transfer failed",U))}),j=>v(this,null,function*(){L("doWithInitialOptimization initialBody transfer failed",j)})),F.readable})(),b=x.totalSize,y=new Headers(g.headers);if(y.delete("Content-Range"),y.delete("Content-Length"),l==null)return b!=null&&y.set("Content-Length",b+""),new re(m,{status:200,statusText:"OK",headers:y,underlayer:g.underlayer});const S=(H=l.start)!=null?H:0,D=l.end!=null?l.end:b!=null?b-1:null;return D!=null&&y.set("Content-Length",D-S+1+""),y.set("Content-Range",rt({start:S,end:D,totalSize:b})),new re(m,{status:206,statusText:"Partial Content",headers:y,underlayer:g.underlayer})})}}function Ls(r,e,t){return v(this,null,function*(){const n=new Headers(e);n.delete("Range");const s=yield t(new V,new ue(r,{method:"HEAD",headers:n}));return ce(s.headers)})}function Ms(r){return[wt,oe,on,pt,ve,de].some(e=>r instanceof e)}class Ps{constructor(){R(this,"locked",!1);R(this,"waitings",[]);this.unlock=this.unlock.bind(this)}lock(){return v(this,null,function*(){return this.locked?(yield new Promise(e=>{this.waitings.push(e)}),this.unlock):(this.locked=!0,this.unlock)})}unlock(){if(this.waitings.length===0){this.locked=!1;return}this.waitings.shift()()}runExclusive(e){return v(this,null,function*(){const t=yield this.lock();try{return yield e()}catch(n){throw n}finally{t()}})}}function Bs(){var s,o;const{os:r,device:e,browser:t}=rn(navigator.userAgent);let n;return typeof window!="undefined"?n=window.location:typeof self!==void 0&&(n=self.location),{os:`${r.name}_${r.version}`,browser:`${t.name}_${t.version}`,app:(s=n==null?void 0:n.host)!=null?s:"",sdk:`Web SDK v${vt}`,dev_model:(o=e.model)!=null?o:"",dev_id:""}}const yt=200,Rt=X("log"),Is=te("log");class Rn{constructor(e,t=self.fetch,n=100,s=3){R(this,"env",Ge(Bs()));R(this,"flushMutex",new Ps);R(this,"buffer",[]);this.appInfo=e,this.fetch=t,this.flushNum=n,this.flushWait=s}callApiLog(e,t=3,n=2e3){return v(this,null,function*(){const s=Os(e),o=s.map(h=>h.schema).join(","),i=`${Zn}/v1/log/${o}`,a=Je({appID:this.appInfo.appID,appSalt:this.appInfo.appSalt,path:i}),u={method:"POST",headers:{Authorization:a,"Content-Type":"text/csv","X-Env":this.env},body:Ns(s)},l=this.fetch;for(let h=1;h<=t;h++)try{const p=yield l(new Request(i,u));if(p.ok)return;throw new Error(`Unexpected response status: ${p.status} ${p.statusText}`)}catch(p){const c=h<t;Is("Call log API failed:",p,c?`Retry after ${n}ms`:""),c&&(yield nr(n))}})}flush(){return this.flushMutex.runExclusive(()=>{const e=this.buffer.splice(0);if(e.length===0)return;const t=Math.ceil(e.length/yt);return Promise.all(Array.from({length:t}).map((n,s)=>this.callApiLog(e.slice(s*yt,(s+1)*yt))))})}tryFlush(){return v(this,null,function*(){const e=yield this.flushMutex.runExclusive(()=>{const t=this.buffer;if(t.length===0)return!1;if(t.length>=this.flushNum)return Rt("buffer.length >= this.flushNum"),!0;const n=Date.now()-t[0].log.ts;return n>=this.flushWait*1e3?(Rt("waited >= this.flushWait"),!0):this.flushWait*1e3-n});if(e===!0)return this.flush();typeof e=="number"&&setTimeout(()=>this.tryFlush(),e)})}log(e,t){Rt("log",e,t),this.buffer.push({schema:e,log:C({ts:Date.now()},t)}),this.tryFlush()}}function Os(r){const e=[];return r.forEach(({schema:t,log:n})=>{let s=e.find(o=>o.schema===t);s==null&&(s={schema:t,logs:[]},e.push(s)),s.logs.push(n)}),e}function Ns(r){return r.map(e=>e.logs).map(zs).join(`

`)}function zs(r){const e=Object.keys(r[0]),t=["ts",...e.filter(o=>o!=="ts")],n=t.map(Sn).join(","),s=r.map(o=>t.map(i=>o[i]).map(i=>i!=null?i+"":"").map(Sn).join(","));return[n,...s].join(`
`)}function Sn(r){let e=r.replace(/"/g,'""');return/("|,|\n)/.test(e)&&(e='"'+e+'"'),e}class Us{constructor(e){this.logger=e}log(e){return this.logger.log("LiveScheduleLog",e)}}const Hs=new URL(Ve).hostname;function $s(r,e,t,n){return v(this,null,function*(){var c,f;const s=new Us(n),o={url:e,cip:""},i=Je(W(C({},t),{path:Ve})),a=Date.now();let u,l=null,h=null,p=null;try{if(l=yield fetch(Ve,{method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json",Authorization:i}}),h=Date.now(),!l.ok)throw new Error(`Call Schedule API failed, status: ${l.status} ${l.statusText}`);return p=yield l.json()}catch(d){throw u=d}finally{const d=O(Date.now(),a),w=p==null?ne(u):{err_msg:"",err_desc:""};s.log(W(C({r_id:(c=l==null?void 0:l.headers.get("x-reqid"))!=null?c:"",ip:"",domain:Hs,status_code:(f=l==null?void 0:l.status)!=null?f:-1},w),{t_conn:O(h,a),t_total:d,type:1}))}})}const Ce=X("dns"),St=te("dns"),qs=60,Ws=60*1e3;class Fs{constructor(e,t,n=$s,s=De){R(this,"scheduling",new Map);R(this,"cache",new Map);R(this,"m3u8SegmentCache",new Map);this.logger=e,this.app=t,this.scheduler=n,this.cacheUrl=s}getScheduleResult(e,t){return v(this,null,function*(){var i;const n=Date.now();let s;try{s=yield this.scheduler(e,t,this.app,this.logger)}catch(a){throw St("Live schedule failed:",a),new wt(a)}finally{e.set("dnsResolveTotalTime",O(Date.now(),n))}if(s.code===1)throw new oe(`Local DNS for ${t}`);if(s.code!==0)throw new Error(`Unexpected schedule code: ${s.code}`);const o=(i=s.ttl)!=null?i:qs;return{nodes:s.hosts.map(a=>{const[u,l]=sr(a,0),[h,p]=["",0];return{addr:{ip:h,host:u,http:l+80,https:l+443,how:p},after:0}}),expireAt:Date.now()+o*1e3,ttl:o}})}saveM3u8SegmentResult(e,t){return v(this,null,function*(){const n=this.cacheUrl(e),s=this.cache.get(n);if(s==null){St("No schedule result for m3u8:",e);return}const o=t.map(this.cacheUrl);o.forEach(i=>{this.m3u8SegmentCache.set(i,s)}),setTimeout(()=>{o.forEach(i=>{this.m3u8SegmentCache.delete(i)})},6e4)})}schedule(e,t){return v(this,null,function*(){const n=this.cacheUrl(t);if(!ke(t)&&!Wt(t)){const a=this.m3u8SegmentCache.get(n);if(a==null)throw new oe("Neither m3u8 / flv URL, or m3u8 segment URL");return a}const s=this.cache.get(n);if(s!=null&&Ct(s))return e.set("dnsResolveFromCache",!0),s;const o=this.scheduling.get(n);if(o!=null){let a;try{a=yield o}catch(u){if(u instanceof oe)throw u}if(a!=null&&Ct(a))return e.set("dnsResolveFromCache",!0),a;this.scheduling.delete(n)}const i=this.getScheduleResult(e,t);return Ce("save scheduling for",t),this.scheduling.set(n,i),i.then(a=>{Ce("save cache for",t),this.cache.set(n,a)},()=>{}),i})}hasResult(e){const t=this.cacheUrl(e),n=ke(e)||Wt(e)?this.cache.get(t):this.m3u8SegmentCache.get(t);return n!=null&&Ct(n)}do(e,t,n,s){return v(this,null,function*(){let o;Ce("schedule for",t);const i=yield this.schedule(e,t);Ce("scheduled for",t);for(let a=0;a<n;a++){const u=js(i.nodes);if(u==null)break;try{Ce("do job with",u,t),yield s(u.addr),i.expireAt=Date.now()+i.ttl*1e3;return}catch(l){if(St("do job with",u.addr,"failed:",l,t),o=l,se(l))break;Be(l)&&(u.after=Date.now()+Ws)}}throw o=se(o)?o:new pt(o),o})}}function Cn(r,e=Date.now()){return r.after<e}function js(r){for(const e of r)if(Cn(e))return e;return null}function Ct(r){const e=Date.now();return r.expireAt<=e?!1:r.nodes.some(t=>Cn(t,e))}const fe=X("utils/fetch");function xn(r){return v(this,null,function*(){var f,d;const e=yield fetch(r),t=ot(r.headers);if(t==null||e.status!==206||e.body==null)return e;const{body:n,status:s,statusText:o,headers:i}=e,a=(f=nt(i))==null?void 0:f.end,u=100;let l=(d=t.start)!=null?d:0,h=n.getReader(),p=null;const c=new ReadableStream({pull:w=>v(this,null,function*(){p!=null&&(clearTimeout(p),p=null),h==null&&(fe("resume on pull"),r.headers.set("range",be(W(C({},t),{start:l}))),h=(yield fetch(r)).body.getReader());const{value:g,done:x}=yield h.read();if(x){fe("read done"),w.close();return}try{w.enqueue(g)}catch(m){fe("enqueue failed:",m),h==null||h.cancel("target stream enqueue failed");return}if(l+=g.byteLength,a!=null&&l>a){fe("all enqueued"),h.cancel("all enqueued"),w.close();return}p=setTimeout(()=>v(this,null,function*(){p=null,h!=null&&(fe("cancel after long time no pull"),h.cancel("long time no read"),h=null)}),u)}),cancel:w=>{fe("cancel",w),h==null||h.cancel(w)}});return new Response(c,{status:s,statusText:o,headers:i})})}class En{constructor(e){this.logger=e}start(e,t){let n;const s=Date.now(),o=u=>{var f,d,w,g,x,m,b,y,S,D,B;const l=t.headers.get("Range"),h=l==null?null:Zt(l),p=n==null?void 0:n.headers.get("X-M-Reqid"),c=p?p.split(", ").pop():"";this.log(C({ip:(f=e.get("downloadReqIP"))!=null?f:"",domain:(d=e.get("taskDomain"))!=null?d:"",range_st:(w=h==null?void 0:h.start)!=null?w:-1,range_end:(g=h==null?void 0:h.end)!=null?g:-1,retry:(x=e.get("downloadRetryCount"))!=null?x:0,ftask_id:(m=e.get("downloadFileTaskID"))!=null?m:"",task_id:(b=e.get("taskID"))!=null?b:"",d_id:(y=e.get("doID"))!=null?y:"",ts_st:s,r_id:c,elt_id:(S=e.get("downloadEltID"))!=null?S:"",status_code:(D=n==null?void 0:n.status)!=null?D:-1,t_req_msg:O(e.get("downloadReqMessageAt"),s),t_conn:O(e.get("downloadConnectionAt"),(B=e.get("downloadReqMessageAt"))!=null?B:s),t_tls:-1,t_st_trans:O(e.get("downloadStartTransferAt"),e.get("downloadConnectionAt")),t_resp_msg:O(e.get("downloadRespMessageAt"),e.get("downloadStartTransferAt")),err_msg:"",err_desc:"",t_content_trans:-1,t_total:-1,resp_size:-1},u))};return{onError:u=>{const l=Date.now();o(C({t_total:O(l,s)},ne(u)))},onResponse:u=>{n=u,n.bodyReadResult.then(l=>{var c;const h=Date.now(),p=l.success?null:ne(l.error);o(C({t_content_trans:O(h,(c=e.get("downloadRespMessageAt"))!=null?c:e.get("downloadStartTransferAt")),t_total:O(h,s),resp_size:l.size},p))})}}}wrap(e,t,n){return v(this,null,function*(){const s=this.start(e,t);try{const o=yield n();return s.onResponse(o),o}catch(o){throw s.onError(o),o}})}log(e){return this.logger.log("DownloadLog",e)}}class Ks{constructor(e){R(this,"downloadLogger");this.downloadLogger=new En(e)}fetch(e,t,n=!0,s=!0){return v(this,null,function*(){return this.downloadLogger.wrap(e,t,()=>v(this,null,function*(){const h=t,{url:o}=h,i=Ot(h,["url"]),a=new Request(o,C(C(C({},n?_n:null),s?{cache:"no-store"}:null),i)),u=yield xn(a),l=Date.now();return e.set("downloadConnectionAt",l),e.set("downloadStartTransferAt",l),Pe(u)}))})}}const _n={mode:"cors",credentials:"omit"};class Tn{constructor(e,t=!0,n=xn){R(this,"downloadLogger");this.https=t,this.nativeFetch=n,this.downloadLogger=new En(e)}fetch(e,t,n){return v(this,null,function*(){return this.downloadLogger.wrap(e,t,()=>v(this,null,function*(){e.set("downloadReqIP",n.host);const s=this.nativeFetch,o=Vs(t,n,this.https),i=yield s(o),a=Date.now();return e.set("downloadConnectionAt",a),e.set("downloadStartTransferAt",a),Pe(i)}))})}dispose(){}}function Vs(r,e,t=!0){const{url:n,headers:s,method:o,signal:i}=r,a=new URL(n),u=a.host,l=new Headers(s);a.protocol=t?"https:":"http:",a.host=`${e.host}:${t?e.https:e.http}`,a.pathname=`/${u}${a.pathname}`;let h=a.toString();const p="no-store";if(l.has("X-Miku-Agent")){const c=l.get("X-Miku-Agent");l.delete("X-Miku-Agent");const f=h.includes("?")?"&":"?",d=["X-Miku-Agent",c].map(encodeURIComponent).join("=");h=h+f+d}return new Request(h,W(C({},_n),{cache:p,headers:l,method:o,signal:i}))}function Gs(r){const e=[],t=r.split(`
`).map(s=>s.trim()).filter(s=>s.length>0);if(t[0]!=="#EXTM3U")throw new Error("Invalid Extended M3U Playlist");let n=null;for(const s of t){if(s.startsWith("#")){s.startsWith("#EXTINF:")&&(n=s);continue}n!=null&&(e.push({uri:s}),n=null)}return e}const An=X("client"),xt=te("client");class Qs{constructor(e,t){R(this,"fileTasks",new Map);R(this,"cache");R(this,"cdnResolver");R(this,"liveResolver");R(this,"nativeHttpClient");R(this,"http");R(this,"liveHttp");R(this,"patterns");R(this,"logger");var i,a,u,l,h;this.config=t,t!=null&&t.debug&&je(),this.cache=new ls(t==null?void 0:t.cache),this.logger=(i=t==null?void 0:t.logger)!=null?i:new Rn(e),this.cdnResolver=(a=t==null?void 0:t.resolver)!=null?a:new ln(this.logger,e,t==null?void 0:t.dnsResolver,t==null?void 0:t.cacheUrl),this.liveResolver=(u=t==null?void 0:t.liveResolver)!=null?u:new Fs(this.logger,e,t==null?void 0:t.scheduler),this.nativeHttpClient=new Ks(this.logger);const n=(l=t==null?void 0:t.httpClient)!=null?l:new Tn(this.logger),s=(h=t==null?void 0:t.liveHttpClient)!=null?h:new Tn(this.logger);this.patterns=C(C({},Qe),t==null?void 0:t.patterns),this.http=new fn(this.logger,n,this.cdnResolver,6e3);const o=2e3;this.liveHttp=new fn(this.logger,s,this.liveResolver,o)}prepare(e){return v(this,null,function*(){return Promise.all(e.map(t=>this.cdnResolver.resolveDomain(new V,t))).catch(t=>{xt("prepare failed:",t)})})}createTask(e,t){const n=e.indexOf("#");return n>=0&&(e=e.slice(0,n)),new wn(e,t!=null?t:null,this.logger,(s,o)=>(s.set("taskType",1),this.startTask(s,o)))}createLiveTask(e,t){const n=e.indexOf("#");return n>=0&&(e=e.slice(0,n)),new wn(e,t!=null?t:null,this.logger,(s,o)=>(s.set("taskType",2),this.startLiveTask(s,o)))}startTask(e,t){return v(this,null,function*(){const n=new URL(t.url).hostname,s=yield this.cdnResolver.getCacheKey(t.url,n);let o=this.fileTasks.get(s);if(o==null){const i=()=>v(this,null,function*(){var u;const a=yield this.cdnResolver.getMediaOptimization(n);return C(C(C({},As),a),(u=this.config)==null?void 0:u.mediaOptimization)});o=new Ds(this.cache,this.nativeHttpClient,this.http,s,t.url,this.patterns,i),this.fileTasks.set(s,o)}return o.startTask(e,t)})}saveM3u8SegmentResult(e,t){return v(this,null,function*(){const n=yield _r(t),o=Gs(n).map(i=>or(i.uri,e));An("saveM3u8SegmentResult",De(e),o.map(De)),yield this.liveResolver.saveM3u8SegmentResult(e,o)})}startLiveTask(e,t){return v(this,null,function*(){var l,h;const n={};t.range!=null&&(n.Range=be({start:t.range.start,end:t.range.end==null?null:t.range.end-1}));const s=new ue(t.url,{method:"GET",headers:n,signal:t.signal});let o,a=((h=(l=this.config)==null?void 0:l.liveOptimization)!=null?h:!0)&&ke(t.url)&&!this.liveResolver.hasResult(t.url);if(a){An("use nativeClient for",t.url);const p=this.nativeHttpClient.fetch(e,s);this.liveHttp.do(new V(e),s).catch(c=>{xt("do failed when prefetch for liveOptimization:",c)}),o=yield p}else o=yield this.liveHttp.do(e,s);if(o.body==null)throw new Error("Body expected");if(o.status!==200&&o.status!==206)throw new Error(`Invalid response, status: ${o.status}`);let u=o.body;if(!a&&ut()&&ke(t.url)){const[p,c]=o.body.tee();this.saveM3u8SegmentResult(t.url,c).catch(f=>{xt("Save M3u8 segment cache failed:",t.url,f)}),u=p}return new pn(u,ce(o.headers),it(o.headers),o.headers.get("Content-Type"),o)})}dispose(){this.cache.dispose()}}function Xs(r){return r&&r.mikuDeliveryProxy===!0}const Ys="md_download_url",Zs="md_download_filename";function Js(r,e,t){return Ut(r,{[Ys]:e,[Zs]:t})}const eo="MIKU_DELIVERY_PROXY_CONFIG";function to(r,e){const t=s=>s==null?void 0:s.map(o=>({source:o.source,flags:o.flags})),n=W(C({},e),{patterns:e.patterns==null?void 0:er(e.patterns,s=>t(s))});return Ut(r,{[eo]:JSON.stringify(n)})}function Dn(r){return Array.isArray(r)?{cdn:r,live:[]}:C({cdn:[],live:[]},r)}function no(r,e){const t=r.hostname;return e.includes("*")||e.includes(t)}function ro(r){const e={},t=[];for(const{url:n,ecdn:s,fallback:o}of r){const i=new URL(n),a=i.hostname,u=qt(i.pathname);if(a!=="localhost"&&a.indexOf(".")<0||/\.qnqcdn\.net$/.test(a))continue;let l=e[a];l==null&&(e[a]=l={exts:[],total:0,ecdn:0,fallback:0}),l.exts.includes(u)||l.exts.push(u),l.total++,s&&l.ecdn++,o&&l.fallback++,$t(i,Qe)&&!t.includes(a)&&t.push(a)}return e}function so(r,e){const t={};for(const{url:n,ecdn:s,size:o}of e){const i=new URL(n),a=i.hostname,u=qt(i.pathname);if(!(!r.includes(a)&&!r.includes("*")))for(const l of[`${a}/*`,`${a}/*.${u||"<none>"}`]){let h=t[l];h==null&&(t[l]=h={total:0,totalSize:0,ecdn:0,ecdnSize:0}),h.total++,h.totalSize+=o!=null?o:0,s&&(h.ecdn++,h.ecdnSize+=o!=null?o:0)}}return t}function oo(r,e,t){return v(this,null,function*(){return r=to(r,e),yield navigator.serviceWorker.register(r,t)})}function io(){return v(this,null,function*(){ao()})}function ao(){function r(e){var n;const t={mikuDeliveryProxy:!0,type:`window-${e}`};(n=navigator.serviceWorker.controller)==null||n.postMessage(t)}r("available"),window.addEventListener("pageshow",()=>r("available")),window.addEventListener("pagehide",()=>r("unavailable")),window.addEventListener("beforeunload",()=>r("unavailable"))}function lo(r,e){navigator.serviceWorker.addEventListener("message",({data:t})=>{if(!Xs(t)||t.type!=="window-fetch-items")return;const n=ro(t.items),s=Dn(r.domains),o=so([...s.cdn,...s.live],t.items);e(n,o)}),window.addEventListener("load",()=>{setTimeout(()=>{var n;const t={mikuDeliveryProxy:!0,type:"get-window-fetch-items"};(n=navigator.serviceWorker.controller)==null||n.postMessage(t)},1e3)})}function co(r,e,t){return v(this,null,function*(){const n=uo();if(n!=null){console.warn("Ability not OK for Miku Delivery Proxy API:",n);return}e.debug&&je(),e.anchorDownload&&kr()&&(console.warn("AnchorDownload Proxy is not supported in Mobile Browsers for compatibility reasons."),e=W(C({},e),{anchorDownload:!1}));function s(i){const a=[];if(e.anchorDownload){const{cdn:u}=Dn(e.domains),l=C(C({},Qe),e.patterns);a.push(ho(i.scope,u,l))}return a}const o=oo(r,e,t).then(i=>{var l,h;const a=(h=(l=i.installing)!=null?l:i.waiting)!=null?h:i.active;if(a==null)throw new Error("Service Worker not found");let u=[];a.state==="activated"&&(u=s(i)),a.onstatechange=()=>{a.state==="activated"&&(u=s(i)),a.state==="redundant"&&u.forEach(p=>p())}});yield Promise.all([io(),o,ss(),Kr()])})}function uo(){return"serviceWorker"in navigator?null:"navigator.serviceWorker not available"}function ho(r,e,t){const n=s=>{if(s.target==null||s.defaultPrevented)return;const o=fo(s.target);if(o==null||!o.hasAttribute("download"))return;const{href:i,download:a}=o,u=new URL(i);if(no(u,e)&&$t(u,t)){s.preventDefault();const l=document.createElement("iframe");l.src=Js(r,i,a),l.style.display="none",document.body.append(l),setTimeout(()=>{document.body.removeChild(l)},1e4)}};return document.body.addEventListener("click",n),()=>{document.body.removeEventListener("click",n)}}function fo(r){for(;r!=null&&r.tagName!=="BODY";){if(r.tagName==="A")return r;r=r.parentElement}return null}class kn extends Error{constructor(){super(...arguments);R(this,"name","MediaError")}}function we(r,e,t,n){return r.addEventListener(e,t,n),()=>r.removeEventListener(e,t)}function Et(r){return r.dataset.mikuId!=null?r.dataset.mikuId:r.dataset.mikuId=wo()}function wo(r=16){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",t=e.length;let n="";for(let s=0;s<r;s++)n+=e[Math.floor(Math.random()*t)];return n}const Ln="miku_load";function Mn(r,e){r.addEventListener(Ln,e,{once:!0})}function Pn(r){r.dispatchEvent(new Event(Ln))}function _t(r){if(r.error==null)return"";const{code:e,message:t}=r.error;return t?`Error ${e}; details: ${t}`:`Error ${e}`}class po{constructor(e){this.logger=e}log(e){return this.logger.log("MpResolveSrcLog",e)}}class mo{constructor(e){this.logger=e}log(e){return this.logger.log("MpApplyResolvedLog",e)}}function Bn(r,e){const t=new URL(r),n=t.host;t.protocol="https:",t.host=`${e.host}:${e.https}`,t.pathname=`/${n}${t.pathname}`;let s=t.toString();const o=s.includes("?")?"&":"?",i=["X-Miku-Agent",`miku-delivery-web/v${vt}`].map(encodeURIComponent).join("=");return s=s+o+i,s}function In(r,e,t,n,s){return v(this,null,function*(){var c;const o=Te(),i=new V,a=new po(e),u=new mo(e),l=Date.now();let h=null,p=-1;try{yield t.do(i,n,2,f=>v(this,null,function*(){p++;const d=Date.now(),w=i.get("downloadEltID");let g=null;try{yield s(f)}catch(x){throw g=x,x}finally{const x=Date.now();u.log(C({m_id:r,r_id:o,retry:p,elt_id:w!=null?w:"",t_total:O(x,d),err_msg:"",err_desc:""},g!=null&&ne(g)))}}))}catch(f){throw h=f,f}finally{const f=Date.now();a.log(C({id:o,m_id:r,ts_st:l,t_lookup:(c=i.get("dnsResolveTotalTime"))!=null?c:-1,t_total:O(f,l),err_msg:"",err_desc:""},h!=null&&ne(h)))}})}class On{constructor(e){this.logger=e}log(e,t,n="",s=""){const o={m_id:Et(e),m_type:e.tagName.toLowerCase(),m_url:e.src,type:t,err_msg:n,err_desc:s};this.logger.log("MpMediaEventLog",o)}}const Tt=tr();function go(r){return v(this,null,function*(){r.debug&&je();const{app:e,domains:t}=r,n=new Rn(e),s=new ln(n,e);Tt.resolve({domains:t,logger:n,resolver:s}),yield Promise.all(t.map(o=>s.resolveDomain(new V,o))).catch(o=>{console.warn("resolve domains failed:",o)})})}function Nn(r,e){if(!r||!/^https?:\/\//.test(r))return!1;const n=new URL(r).hostname;return e.includes(n)}function vo(r,e){if(r instanceof HTMLMediaElement)return zn(r,e);if(r instanceof HTMLImageElement)return bo(r,e);throw new Error("mikuDelivery.load() only works for video/audio/image elements")}function zn(r,e,t=!1){return v(this,null,function*(){r.dataset.src=e,Pn(r);const{resolver:n,domains:s,logger:o}=yield Tt.promise;if(!Nn(e,s)){r.src!==e&&(r.src=e,r.load());return}r.hasChildNodes()&&r.childNodes.forEach(d=>{d.nodeName.toLowerCase()==="source"&&r.removeChild(d)});const i=new On(o),a=[];Mn(r,()=>{a.forEach(d=>d())});let u=null,l=null,h=null;a.push(we(r,"error",d=>{u==null||u(d)})),a.push(we(r,"loadedmetadata",d=>{l==null||l(d)})),a.push(we(r,"loadstart",d=>{h==null||h(d)}));const p=r.currentTime,c=r.paused;function f(){r.currentTime=p,c||a.push(we(r,"canplay",()=>{r.play()},{once:!0}))}try{yield In(Et(r),o,n,e,d=>v(this,null,function*(){const w=Bn(e,d);r.src=w,t&&f();const g=new Promise((m,b)=>{l=()=>{i.log(r,"loadedmetadata"),m()},u=()=>{const y=_t(r)||"Load media metadata failed";i.log(r,"error","MediaError",y),b(new kn(y))}}),x=new Promise(m=>{h=()=>m()}).then(()=>Ae(8e3,"Load media metadata"));return r.load(),Promise.race([g,x]).then(()=>{h=null,l=null,u=()=>{const m=_t(r)||"Media error after metadata loaded";console.warn(`Media error with src (${w}):`,m),i.log(r,"error","MediaError",m),zn(r,e,!0)}})}))}catch(d){console.warn("media fallback for:",d),r.src=e,t&&f(),h=null,l=()=>i.log(r,"loadedmetadata"),u=()=>i.log(r,"error","MediaError",_t(r)),r.load()}})}function bo(r,e){return v(this,null,function*(){r.dataset.src=e,Pn(r);const{resolver:t,domains:n,logger:s}=yield Tt.promise;if(!Nn(e,n)){r.src=e;return}const o=new On(s),i=[];Mn(r,()=>{i.forEach(l=>l())});let a=null,u=null;i.push(we(r,"error",l=>{a==null||a(l)})),i.push(we(r,"load",l=>{u==null||u(l)}));try{yield In(Et(r),s,t,e,l=>v(this,null,function*(){const h=Bn(e,l),p=new Promise((c,f)=>{r.src=h,u=()=>{o.log(r,"load"),c()},a=()=>{o.log(r,"error","MediaError",""),f(new kn)}});return Promise.race([p,Ae(8e3,"Load image")])}))}catch(l){console.warn("image fallback for:",l),r.src=e,u=()=>o.log(r,"load"),a=()=>o.log(r,"error","MediaError","")}})}return A.Client=Qs,A.initMediaLoader=go,A.initProxy=co,A.listenStatistics=lo,A.loadMedia=vo,Object.defineProperties(A,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}}),A}({});
